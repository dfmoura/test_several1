<gadget>
  <prompt-parameters>
    <parameter id="P_PERIODO" description="Periodo" metadata="datePeriod" required="true" keep-last="true" keep-date="false" order="0"/>
    <parameter id="P_CODMETA" description="Cód. Meta" metadata="entity:ConfiguracaoMeta@CODMETA" required="true" keep-last="true" keep-date="false" order="1" label="P_CODMETA : Entidade/Tabela"/>
    <parameter id="P_CODPARC" description="Cliente" metadata="entity:Parceiro@CODPARC" required="false" keep-last="true" keep-date="false" order="2" label="P_CODPARC : Entidade/Tabela"/>
    <parameter id="VENDEDOR_MATRIZ" description="Vendedor Matriz" metadata="boolean" required="false" keep-last="true" keep-date="false" default="false" order="3"/>
    <parameter id="P_CODVEND" description="Vendedor" metadata="multiList:Text" listType="sql" required="false" keep-last="true" keep-date="false" order="4">
      <expression type="SQL"><![CDATA[
        
SELECT
MET.CODVEND AS VALUE
, MET.CODVEND  ||' - '|| VEN.APELIDO AS LABEL
FROM TGMMET MET
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
WHERE
(
	MET.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR MET.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR MET.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
GROUP BY
MET.CODVEND
, VEN.APELIDO
ORDER BY VEN.APELIDO
      
      ]]></expression>
    </parameter>
    <parameter id="P_COORD" description="Supervisor / Coordenador" metadata="multiList:Text" listType="sql" required="false" keep-last="true" keep-date="false" order="5">
      <expression type="SQL"><![CDATA[SELECT 
VALUE
,LABEL
FROM (
SELECT 
VEN.CODGER AS VALUE,
CASE WHEN VEN.CODGER = 0 THEN 'SEM VENDEDOR' ELSE VEN1.APELIDO END AS LABEL,
SUM(CASE WHEN VEN.CODVEND = VEN.CODGER THEN 0 ELSE 1 END) AS ORDEM
FROM TGFVEN VEN
INNER JOIN TGFVEN VEN1 ON VEN.CODGER = VEN1.CODVEND
WHERE 
(
	VEN1.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR VEN1.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR VEN1.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
GROUP BY VEN.CODGER, VEN1.APELIDO
) X
ORDER BY X.ORDEM DESC]]></expression>
    </parameter>
    <parameter id="P_GRUPOPROD" description="Grupo Produto" metadata="entity:GrupoProduto@CODGRUPOPROD" required="false" keep-last="true" keep-date="false" order="6"/>
    <parameter id="P_MARCA" description="Marca" metadata="multiList:Text" listType="sql" required="false" keep-last="true" keep-date="false" order="7">
      <expression type="SQL"><![CDATA[SELECT DISTINCT
TRIM(MARCA) AS VALUE,
TRIM(MARCA) AS LABEL
FROM(
SELECT
MARCA
FROM VGF_VENDAS_SATIS
GROUP BY 
MARCA
UNION ALL
SELECT 
MARCA
FROM TGFMET
GROUP BY 
MARCA
)
GROUP BY
MARCA
ORDER BY 1]]></expression>
    </parameter>
    <parameter id="P_NTEMMETA" description="Ignorar Ref. Sem Meta Prev./Real" metadata="boolean" required="false" keep-last="true" keep-date="false" default="false" order="8" label="P_NTEMMETA : Verdadeiro/Falso"/>
  </prompt-parameters>
  <level id="lvl_c3rh8k" description="Principal">
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="H" tamanhoRelativo="337">
        <container orientacao="V" tamanhoRelativo="1162">
          <simple-value id="svl_eadypt">
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(VLR_PREV) AS VLR_PREV,
SUM(VLR_REAL) AS VLR_REAL,
CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC,
CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(QTDPREV * PRECOLT) AS VLR_PREV,
SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(
SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)
WHERE 
CODMETA = :P_CODMETA
AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<> 0)) OR :P_NTEMMETA = 'N')
AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)

AND (MARCA IN :P_MARCA)

AND
(
	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
]]></expression>
            <metadata>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            </metadata>
            <value-expression><![CDATA[<center><table cellspacing="0"><tr><td height = 20 bgcolor = "#FFFFFF " colspan="7" ><span style='color: #000000 ; font-size: 18px;'><center><B>&nbspANALISE DA META&nbsp<br><span style='font-size: 14px;'>Período: :P_PERIODO.INI a :P_PERIODO.FIN</span></b></center></span></td></tr><tr bgcolor = "#E8F5E9"><td height = 20 bgcolor = "#FFFFFF " ><span style='color: #FFFFFF ;'><center>&nbsp&nbsp</center></span></td><td height = 20 bgcolor = "#4CAF50 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspQtd. Prev.&nbsp</b></center></span></td><td height = 20 bgcolor = "#FF9800 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspQtd. Real&nbsp</b></center></span></td><td height = 20 bgcolor = "#F44336 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbsp%&nbsp</b></center></span></td><td height = 20 bgcolor = "#4CAF50 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspVlr. Prev.&nbsp</b></center></span></td><td height = 20 bgcolor = "#FF9800 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspVlr. Real&nbsp</b></center></span></td><td height = 20 bgcolor = "#F44336 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbsp%&nbsp</b></center></span></td></tr><tr bgcolor = "#E8F5E9"><td height = 20 bgcolor = "#FFFFFF "><b>&nbspTotais&nbsp</b></td><td height = 20 bgcolor = "#E8F5E9 "><div style='text-align: right;'><center><b>&nbsp$QTDPREV&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFF3E0 "><div style='text-align: right;'><center><b>&nbsp$QTDREAL&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFEBEE "><div style='text-align: right;'><center><b>&nbsp$PERC&nbsp</b></center></div></td><td height = 20 bgcolor = "#E8F5E9 "><div style='text-align: right;'><center><b>&nbsp$VLR_PREV&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFF3E0 "><div style='text-align: right;'><center><b>&nbsp$VLR_REAL&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFEBEE "><div style='text-align: right;'><center><b>&nbsp$PERC_VLR&nbsp</b></center></div></td></table></center>]]></value-expression>
          </simple-value>
        </container>
        <container orientacao="V" tamanhoRelativo="100">
          <simple-value id="svl_rlk0e7">
            <value-expression><![CDATA[<div style='text-align: center;'><div style='text-align: center;'><b>Comparativo<br>Comercial</b></div><img src='https://e7.pngegg.com/pngimages/595/756/png-clipart-computer-icons-compare-icon-blue-angle-thumbnail.png' alt='Comparison Icon' style='width: 50px; height: 50px;'></div>]]></value-expression>
            <on-click-launcher resource-id="br.com.sankhya.menu.adicional.nuDsb.167.1"/>
          </simple-value>
        </container>
      </container>
      <container orientacao="H" tamanhoRelativo="355">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_dvthgf" type="gauge">
            <title><![CDATA[<b>Percentual de Atingimento da Meta de VOLUME</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC_ATINGIDO
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(QTDPREV * PRECOLT) AS VLR_PREV,
SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(
SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)
WHERE 
CODMETA = :P_CODMETA
AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<>0)) OR :P_NTEMMETA = 'N')
AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)
AND (MARCA IN :P_MARCA)

AND
(
	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)]]></expression>
            <metadata>
              <field name="PERC_ATINGIDO" label="% Atingido" type="F" visible="true" useFooter="false"/>
            </metadata>
            <show-ticks>true</show-ticks>
            <min-value>0</min-value>
            <max-value>100</max-value>
            <value-field>PERC_ATINGIDO</value-field>
            <alert-colors values="0,30,50,70,90,100" colors="0xff0000,0xff9900,0xffff,0xff,0xff00"/>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_dvthg2" type="gauge">
            <title><![CDATA[<b>Percentual de Atingimento da Meta de VALOR</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_ATINGIDO
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(QTDPREV * PRECOLT) AS VLR_PREV,
SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(
SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)
WHERE 
CODMETA = :P_CODMETA
AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<>0)) OR :P_NTEMMETA = 'N')
AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)
AND (MARCA IN :P_MARCA)

AND
(
	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)]]></expression>
            <metadata>
              <field name="PERC_ATINGIDO" label="% Atingido" type="F" visible="true" useFooter="false"/>
            </metadata>
            <show-ticks>true</show-ticks>
            <min-value>0</min-value>
            <max-value>100</max-value>
            <value-field>PERC_ATINGIDO</value-field>
            <alert-colors values="0,30,50,70,90,100" colors="0xff0000,0xff9900,0xffff,0xff,0xff00"/>
          </chart>
        </container>
      </container>
      <container orientacao="H" tamanhoRelativo="508">
        <container orientacao="H" tamanhoRelativo="100">
          <container orientacao="V" tamanhoRelativo="50">
            <chart id="cht_f1xjzp" type="column" nroColuna="10">
              <title><![CDATA[<b>TOP 10 Vendedores - Volume</b>]]></title>
              <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND
, APELIDO
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
    CODVEND,
    APELIDO
ORDER BY QTDREAL DESC, QTDPREV DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
              <metadata>
                <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
                <field name="APELIDO" label="APELIDO" type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC_VLR" label="Vendedor e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
                <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
                <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
                <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
                <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
                <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
                <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
              </metadata>
              <horizontal-axis>
                <category field="" rotation="-90" dropLabel="false">
                  <initView value="first"/>
                </category>
              </horizontal-axis>
              <series>
                <serie type="column">
                  <xField>APELIDO_PERC</xField>
                  <yField>QTDREAL</yField>
                  <color>0xff9800</color>
                </serie>
                <serie type="column">
                  <xField>APELIDO_PERC</xField>
                  <yField>QTDPREV</yField>
                  <color>0x4caf50</color>
                </serie>
              </series>
            </chart>
          </container>
          <container orientacao="V" tamanhoRelativo="50">
            <chart id="cht_f1xjzr" type="column" nroColuna="10">
              <title><![CDATA[<b>TOP 10 Vendedores - Valores</b>]]></title>
              <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND
, APELIDO
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
    CODVEND,
    APELIDO
ORDER BY VLR_REAL DESC,VLR_PREV DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
              <metadata>
                <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
                <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC_VLR" label="Vendedor e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
                <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
                <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
                <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false"/>
                <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
                <field name="PERC" label="% Valor" type="F" visible="true" useFooter="false"/>
                <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
              </metadata>
              <horizontal-axis>
                <category field="" rotation="-90" dropLabel="false">
                  <initView value="first"/>
                </category>
              </horizontal-axis>
              <series>
                <serie type="column">
                  <xField>APELIDO_PERC_VLR</xField>
                  <yField>VLR_PREV</yField>
                  <color>0x4caf50</color>
                </serie>
                <serie type="column">
                  <xField>APELIDO_PERC_VLR</xField>
                  <yField>VLR_REAL</yField>
                  <color>0xff9800</color>
                </serie>
              </series>
            </chart>
          </container>
        </container>
      </container>
      <container orientacao="H" tamanhoRelativo="126">
        <container orientacao="H" tamanhoRelativo="25">
          <simple-value id="svl_f1xj1w">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Vendedor</button></div>]]></value-expression>
            <on-click navigate-to="lvl_g2sil3"/>
          </simple-value>
        </container>
        <container orientacao="H" tamanhoRelativo="25">
          <simple-value id="svl_g2sils">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Cliente</button></div>]]></value-expression>
            <on-click navigate-to="lvl_f1xj5j"/>
          </simple-value>
        </container>
        <container orientacao="H" tamanhoRelativo="25">
          <simple-value id="svl_g8hnqe">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Marca</button></div>]]></value-expression>
            <on-click navigate-to="lvl_g8hnbl"/>
          </simple-value>
        </container>
        <container orientacao="V" tamanhoRelativo="25">
          <simple-value id="svl_v5w4vx">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Custo</button></div>]]></value-expression>
            <on-click navigate-to="lvl_v5w4xf"/>
          </simple-value>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g2sil3" description="Nivel1">
    <args>
      <arg id="A_CODVEND" type="integer" label="A_CODVEND : Número Inteiro"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="141">
        <grid id="grd_htp5r4" useNewGrid="S">
          <title><![CDATA[<b>Consolidado por Vendedor</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 
CODVEND
, APELIDO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
	(
	SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
	FROM(

		SELECT MET.CODMETA,
		MET.DTREF, 
		VEN.CODVEND,
		VEN.APELIDO,
		VEN.AD_VENDEDOR_MATRIZ,
		NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC,
		NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
		NVL(MET.MARCA,0) AS MARCA,
		NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
		NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
		NVL(MET.QTDPREV,0) AS QTDPREV, 
		SUM(NVL(VGF.QTD,0)) AS QTDREAL,
		NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
		SUM(NVL(VGF.VLR,0)) AS VLRREAL
		FROM TGFMET MET
		LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
		LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
		LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
		LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

		GROUP BY MET.CODMETA,MET.DTREF,
		VEN.CODVEND, VEN.APELIDO, VEN.AD_VENDEDOR_MATRIZ,
		NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

	) X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND) 
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)

	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD
)
GROUP BY CODVEND, APELIDO
ORDER BY 7 DESC]]></expression>
          <metadata>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd. Prev." type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd. Real" type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter lessEqualThan="40"><![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="70"><![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="90"><![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]></formatter>
              <formatter greaterThan="90"><![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]></formatter>
            </field>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter lessEqualThan="40"><![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagRed">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="70"><![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="90"><![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]></formatter>
              <formatter greaterThan="90"><![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]></formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_g8hnu8">
            <param id="A_CODVEND">$CODVEND</param>
            <param id="A_APELIDO">$APELIDO</param>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hni1" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Vendedores - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND
, APELIDO
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
CODVEND
, APELIDO
ORDER BY 6 DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC_VLR" label="APELIDO_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>APELIDO_PERC</xField>
                <yField>QTDPREV</yField>
                <color>0x4caf50</color>
                <on-click navigate-to="lvl_a6aky8"/>
              </serie>
              <serie type="column">
                <xField>APELIDO_PERC</xField>
                <yField>QTDREAL</yField>
                <color>0xff9800</color>
                <on-click navigate-to="lvl_a6aky8"/>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hni3" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Vendedores - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND
, APELIDO
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
CODVEND
, APELIDO
ORDER BY 6 DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC" label="APELIDO_PERC" type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC_VLR" label="Vendedor e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>APELIDO_PERC_VLR</xField>
                <yField>VLR_PREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>APELIDO_PERC_VLR</xField>
                <yField>VLR_REAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_f1xj5j" description="Nivel2">
    <args>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="146">
        <grid id="grd_g8hnak" multiplaSelecao="N" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Consolidado por Cliente]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 
CODPARC, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)

GROUP BY CODPARC, PARCEIRO
ORDER BY 7 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_g8hn8s">
            <param id="A_CODPARC">$CODPARC</param>
            <param id="A_CLIENTE">$PARCEIRO</param>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnjk" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODPARC
, PARCEIRO
, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS RAZAO_PERC
, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS RAZAO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
CODPARC , PARCEIRO
ORDER BY 6 DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC" label="Cliente e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC_VLR" label="RAZAO_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="% Volume" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>RAZAO_PERC</xField>
                <yField>QTDPREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>RAZAO_PERC</xField>
                <yField>QTDREAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnjm" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODPARC
, PARCEIRO
, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS RAZAO_PERC
, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS RAZAO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
CODPARC , PARCEIRO
ORDER BY 6 DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC" label="Cliente e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC_VLR" label="RAZAO_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>RAZAO_PERC_VLR</xField>
                <yField>VLR_PREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>RAZAO_PERC_VLR</xField>
                <yField>VLR_REAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hnbl" description="Nivel3">
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="187">
        <grid id="grd_g8hncu" useNewGrid="S">
          <title><![CDATA[Consolidado por Marca]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 
MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY MARCA
ORDER BY 6 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_g8hn8u">
            <param id="A_MARCA">$MARCA</param>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="109">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnj5" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Marcas - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
MARCA

, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS MARCA_PERC
, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS MARCA_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
MARCA

ORDER BY 5 DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC" label="Marca e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC_VLR" label="MARCA_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="% Volume" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>MARCA_PERC</xField>
                <yField>QTDPREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>MARCA_PERC</xField>
                <yField>QTDREAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnj7" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Marcas - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
MARCA

, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS MARCA_PERC
, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS MARCA_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
MARCA

ORDER BY 5 DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC" label="MARCA_PERC" type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC_VLR" label="Marca e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="Vlr. Prev" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>MARCA_PERC_VLR</xField>
                <yField>VLR_PREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>MARCA_PERC_VLR</xField>
                <yField>VLR_REAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hnu8" description="Nivel1_A">
    <args>
      <arg id="A_APELIDO" type="text" label="A_APELIDO : Texto"/>
      <arg id="A_CODVEND" type="integer" label="A_CODVEND : Número Inteiro"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="237">
        <container orientacao="V" tamanhoRelativo="100">
          <grid id="grd_g8hnva" useNewGrid="S">
            <args>
              <arg id="A_APELIDO" type="text"/>
              <arg id="A_CODVEND" type="integer"/>
            </args>
            <title><![CDATA[<b> :A_APELIDO - Meta por Vendedor << Cliente</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE CODVEND = :A_CODVEND
GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO
ORDER BY 8 DESC]]></expression>
            <metadata>
              <field name="CODVEND" label="Cód.Vend." type="I" visible="false" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="false" useFooter="false"/>
              <field name="CODPARC" label="Cód.Parc." type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
                </formatter>
              </field>
              <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
                </formatter>
              </field>
            </metadata>
            <on-click navigate-to="lvl_g8hn41">
              <param id="A_CODVEND">$CODVEND</param>
              <param id="A_CODPARC">$CODPARC</param>
              <param id="A_APELIDO">$APELIDO</param>
              <param id="A_PARCEIRO">$PARCEIRO</param>
            </on-click>
          </grid>
        </container>
      </container>
      <container orientacao="V" tamanhoRelativo="158">
        <container orientacao="H" tamanhoRelativo="100">
          <container orientacao="V" tamanhoRelativo="10">
            <simple-value id="svl_mrdy5u">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Consolidado Vendedor</button></div>]]></value-expression>
              <on-click navigate-to="lvl_g8hoge">
                <param id="A_CODVEND">:A_CODVEND</param>
                <param id="A_APELIDO">:A_APELIDO</param>
              </on-click>
            </simple-value>
          </container>
          <container orientacao="V" tamanhoRelativo="10">
            <simple-value id="svl_mrdy5w">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Auditoria Valores</button></div>]]></value-expression>
              <on-click navigate-to="lvl_g8hogf">
                <param id="A_CODVEND">:A_CODVEND</param>
              </on-click>
            </simple-value>
          </container>
        </container>
        <container orientacao="H" tamanhoRelativo="572">
          <chart id="cht_aj4ls5w" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
A.CODPARC
, A.PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, NULL AS RN

FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (A.CODVEND = :A_CODVEND)
GROUP BY
A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)
WHERE ROWNUM <= 3


UNION ALL

SELECT

9999 AS CODPARC
, 'OUTROS' AS PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM
(
SELECT * FROM
(SELECT
A.CODPARC
, A.PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (A.CODVEND = :A_CODVEND)
GROUP BY
A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="H" tamanhoRelativo="578">
          <chart id="cht_aj4ltd1" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
A.CODPARC
, A.PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, NULL AS RN

FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (A.CODVEND = :A_CODVEND)
GROUP BY
A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)
WHERE ROWNUM <= 3


UNION ALL

SELECT

9999 AS CODPARC
, 'OUTROS' AS PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM
(
SELECT * FROM
(SELECT
A.CODPARC
, A.PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (A.CODVEND = :A_CODVEND)
GROUP BY
A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn41" description="Nivel1_B">
    <args>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
      <arg id="A_PARCEIRO" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="156">
        <grid id="grd_g8hn43" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>:A_APELIDO - Meta por Vendedor << Cliente: :A_PARCEIRO << Marca</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODPARC, PARCEIRO, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
AND (CODVEND = :A_CODVEND)
GROUP BY CODPARC, PARCEIRO, MARCA
ORDER BY 7 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="false" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="false" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
          </metadata>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hn72" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
A.MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, NULL AS RN
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (CODPARC = :A_CODPARC)
AND (CODVEND = :A_CODVEND)
GROUP BY A.MARCA
ORDER BY 3 DESC
)
WHERE ROWNUM <= 3


UNION ALL

SELECT


'OUTROS' AS MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(
SELECT * FROM
(
SELECT
A.MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (A.CODPARC = :A_CODPARC)
AND (A.CODVEND = :A_CODVEND)
GROUP BY A.MARCA
ORDER BY 3 DESC
)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hn74" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores </b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
A.MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, NULL AS RN
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (CODPARC = :A_CODPARC)
AND (CODVEND = :A_CODVEND)
GROUP BY A.MARCA
ORDER BY 3 DESC
)
WHERE ROWNUM <= 3


UNION ALL

SELECT


'OUTROS' AS MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(
SELECT * FROM
(
SELECT
A.MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)A
WHERE (A.CODPARC = :A_CODPARC)
AND (A.CODVEND = :A_CODVEND)
GROUP BY A.MARCA
ORDER BY 3 DESC
)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8s" description="Nivel2_A">
    <args>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_CLIENTE" type="text"/>
      <arg id="A_APELIDO" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="170">
        <grid id="grd_g8ho4t" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>Vendedor -  Meta por Cliente - :A_CLIENTE >> Marca</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODPARC
, PARCEIRO
, CODVEND
, APELIDO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
GROUP BY CODPARC, PARCEIRO, CODVEND, APELIDO, MARCA
ORDER BY 10 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="false" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="false" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_g8hn8s">
            <param id="A_CODPARC"/>
            <param id="A_CLIENTE"/>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="H" tamanhoRelativo="171">
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy34">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Consolidado Cliente</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5ox1">
                <param id="A_CODPARC">:A_CODPARC</param>
                <param id="A_APELIDO">:A_APELIDO</param>
                <param id="A_PARCEIRO">:A_CLIENTE</param>
              </on-click>
            </simple-value>
          </container>
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy36">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Auditoria Valores</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5o1d">
                <param id="A_CODPARC">:A_CODPARC</param>
              </on-click>
            </simple-value>
          </container>
        </container>
        <container orientacao="H" tamanhoRelativo="531">
          <chart id="cht_mrdy32" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
CODPARC
, PARCEIRO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, NULL AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)
WHERE ROWNUM <= 3

UNION ALL


SELECT

9999 AS CODPARC
, 'OUTROS' AS PARCEIRO
, 'OUTROS' AS MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(

SELECT * FROM
(SELECT
CODPARC
, PARCEIRO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="H" tamanhoRelativo="586">
          <chart id="cht_mrdy30" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
CODPARC
, PARCEIRO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, NULL AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)
WHERE ROWNUM <= 3

UNION ALL


SELECT

9999 AS CODPARC
, 'OUTROS' AS PARCEIRO
, 'OUTROS' AS MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(

SELECT * FROM
(SELECT
CODPARC
, PARCEIRO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza">
                <field>VLR_REAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8t" description="Nivel2_B">
    <args>
      <arg id="A_MARCA" type="text"/>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="50">
        <grid id="grd_iyh30e" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>Meta por Cliente >> Marca >> Vendedor</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODPARC
, PARCEIRO
, MARCA
, CODVEND
, APELIDO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
	
)
GROUP BY 
CODPARC
, PARCEIRO
, MARCA
, CODVEND
, APELIDO
ORDER BY 8]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_g8hn8t">
            <param id="A_MARCA"/>
            <param id="A_CODPARC"/>
            <param id="A_CODVEND"/>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="50">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh36p" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Cliente >> Marca >> Vendedor - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
A.CODPARC
, RAZAOSOCIAL
, MARCA
, A.CODVEND
, APELIDO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(QTDPREV * PRECOLT)  AS VLR_PREV
, SUM(VLRREAL)  AS VLR_REAL
, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 0 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR
FROM
(
SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
WHERE MET.CODMETA = :P_CODMETA
AND MET.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')
AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)A
INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND
INNER JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC

WHERE 
A.CODPARC = :A_CODPARC
AND MARCA = :A_MARCA
AND (VEN.CODVEND IN :P_CODVEND)
/*AND (VEN.CODGER IN :P_CODGER)*/
/*AND (A.CODCENCUS = :P_CR OR :P_CR IS NULL)*/

GROUP BY 
A.CODPARC
, RAZAOSOCIAL
, MARCA
, A.CODVEND
, APELIDO
ORDER BY 8
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="RAZAOSOCIAL" label="Cliente" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="% Volume" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="column" show-tip="false">
                <xField>APELIDO</xField>
                <yField>PERC</yField>
                <display><![CDATA[Vendedor]]></display>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh36r" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Cliente >> Vendedor >> Marca - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
A.CODPARC
, RAZAOSOCIAL
, MARCA
, A.CODVEND
, APELIDO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(QTDPREV * PRECOLT)  AS VLR_PREV
, SUM(VLRREAL)  AS VLR_REAL
, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 0 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR
FROM
(
SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
WHERE MET.CODMETA = :P_CODMETA
AND MET.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')
AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)A
INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND
INNER JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC

WHERE 
A.CODPARC = :A_CODPARC
AND MARCA = :A_MARCA
AND (VEN.CODVEND IN :P_CODVEND)
/*AND (VEN.CODGER IN :P_CODGER)*/
/*AND (A.CODCENCUS = :P_CR OR :P_CR IS NULL)*/

GROUP BY 
A.CODPARC
, RAZAOSOCIAL
, MARCA
, A.CODVEND
, APELIDO
ORDER BY 11
FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="RAZAOSOCIAL" label="Cliente" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="column" show-tip="false">
                <xField>APELIDO</xField>
                <yField>PERC_VLR</yField>
                <display><![CDATA[Vendedor]]></display>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8u" description="Nivel3_A">
    <args>
      <arg id="A_MARCA" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="184">
        <grid id="grd_hn5n6c" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>:A_MARCA - Meta por Marca << Vendedor </b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
MARCA
, CODVEND
, APELIDO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(


SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
	
)
WHERE (MARCA = :A_MARCA)
GROUP BY 
MARCA
, CODVEND
, APELIDO
ORDER BY 8 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="Marca" type="S" visible="false" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_g8hn8v">
            <param id="A_MARCA">$MARCA</param>
            <param id="A_CODVEND">$CODVEND</param>
            <param id="A_CODPARC">$CODPARC</param>
            <param id="A_APELIDO">$APELIDO</param>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="H" tamanhoRelativo="343">
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy2e">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Consolidado Marca</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5o9h">
                <param id="A_MARCA">:A_MARCA</param>
              </on-click>
            </simple-value>
          </container>
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy2g">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Auditoria Valores</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5pc2">
                <param id="A_MARCA">:A_MARCA</param>
              </on-click>
            </simple-value>
          </container>
        </container>
        <container orientacao="H" tamanhoRelativo="1462">
          <chart id="cht_mrdy2c" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume </b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
CODVEND
, APELIDO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (MARCA = :A_MARCA)
GROUP BY CODVEND,APELIDO, MARCA)
WHERE RN <= 3

UNION ALL


SELECT

9999 AS CODVEND
, 'OUTROS' AS APELIDO
, 'OUTROS' AS MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(

SELECT * FROM
(SELECT
CODVEND
, APELIDO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (MARCA = :A_MARCA)
GROUP BY CODVEND,APELIDO, MARCA)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>APELIDO</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="H" tamanhoRelativo="1256">
          <chart id="cht_mrdy2a" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
CODVEND
, APELIDO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (MARCA = :A_MARCA)
GROUP BY CODVEND,APELIDO, MARCA)
WHERE RN <= 3

UNION ALL


SELECT

9999 AS CODVEND
, 'OUTROS' AS APELIDO
, 'OUTROS' AS MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(

SELECT * FROM
(SELECT
CODVEND
, APELIDO
, MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (MARCA = :A_MARCA)
GROUP BY CODVEND,APELIDO, MARCA)
WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>APELIDO</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8v" description="Nivel3_B">
    <args>
      <arg id="A_MARCA" type="text"/>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="184">
        <grid id="grd_iyh4x8" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>Meta por Marca: - :A_MARCA << Vendedor - :A_APELIDO << Cliente</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(


SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	/*AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD	

)
WHERE (CODVEND = :A_CODVEND)
AND (MARCA = :A_MARCA)
GROUP BY
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO
ORDER BY 2 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="Marca" type="S" visible="false" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="false" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="false" useFooter="false"/>
            <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_g8hn8v">
            <param id="A_MARCA"/>
            <param id="A_CODVEND"/>
            <param id="A_CODPARC"/>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh4ya" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume </b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(


SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	/*AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD

)
WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)
GROUP BY
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO)
WHERE RN <= 3

UNION ALL



SELECT

'OUTROS' AS MARCA
, 9999 AS CODVEND
, 'OUTROS' AS APELIDO
, 9999 AS CODPARC
, 'OUTROS' AS RAZAOSOCIAL
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(

SELECT * FROM
(SELECT
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)
GROUP BY
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO)
WHERE RN > 3)
ORDER BY 9 DESC]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh4yc" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM
(SELECT
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(


SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	/*AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD

)
WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)
GROUP BY
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO)
WHERE RN <= 3

UNION ALL



SELECT

'OUTROS' AS MARCA
, 9999 AS CODVEND
, 'OUTROS' AS APELIDO
, 9999 AS CODPARC
, 'OUTROS' AS RAZAOSOCIAL
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV) AS VLR_PREV
, SUM(VLR_REAL) AS VLR_REAL
, 4 AS RN
FROM

(

SELECT * FROM
(SELECT
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)
GROUP BY
MARCA
, CODVEND
, APELIDO
, CODPARC
, PARCEIRO)
WHERE RN > 3)
ORDER BY 9 DESC]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="CODPARC" label="CODPARC" type="F" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hoge" description="Nivel1_A1">
    <args>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_g8hoid" useNewGrid="S">
        <title><![CDATA[Vendedor - :A_APELIDO]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODVEND = :A_CODVEND)
GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA
ORDER BY "PERC_VLR" DESC]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="false" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="false" useFooter="false"/>
          <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
          <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
          <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_g8hogf" description="Nivel1_A2">
    <args>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="101">
        <grid id="grd_g8hot5" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria por Vendedor]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 
CODVEND
, APELIDO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODVEND = :A_CODVEND)
GROUP BY CODVEND, APELIDO
ORDER BY APELIDO ASC, "QTDREAL" DESC]]></expression>
          <metadata>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          </metadata>
          <refresh-details ui-list="grd_aklqjbd">
            <param id="A_CODVEND">$CODVEND</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="302">
        <grid id="grd_aklqjbd" useNewGrid="S">
          <args>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria do Realizado]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
NUNOTA,NUMNOTA,DTMOV,CODVEND,APELIDO,CODPARC,PARCEIRO,MARCA,CODPROD,DESCRPROD,QTD,VLR,TOP
FROM(
SELECT
X.CODMETA,X.DTREF,X.NUNOTA,X.NUMNOTA,X.DTMOV,X.CODVEND,X.APELIDO,X.CODPARC,X.PARCEIRO,X.MARCA,X.CODPROD,X.DESCRPROD,X.CODGRUPOPROD,X.QTD,X.VLR,X.TOP
FROM(	
SELECT
MET.CODMETA,MET.DTREF,VGF.NUNOTA,VGF.NUMNOTA,VGF.DTMOV,VGF.CODVEND,VEN.AD_VENDEDOR_MATRIZ,VEN.CODGER,VEN.APELIDO,VGF.CODPARC,PAR.RAZAOSOCIAL AS PARCEIRO,VGF.MARCA,VGF.CODPROD,VGF.DESCRPROD,VGF.CODGRUPOPROD,VGF.QTD,VGF.VLR,VGF.TOP
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTD <> 0 OR X.VLR<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	/*AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)

	AND(
	:A_CODVEND IS NULL 
	OR X.AD_VENDEDOR_MATRIZ = :A_CODVEND 
	OR X.CODVEND = :A_CODVEND
	)	
)


]]></expression>
          <metadata>
            <field name="NUNOTA" label="Nro Único" type="I" visible="true" useFooter="false"/>
            <field name="NUMNOTA" label="Nro Nota" type="I" visible="true" useFooter="false"/>
            <field name="DTMOV" label="Dt. Movimento" type="D" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CODPARC" label="Cód. Cliente" type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="CODPROD" label="Cód. Produto" type="I" visible="true" useFooter="false"/>
            <field name="DESCRPROD" label="Produto" type="S" visible="true" useFooter="false"/>
            <field name="QTD" label="Qtd." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR" label="Vlr." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="TOP" label="Top" type="S" visible="true" useFooter="false"/>
          </metadata>
          <on-click-launcher resource-id="br.com.sankhya.com.mov.CentralNotas">
            <NUNOTA>$NUNOTA</NUNOTA>
          </on-click-launcher>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_hn5ox1" description="Nivel2_A1">
    <args>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
      <arg id="A_PARCEIRO" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_hn5ox3" useNewGrid="S">
        <title><![CDATA[Vendedor >> Cliente - :A_PARCEIRO]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM

(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA
ORDER BY "PERC_VLR" DESC]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
          <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
          <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_hn5o1d" description="Nivel2_A2">
    <args>
      <arg id="A_CODPARC" type="integer"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="120">
        <grid id="grd_hn5o1f" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria por Cliente]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 
CODPARC
, PARCEIRO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
WHERE (CODPARC = :A_CODPARC)
GROUP BY
CODPARC
, PARCEIRO
ORDER BY 5 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC" label="%" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC_VLR" label="%" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          </metadata>
          <refresh-details ui-list="grd_hn5o1h">
            <param id="A_CODPARC">$CODPARC</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="363">
        <grid id="grd_hn5o1h" useNewGrid="S">
          <args>
            <arg id="A_CODPARC" type="integer"/>
          </args>
          <title><![CDATA[Auditoria do Realizado]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
NUNOTA,NUMNOTA,DTMOV,CODVEND,APELIDO,CODPARC,PARCEIRO,MARCA,CODPROD,DESCRPROD,QTD,VLR,TOP
FROM(
SELECT
X.CODMETA,X.DTREF,X.NUNOTA,X.NUMNOTA,X.DTMOV,X.CODVEND,X.APELIDO,X.CODPARC,X.PARCEIRO,X.MARCA,X.CODPROD,X.DESCRPROD,X.CODGRUPOPROD,X.QTD,X.VLR,X.TOP
FROM(	
SELECT
MET.CODMETA,MET.DTREF,VGF.NUNOTA,VGF.NUMNOTA,VGF.DTMOV,VGF.CODVEND,VEN.AD_VENDEDOR_MATRIZ,VEN.CODGER,VEN.APELIDO,VGF.CODPARC,PAR.RAZAOSOCIAL AS PARCEIRO,VGF.MARCA,VGF.CODPROD,VGF.DESCRPROD,VGF.CODGRUPOPROD,VGF.QTD,VGF.VLR,VGF.TOP
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTD <> 0 OR X.VLR<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
)
WHERE (CODPARC = :A_CODPARC)]]></expression>
          <metadata>
            <field name="NUNOTA" label="Nro Único" type="I" visible="true" useFooter="false"/>
            <field name="NUMNOTA" label="Nro Nota" type="I" visible="true" useFooter="false"/>
            <field name="DTMOV" label="Dt. Movimento" type="D" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CODPARC" label="Cód. Cliente" type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="CODPROD" label="Cód. Produto" type="I" visible="true" useFooter="false"/>
            <field name="DESCRPROD" label="Produto" type="S" visible="true" useFooter="false"/>
            <field name="QTD" label="Qtd." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR" label="Vlr." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="TOP" label="Top" type="S" visible="true" useFooter="false"/>
          </metadata>
          <on-click-launcher resource-id="br.com.sankhya.com.mov.CentralNotas">
            <NUNOTA>$NUNOTA</NUNOTA>
          </on-click-launcher>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_hn5o9h" description="Nivel3_A1">
    <args>
      <arg id="A_MARCA" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_hn5o9j" useNewGrid="S">
        <title><![CDATA[Marca - :A_MARCA]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM

(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(QTDPREV * PRECOLT) AS VLR_PREV,
SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(
SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)
WHERE 
CODMETA = :P_CODMETA
AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<>0)) OR :P_NTEMMETA = 'N')
AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)
AND (MARCA = :A_MARCA)

AND
(
	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)

GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA
ORDER BY 8 DESC]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
          <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
          <field name="MARCA" label="Marca" type="S" visible="false" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_hn5pc2" description="Nivel3_A2">
    <args>
      <arg id="A_MARCA" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="100">
        <grid id="grd_hn5pc4" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria por Marca]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 
MARCA
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(VLR_REAL)  AS VLR_REAL
, CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)

	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
WHERE (MARCA = :A_MARCA)
GROUP BY
MARCA
ORDER BY 5 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          </metadata>
          <refresh-details ui-list="grd_aklqhce">
            <param id="A_MARCA">$MARCA</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="234">
        <grid id="grd_aklqhce" useNewGrid="S">
          <args>
            <arg id="A_MARCA" type="text"/>
          </args>
          <title><![CDATA[Auditoria do Realizado]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
NUNOTA,NUMNOTA,DTMOV,CODVEND,APELIDO,CODPARC,PARCEIRO,MARCA,CODPROD,DESCRPROD,QTD,VLR,TOP
FROM(
SELECT
X.CODMETA,X.DTREF,X.NUNOTA,X.NUMNOTA,X.DTMOV,X.CODVEND,X.APELIDO,X.CODPARC,X.PARCEIRO,X.MARCA,X.CODPROD,X.DESCRPROD,X.CODGRUPOPROD,X.QTD,X.VLR,X.TOP
FROM(	
SELECT
MET.CODMETA,MET.DTREF,VGF.NUNOTA,VGF.NUMNOTA,VGF.DTMOV,VGF.CODVEND,VEN.AD_VENDEDOR_MATRIZ,VEN.CODGER,VEN.APELIDO,VGF.CODPARC,PAR.RAZAOSOCIAL AS PARCEIRO,VGF.MARCA,VGF.CODPROD,VGF.DESCRPROD,VGF.CODGRUPOPROD,VGF.QTD,VGF.VLR,VGF.TOP
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTD <> 0 OR X.VLR<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	/*AND (X.MARCA IN :P_MARCA)*/
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
)
WHERE (MARCA = :A_MARCA)]]></expression>
          <metadata>
            <field name="NUNOTA" label="Nro Único" type="I" visible="true" useFooter="false"/>
            <field name="NUMNOTA" label="Nro Nota" type="I" visible="true" useFooter="false"/>
            <field name="DTMOV" label="Dt. Movimento" type="D" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CODPARC" label="Cód. Cliente" type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="CODPROD" label="Cód. Produto" type="I" visible="true" useFooter="false"/>
            <field name="DESCRPROD" label="Produto" type="S" visible="true" useFooter="false"/>
            <field name="QTD" label="Qtd." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR" label="Vlr" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="TOP" label="TOP" type="S" visible="true" useFooter="false"/>
          </metadata>
          <on-click-launcher resource-id="br.com.sankhya.com.mov.CentralNotas">
            <NUNOTA>$NUNOTA</NUNOTA>
          </on-click-launcher>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_v5w4xf" description="Nivel4">
    <args>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="152">
        <grid id="grd_v5w40d" useNewGrid="S">
          <title><![CDATA[<b>Consolidado por Vendedor</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND,
APELIDO,
VLR_PREV,
VLRREAL,
PERC_VLR,
VLRDESP,
CASE WHEN VLRREAL = 0 THEN 0 ELSE VLRDESP / VLRREAL*-1*100 END AS PERC_VLRDESP_EM_REAL

FROM
(
WITH CUS4 AS

(
SELECT
AD_VENDEDOR_RESP,SUM(VLRDESP) AS VLRDESP
FROM
(
SELECT 
NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP
,CUS1.CODCENCUS
,CASE WHEN CUS1.GRAU=2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
ELSE CUS1.GRAU||'_'||CUS1.DESCRCENCUS END AS DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_DESP
,NVL(SUM(X.VLRDESDOB),0) AS VLRDESDOB
,NVL(SUM(X.VLRJURO),0) AS VLRJURO
,NVL(SUM(X.VLRMULTA),0) AS VLRMULTA
,NVL(SUM(X.VLRDESC),0) AS VLRDESC
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_DESP
,NVL(SUM(X.VLRBAIXA),0) AS VLRBAIXA
,NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRREC
,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRDESP
FROM TSICUS CUS1
LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS
INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT

WHERE

((
    (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
)
OR
( (
    X.RECDESP IN (1,0,-1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 2020202 
    AND X.NUNOTA IN (
        SELECT NUNOTA 
        FROM TGFCAB CAB
        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
        WHERE
            TOP.ATUALEST <> 'N'
            AND CAB.TIPMOV IN ('V','D')
            AND CAB.STATUSNOTA='L'
            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)
            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )
		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
  )
OR
    X.RECDESP IN (1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 1010000
    AND(X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)/* OR :PERIODO.FIN IS NULL)*/
))
AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)

/*
AND X.CODCENCUS IN :CR AND X.CODCENCUS <> 0 AND (X.RECDESP=:P_RECDESP OR :P_RECDESP = 0)
AND (X.CODCENCUS >= :P_CRINI OR :P_CRINI IS NULL)
AND (X.CODCENCUS < :P_CRFIN OR :P_CRFIN IS NULL)
AND (X.CODNAT <> :NATDIF OR :NATDIF IS NULL)
AND ( (X.CODNAT IN (SELECT CODNAT FROM TGFNAT WHERE AD_CUSTOFIXO = 'S') AND :P_CUSFIXO='S') OR :P_CUSFIXO='N' )
*/


GROUP BY
NVL(CUS1.AD_VENDEDOR_RESP,0)
,CUS1.CODCENCUS
,CUS1.DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
)

GROUP BY AD_VENDEDOR_RESP
)

SELECT 
A.CODVEND
, APELIDO
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(QTDPREV * PRECOLT)  AS VLR_PREV
, SUM(VLRREAL) AS VLRREAL
, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 100 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR
, NVL(CUS4.VLRDESP,0) AS VLRDESP
FROM
(
SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
WHERE MET.CODMETA = :P_CODMETA
AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')
AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)



)A
INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND
LEFT JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC
LEFT JOIN CUS4 ON A.CODVEND = CUS4.AD_VENDEDOR_RESP
WHERE
(VEN.CODVEND IN :P_CODVEND)
AND (VEN.CODGER IN :P_COORD)
AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
AND (A.MARCA IN :P_MARCA)

GROUP BY A.CODVEND, APELIDO,NVL(CUS4.VLRDESP,0)
)WHERE CODVEND <> 0 ORDER BY 2]]></expression>
          <metadata>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter greaterThan="0"><![CDATA[<span style="color:#0000FF">$VALUE</span>]]></formatter>
            </field>
            <field name="VLRREAL" label="Vlr. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter greaterThan="0"><![CDATA[<span style="color:#339900">$VALUE</span>]]></formatter>
            </field>
            <field name="PERC_VLR" label="% Real" type="F" visible="true" useFooter="AVG" mask="###0,0000">
              <formatter lessThan="80"><![CDATA[<span style="color:#FFFFFF; background-color:#FF0000">$VALUE</span>]]></formatter>
              <formatter between="80" and="99.99"><![CDATA[<span style="color:#000000; background-color:#FFFF00">$VALUE</span>]]></formatter>
              <formatter greaterEqualThan="100"><![CDATA[<span style="color:#FFFFFF; background-color:#009900">$VALUE</span>]]></formatter>
            </field>
            <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
            </field>
            <field name="PERC_VLRDESP_EM_REAL" label="% Custo" type="F" visible="true" useFooter="AVG" mask="###0,0000">
              <formatter lessThan="21"><![CDATA[<span style="color:#FFFFFF; background-color:#339900">$VALUE</span>]]></formatter>
              <formatter between="21" and="24.99"><![CDATA[<span style="color:#000000; background-color:#FFFF00">$VALUE</span>]]></formatter>
              <formatter greaterEqualThan="25"><![CDATA[<span style="color:#FFFFFF; background-color:#FF0000">$VALUE</span>]]></formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_xrixyq">
            <param id="A_CODVEND">$CODVEND</param>
            <param id="A_CODCENCUS">$CODVEND</param>
            <param id="A_VENDEDOR">$APELIDO</param>
          </on-click>
          <refresh-details ui-list="grd_xfjf27,cht_aizxkjx">
            <param id="A_CODVEND">$CODVEND</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="118">
        <container orientacao="V" tamanhoRelativo="50">
          <grid id="grd_xfjf27" useNewGrid="S">
            <args>
              <arg id="A_CODVEND" type="integer"/>
            </args>
            <title><![CDATA[<b>Detalhamento por Natureza</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND,
CODNAT,
DESCRNAT,
VLRDESP,
CASE WHEN VLRDESP = 0 OR VLRREAL = 0 THEN 0 ELSE ((VLRDESP/VLRREAL)*-1)*100 END AS PERC_NAT_NO_REAL

FROM
(
WITH CUS4 AS

(
SELECT
AD_VENDEDOR_RESP,CODNAT,DESCRNAT,SUM(VLRDESP) AS VLRDESP
FROM
(
SELECT 
NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP
,CUS1.CODCENCUS
,CASE WHEN CUS1.GRAU=2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
ELSE CUS1.GRAU||'_'||CUS1.DESCRCENCUS END AS DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_DESP
,NVL(SUM(X.VLRDESDOB),0) AS VLRDESDOB
,NVL(SUM(X.VLRJURO),0) AS VLRJURO
,NVL(SUM(X.VLRMULTA),0) AS VLRMULTA
,NVL(SUM(X.VLRDESC),0) AS VLRDESC
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_DESP
,NVL(SUM(X.VLRBAIXA),0) AS VLRBAIXA
,NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRREC
,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRDESP
FROM TSICUS CUS1
LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS
INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT

WHERE

((
        (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
)
OR
( (
    X.RECDESP IN (1,0,-1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 2020202
    AND X.NUNOTA IN (
        SELECT NUNOTA 
        FROM TGFCAB CAB
        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
        WHERE
            TOP.ATUALEST <> 'N'
            AND CAB.TIPMOV IN ('V','D')
            AND CAB.STATUSNOTA='L'
            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)
            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )
		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
  )
OR
    X.RECDESP IN (1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 1010000
    AND(X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
))
AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)

/*
AND X.CODCENCUS IN :CR AND X.CODCENCUS <> 0 AND (X.RECDESP=:P_RECDESP OR :P_RECDESP = 0)
AND (X.CODCENCUS >= :P_CRINI OR :P_CRINI IS NULL)
AND (X.CODCENCUS < :P_CRFIN OR :P_CRFIN IS NULL)
AND (X.CODNAT <> :NATDIF OR :NATDIF IS NULL)
AND ( (X.CODNAT IN (SELECT CODNAT FROM TGFNAT WHERE AD_CUSTOFIXO = 'S') AND :P_CUSFIXO='S') OR :P_CUSFIXO='N' )
*/


GROUP BY
NVL(CUS1.AD_VENDEDOR_RESP,0)
,CUS1.CODCENCUS
,CUS1.DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
)

GROUP BY AD_VENDEDOR_RESP,CODNAT,DESCRNAT
)

SELECT 
A.CODVEND
, APELIDO
, CUS4.CODNAT
, CUS4.DESCRNAT
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, SUM(QTDPREV * PRECOLT)  AS VLR_PREV
, SUM(VLRREAL) AS VLRREAL
, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 100 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR
, NVL(CUS4.VLRDESP,0) AS VLRDESP
FROM
(
SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
WHERE MET.CODMETA = :P_CODMETA
AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')
AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)



)A
INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND
INNER JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC
LEFT JOIN CUS4 ON A.CODVEND = CUS4.AD_VENDEDOR_RESP
WHERE
(VEN.CODVEND IN :P_CODVEND)
AND (VEN.CODGER IN :P_COORD)
AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
AND (A.MARCA IN :P_MARCA)


GROUP BY A.CODVEND, APELIDO,CUS4.CODNAT,CUS4.DESCRNAT,NVL(CUS4.VLRDESP,0)
)
WHERE 
CODVEND <> 0 
AND CODVEND = :A_CODVEND
AND CODNAT NOT IN (1020000,6010100)
GROUP BY CODVEND,CODNAT,DESCRNAT,VLRREAL,VLRDESP
ORDER BY 2]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="I" visible="false" useFooter="false"/>
              <field name="CODNAT" label="Cód. Nat." type="I" visible="true" useFooter="false"/>
              <field name="DESCRNAT" label="Natureza" type="S" visible="true" useFooter="false"/>
              <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
                <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
              </field>
              <field name="PERC_NAT_NO_REAL" label="% Custo" type="F" visible="true" useFooter="SUM" mask="###0,0000"/>
            </metadata>
          </grid>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_aizxkjx" type="line" nroColuna="6">
            <args>
              <arg id="A_CODVEND" type="integer"/>
            </args>
            <title><![CDATA[<b>Evolução Real x Custo</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[
SELECT
ANO,MES,DATA,CODVEND,APELIDO,SUM(VLR_REAL) AS VLR_REAL,SUM(VLRDESP) * -1 AS VLRDESP

FROM(
SELECT
TO_CHAR(DATA,'YYYY') AS ANO
, TO_CHAR(DATA,'MM') AS MES
, TO_CHAR(DATA,'MM-YYYY') AS DATA
, AD_VENDEDOR_RESP AS CODVEND
, APELIDO
, 0 AS VLR_REAL
, SUM(VLRDESP) AS VLRDESP

FROM
(
SELECT 
CASE WHEN X.DHBAIXA IS NULL THEN X.DTNEG ELSE X.DHBAIXA END AS DATA
,NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP
,NVL(VEN.APELIDO,0) AS APELIDO
,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRDESP
FROM TSICUS CUS1
LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS
INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT
INNER JOIN TGFVEN VEN ON CUS1.AD_VENDEDOR_RESP = VEN.CODVEND
WHERE
( (
    (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
)
OR
( (
    X.RECDESP IN (1,0,-1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 2020202 
    AND X.NUNOTA IN (
        SELECT NUNOTA 
        FROM TGFCAB CAB
        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
        WHERE
            TOP.ATUALEST <> 'N'
            AND CAB.TIPMOV IN ('V','D')
            AND CAB.STATUSNOTA='L'
            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)
            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )
		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
  )
OR
    X.RECDESP IN (1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 1010000
    AND(X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)/* OR :PERIODO.FIN IS NULL)*/
) )
AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)
GROUP BY
X.DTNEG
,X.DHBAIXA
,NVL(CUS1.AD_VENDEDOR_RESP,0)
,NVL(VEN.APELIDO,0)
)
WHERE 
AD_VENDEDOR_RESP = :A_CODVEND

GROUP BY
TO_CHAR(DATA,'YYYY')
, TO_CHAR(DATA,'MM')
, TO_CHAR(DATA,'MM-YYYY')
, AD_VENDEDOR_RESP
, APELIDO


UNION ALL


SELECT 
TO_CHAR(DTREF,'YYYY') AS ANO
, TO_CHAR(DTREF,'MM') AS MES
, TO_CHAR(DTREF,'MM-YYYY') AS DATA
, CODVEND
, APELIDO
, SUM(VLR_REAL) AS VLR_REAL
, 0 AS VLRDESP
FROM
(

SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(QTDPREV * PRECOLT) AS VLR_PREV,
SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(
SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)
WHERE 
CODMETA = :P_CODMETA
AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
AND (CODVEND = :A_CODVEND)

GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)

GROUP BY
CODVEND
, APELIDO
, TO_CHAR(DTREF,'YYYY')
, TO_CHAR(DTREF,'MM')
, TO_CHAR(DTREF,'MM-YYYY')
)

GROUP BY
ANO,MES,DATA,CODVEND,APELIDO

ORDER BY 1,2]]></expression>
            <metadata>
              <field name="ANO" label="ANO" type="S" visible="true" useFooter="false"/>
              <field name="MES" label="MES" type="S" visible="true" useFooter="false"/>
              <field name="DATA" label="Periodo" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="Cód.Vend." type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            </metadata>
            <horizontal-axis>
              <category field="CODVEND" rotation="0" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="line" circle-intersection="true">
                <xField>DATA</xField>
                <yField>VLR_REAL</yField>
                <display><![CDATA[Vlr. Real]]></display>
                <color>0x33cc00</color>
              </serie>
              <serie type="line" circle-intersection="true">
                <xField>DATA</xField>
                <yField>VLRDESP</yField>
                <display><![CDATA[Vlr. Custo]]></display>
                <color>0xff0000</color>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_xrixyq" description="Nivel4_A">
    <args>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_CODCENCUS" type="integer"/>
      <arg id="A_VENDEDOR" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="163">
        <grid id="grd_xrixyr" useNewGrid="S">
          <title><![CDATA[<b>Consolidado por CR</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[WITH CUST AS
(
SELECT
AD_VENDEDOR_RESP,
CODCENCUS,
SUM(VLRDESP) AS VLRDESP
FROM
(
SELECT 
NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP
,CUS1.CODCENCUS
,CASE WHEN CUS1.GRAU=2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
ELSE CUS1.GRAU||'_'||CUS1.DESCRCENCUS END AS DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_DESP
,NVL(SUM(X.VLRDESDOB),0) AS VLRDESDOB
,NVL(SUM(X.VLRJURO),0) AS VLRJURO
,NVL(SUM(X.VLRMULTA),0) AS VLRMULTA
,NVL(SUM(X.VLRDESC),0) AS VLRDESC
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_DESP
,NVL(SUM(X.VLRBAIXA),0) AS VLRBAIXA
,NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRREC
,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRDESP
FROM TSICUS CUS1
LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS
INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT

WHERE

((
    (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
)
OR
( (
    X.RECDESP IN (1,0,-1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 2020202
    AND X.NUNOTA IN (
        SELECT NUNOTA 
        FROM TGFCAB CAB
        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
        WHERE
            TOP.ATUALEST <> 'N'
            AND CAB.TIPMOV IN ('V','D')
            AND CAB.STATUSNOTA='L'
            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)
            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )
		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
  )
OR
    X.RECDESP IN (1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 1010000
    AND(X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
))
AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)

GROUP BY
NVL(CUS1.AD_VENDEDOR_RESP,0)
,CUS1.CODCENCUS
,CUS1.DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
)
GROUP BY AD_VENDEDOR_RESP,CODCENCUS
)


SELECT
C.CODCENCUS,C.DESCRCENCUS, SUM(C.VLRREAL) AS VLRREAL, CUST.VLRDESP, 
CASE WHEN SUM(C.VLRREAL) = 0 THEN 100 ELSE (CUST.VLRDESP*-1/SUM(C.VLRREAL))*100 END AS PERC
FROM
(
SELECT 
    S1.CODCENCUS,
    S1.DESCRCENCUS,
    NVL(S1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
    S2.DTREF,
    NVL(S2.CODVEND, 0) AS CODVEND,
    NVL(S2.APELIDO, 'NAO') AS APELIDO,
    NVL(S2.QTDPREV, 0) AS QTDPREV,
    NVL(S2.QTDREAL, 0) AS QTDREAL,
    NVL(S2.PRECOLT, 0) AS PRECOLT,
    NVL(S2.VLRREAL, 0) AS VLRREAL
FROM 
    (SELECT 
        CODCENCUS,
        DESCRCENCUS,
        NVL(AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP
    FROM 
        TSICUS 
    GROUP BY
        CODCENCUS,
        DESCRCENCUS,
        AD_VENDEDOR_RESP) S1
LEFT JOIN 
    (SELECT 
        MET.DTREF,
        MET.CODVEND,
        VGF.APELIDO,
        NVL(VGF.CODCENCUS, 0) AS CODCENCUS,
        NVL(VGF.DESCRCENCUS, '0') AS DESCRCENCUS,
        NVL(MET.QTDPREV, 0) AS QTDPREV,
        SUM(NVL(VGF.QTD, 0)) AS QTDREAL,
        NVL(PRC.VLRVENDALT, 0) AS PRECOLT,
        SUM(NVL(VGF.VLR, 0)) AS VLRREAL
    FROM TGFMET MET
    LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV, 'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
    LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
    WHERE  MET.CODMETA = 4 AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
    GROUP BY MET.DTREF, MET.CODVEND, VGF.APELIDO, NVL(VGF.CODCENCUS, 0), NVL(VGF.DESCRCENCUS, '0'), NVL(MET.QTDPREV, 0), NVL(PRC.VLRVENDALT, 0)) S2 
ON 
    S1.CODCENCUS = S2.CODCENCUS AND S1.DESCRCENCUS = S2.DESCRCENCUS AND S1.AD_VENDEDOR_RESP = S2.CODVEND

)C
LEFT JOIN CUST ON C.CODCENCUS = CUST.CODCENCUS
WHERE C.AD_VENDEDOR_RESP = :A_CODVEND
GROUP BY C.CODCENCUS, C.DESCRCENCUS,CUST.VLRDESP]]></expression>
          <metadata>
            <field name="CODCENCUS" label="Cód. CR" type="I" visible="true" useFooter="false"/>
            <field name="DESCRCENCUS" label="Descrição CR" type="S" visible="true" useFooter="false"/>
            <field name="VLRREAL" label="Vlr. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
            </field>
            <field name="PERC" label="% Custo" type="F" visible="true" useFooter="AVG" mask="###0,0000">
              <formatter lessThan="21"><![CDATA[<span style="color:#FFFFFF; background-color:#339900">$VALUE</span>]]></formatter>
              <formatter between="21" and="24.99"><![CDATA[<span style="color:#000000; background-color:#FFFF00">$VALUE</span>]]></formatter>
              <formatter greaterEqualThan="25"><![CDATA[<span style="color:#FFFFFF; background-color:#FF0000">$VALUE</span>]]></formatter>
            </field>
          </metadata>
          <refresh-details ui-list="grd_xrix7y">
            <param id="A_CODCENCUS">$CODCENCUS</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="110">
        <grid id="grd_xrix7y" useNewGrid="S">
          <args>
            <arg id="A_CODCENCUS" type="integer"/>
          </args>
          <title><![CDATA[<b>Detalhamento por Natureza</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODNAT,
DESCRNAT,

VLRDESP,

CASE WHEN VLRREAL = 0 THEN (CASE WHEN VLRDESP = 0 THEN 0 ELSE ((VLRDESP*-1)/VLRDESP_ACC)*100 END)
ELSE VLRDESP_ACC END AS PERC

FROM
(

WITH CUST AS
(
SELECT
AD_VENDEDOR_RESP,
CODCENCUS,
CODNAT,
DESCRNAT,
SUM(VLRDESP) AS VLRDESP
FROM
(
SELECT 
NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP
,CUS1.CODCENCUS
,CASE WHEN CUS1.GRAU=2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
WHEN CUS1.GRAU=5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
ELSE CUS1.GRAU||'_'||CUS1.DESCRCENCUS END AS DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_DESP
,NVL(SUM(X.VLRDESDOB),0) AS VLRDESDOB
,NVL(SUM(X.VLRJURO),0) AS VLRJURO
,NVL(SUM(X.VLRMULTA),0) AS VLRMULTA
,NVL(SUM(X.VLRDESC),0) AS VLRDESC
,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_REC
,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_DESP
,NVL(SUM(X.VLRBAIXA),0) AS VLRBAIXA
,NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRREC
,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 
		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
		ELSE 0 END),0) AS VLRDESP
FROM TSICUS CUS1
LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS
INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT

WHERE

( (
    (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
    OR
    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
)
OR
( (
    X.RECDESP IN (1,0,-1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 2020202
    AND X.NUNOTA IN (
        SELECT NUNOTA 
        FROM TGFCAB CAB
        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
        WHERE
            TOP.ATUALEST <> 'N'
            AND CAB.TIPMOV IN ('V','D')
            AND CAB.STATUSNOTA='L'
            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)
            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )
		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
  )
OR
    X.RECDESP IN (1)
    AND X.PROVISAO = 'N' 
    AND X.CODNAT <> 1010000
    AND(X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)/* OR :PERIODO.FIN IS NULL)*/
) )
AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)

GROUP BY
NVL(CUS1.AD_VENDEDOR_RESP,0)
,CUS1.CODCENCUS
,CUS1.DESCRCENCUS
,CUS1.GRAU
,CUS1.ANALITICO
,X.CODNAT
,X.DESCRNAT
)
GROUP BY AD_VENDEDOR_RESP,CODCENCUS,CODNAT,DESCRNAT
)


SELECT
C.CODCENCUS,C.DESCRCENCUS,CUST.CODNAT,CUST.DESCRNAT, SUM(C.VLRREAL) AS VLRREAL, CUST.VLRDESP, 

--CASE WHEN SUM(C.VLRREAL) = 0 THEN 100 ELSE (CUST.VLRDESP*-1/SUM(C.VLRREAL))*100 END AS PERC,


CASE WHEN SUM(C.VLRREAL) = 0 
THEN  (CASE WHEN CUST.VLRDESP = 0 THEN 0 ELSE SUM((CUST.VLRDESP*-1)) OVER (ORDER BY C.CODCENCUS) END)
ELSE (CUST.VLRDESP*-1/SUM(C.VLRREAL))*100 END AS VLRDESP_ACC

FROM
(
SELECT 
    S1.CODCENCUS,
    S1.DESCRCENCUS,
    NVL(S1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
    S2.DTREF,
    NVL(S2.CODVEND, 0) AS CODVEND,
    NVL(S2.APELIDO, 'NAO') AS APELIDO,
    NVL(S2.QTDPREV, 0) AS QTDPREV,
    NVL(S2.QTDREAL, 0) AS QTDREAL,
    NVL(S2.PRECOLT, 0) AS PRECOLT,
    NVL(S2.VLRREAL, 0) AS VLRREAL
FROM 
    (SELECT 
        CODCENCUS,
        DESCRCENCUS,
        NVL(AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP
    FROM 
        TSICUS 
    GROUP BY
        CODCENCUS,
        DESCRCENCUS,
        AD_VENDEDOR_RESP) S1
LEFT JOIN 
    (SELECT 
        MET.DTREF,
        MET.CODVEND,
        VGF.APELIDO,
        NVL(VGF.CODCENCUS, 0) AS CODCENCUS,
        NVL(VGF.DESCRCENCUS, '0') AS DESCRCENCUS,
        NVL(MET.QTDPREV, 0) AS QTDPREV,
        SUM(NVL(VGF.QTD, 0)) AS QTDREAL,
        NVL(PRC.VLRVENDALT, 0) AS PRECOLT,
        SUM(NVL(VGF.VLR, 0)) AS VLRREAL
    FROM TGFMET MET
    LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV, 'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
    LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
    WHERE  MET.CODMETA = 4 AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
    GROUP BY MET.DTREF, MET.CODVEND, VGF.APELIDO, NVL(VGF.CODCENCUS, 0), NVL(VGF.DESCRCENCUS, '0'), NVL(MET.QTDPREV, 0), NVL(PRC.VLRVENDALT, 0)) S2 
ON 
    S1.CODCENCUS = S2.CODCENCUS AND S1.DESCRCENCUS = S2.DESCRCENCUS AND S1.AD_VENDEDOR_RESP = S2.CODVEND

)C
LEFT JOIN CUST ON C.CODCENCUS = CUST.CODCENCUS
WHERE C.AD_VENDEDOR_RESP = :A_CODVEND AND C.CODCENCUS = :A_CODCENCUS 
GROUP BY C.CODCENCUS, C.DESCRCENCUS,CUST.CODNAT,CUST.DESCRNAT,CUST.VLRDESP
)
WHERE CODNAT NOT IN (1020000,6010100,6010200)]]></expression>
          <metadata>
            <field name="CODNAT" label="Cód. Nat." type="I" visible="true" useFooter="false"/>
            <field name="DESCRNAT" label="Natureza" type="S" visible="true" useFooter="false"/>
            <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
            </field>
            <field name="PERC" label="% Custo" type="F" visible="true" useFooter="SUM" mask="###0,0000">
              <formatter lessThan="21"><![CDATA[<span style="color:#FFFFFF; background-color:#339900">$VALUE</span>]]></formatter>
              <formatter between="21" and="24.99"><![CDATA[<span style="color:#000000; background-color:#FFFF00">$VALUE</span>]]></formatter>
              <formatter greaterEqualThan="25"><![CDATA[<span style="color:#FFFFFF; background-color:#FF0000">$VALUE</span>]]></formatter>
            </field>
          </metadata>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_ai7ew9s" description="TESTE">
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="50">
        <chart id="cht_ai7ew9t" type="column">
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND
, APELIDO
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
    CODVEND,
    APELIDO
ORDER BY QTDREAL DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
          <metadata>
            <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
            <field name="APELIDO" label="APELIDO" type="S" visible="true" useFooter="false"/>
            <field name="APELIDO_PERC" label="APELIDO_PERC" type="S" visible="true" useFooter="false"/>
            <field name="APELIDO_PERC_VLR" label="APELIDO_PERC_VLR" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
            <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
            <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
            <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
            <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
            <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
          </metadata>
          <series>
            <serie type="column">
              <xField>APELIDO_PERC</xField>
              <yField>QTDREAL</yField>
            </serie>
          </series>
        </chart>
      </container>
      <container orientacao="V" tamanhoRelativo="50">
        <grid id="grd_ai7exc2" useNewGrid="S">
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND
, APELIDO
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND)
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
    CODVEND,
    APELIDO
ORDER BY QTDREAL DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
          <metadata>
            <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
            <field name="APELIDO" label="APELIDO" type="S" visible="true" useFooter="false"/>
            <field name="APELIDO_PERC" label="APELIDO_PERC" type="S" visible="true" useFooter="false"/>
            <field name="APELIDO_PERC_VLR" label="APELIDO_PERC_VLR" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
            <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
            <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
            <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
            <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
            <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
          </metadata>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_a6aky8" description="Max_Graf1_Nivel_1">
    <container orientacao="V" tamanhoRelativo="100">
      <chart id="cht_a6ak2k" type="column" nroColuna="10">
        <title><![CDATA[<b>TOP 10 Vendedores - Volume</b>]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
CODVEND
, APELIDO
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC
, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR
, SUM(QTDPREV) AS QTDPREV
, SUM(QTDREAL) AS QTDREAL
, SUM(VLR_PREV)  AS VLR_PREV
, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC
, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
FROM
(
SELECT
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD,
SUM(QTDPREV) AS QTDPREV,
SUM(QTDREAL) AS QTDREAL,
SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
FROM(

SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL
FROM(	
SELECT
MET.CODMETA,
MET.DTREF, 
VEN.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 
NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
NVL(MET.MARCA,0) AS MARCA,
NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,
NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
NVL(MET.QTDPREV,0) AS QTDPREV, 
SUM(NVL(VGF.QTD,0)) AS QTDREAL,
NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
SUM(NVL(VGF.VLR,0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
)X
	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
	WHERE 
	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
/*	AND (X.CODVEND IN :P_CODVEND)*/
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD	
)
GROUP BY
DTREF,
CODMETA,
CODVEND,
APELIDO,
CODGER,
CODPARC,
PARCEIRO,
MARCA,
CODGRUPOPROD
)
GROUP BY
CODVEND
, APELIDO
ORDER BY 6 DESC
FETCH FIRST 10 ROWS ONLY]]></expression>
        <metadata>
          <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
          <field name="APELIDO_PERC_VLR" label="APELIDO_PERC_VLR" type="S" visible="true" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false"/>
        </metadata>
        <series>
          <serie type="undefined"/>
          <serie type="undefined"/>
        </series>
      </chart>
    </container>
  </level>
</gadget>