<gadget>
  <prompt-parameters>
    <parameter id="P_PERIODO" description="Periodo" metadata="datePeriod" required="false" keep-last="true" keep-date="false" order="1"/>
  </prompt-parameters>
  <level id="lvl_aj3y70r" description="Principal">
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="25"/>
      <container orientacao="V" tamanhoRelativo="25"/>
      <container orientacao="V" tamanhoRelativo="25"/>
      <container orientacao="H" tamanhoRelativo="25">
        <container orientacao="V" tamanhoRelativo="50">
          <simple-value id="svl_apxkdqx">
            <value-expression><![CDATA[<div style='text-align: center;'><button style="background-color: #4CAF50; color: white; padding: 10px;">Análise do Orçamento</button></div>]]></value-expression>
            <on-click navigate-to="lvl_apxkdqg"/>
          </simple-value>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <simple-value id="svl_apxkdrb">
            <value-expression><![CDATA[<div style='text-align: center;'><button style="background-color: #4CAF50; color: white; padding: 10px;">Comparação do Orçamento</button></div>]]></value-expression>
          </simple-value>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_apxkdqg" description="Nivel1">
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_apxkdqt" useNewGrid="S">
        <expression type="sql" data-source="MGEDS"><![CDATA[
        
        WITH B AS (SELECT LPAD(CODIGO, 10, '0') AS CODIGO1, DESCRICAO,GRAU FROM AD_ORCFIN)

SELECT
A.CODIGO1,
CASE
WHEN A.CODIGO1 LIKE '0499999999' THEN 'MARGEM DE CONTRIBUIÇÃO'
WHEN A.CODIGO1 LIKE '0599999999' THEN 'LUCRO OPERACIONAL ANTES DOS INVESTIMENTOS'
WHEN A.CODIGO1 LIKE '0699999998' THEN 'DESPESA OPERACIONAL TOTAL'
WHEN A.CODIGO1 LIKE '0699999999' THEN 'LUCRO OPERACIONAL'
WHEN A.CODIGO1 LIKE '0702999999' THEN 'RESULTADO LÍQUIDO'
WHEN A.CODIGO1 LIKE '0899999998' THEN 'DISTRIBUIÇÃO PARA SÓCIOS'
WHEN A.CODIGO1 LIKE '0899999999' THEN 'REINVESTIMENTO GRUPO SATIS'
ELSE B.DESCRICAO END AS DESCRICAO, 
B.GRAU,
A.PREV,A.REAL,
CASE 
WHEN B.GRAU = 1 THEN '#8EA9DB' 
WHEN B.GRAU = 2 THEN '#c6d4ed'
WHEN B.GRAU = 3 THEN '#dde5f4'
WHEN B.GRAU = 4 THEN '#e8f5cc'
WHEN B.GRAU = 5 THEN '#f0eaf5'
WHEN B.GRAU IS NULL THEN '#2e34db'
END AS BKCOLOR,

CASE 
WHEN B.GRAU IS NULL THEN '#fafafc'
END AS FGCOLOR
FROM

(

SELECT
GRAU,CODIGO1,
SUM(PREV) AS PREV,SUM(REAL) AS REAL

FROM
(
WITH BAS AS
(

/*RECUPERAR VALOR PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*RECUPERAR VALOR REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*RECUPERAR VALOR REAL DA DESPESA COM BASE NA TGFFIN = DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')


),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),

GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)

GROUP BY GRAU,CODIGO1

UNION ALL


SELECT
'TOTAL' AS GRAU, '0499999999' AS CODIGO1,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) + 
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) 
AS PREV,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) + 
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) 
AS REAL


FROM
(
WITH BAS AS
(


/*PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*REAL DA DESPESA TGFFIN DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')


),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV AS PREV,
REAL AS REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),




GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)



UNION ALL


SELECT
'TOTAL' AS GRAU, '0599999999' AS CODIGO1,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) + 
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) 
AS PREV,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) + 
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN REAL END)
AS REAL


FROM
(
WITH BAS AS
(



/*PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*REAL DA DESPESA TGFFIN DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')

),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV AS PREV,
REAL AS REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),




GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)



UNION ALL


SELECT
'TOTAL' AS GRAU, '0699999998' AS CODIGO1,
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) - 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) -
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) 
AS PREV,
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) - 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) -
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN REAL END)
AS REAL


FROM
(
WITH BAS AS
(



/*PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*REAL DA DESPESA TGFFIN DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')

),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV AS PREV,
REAL AS REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),

GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)



UNION ALL


SELECT
'TOTAL' AS GRAU, '0699999999' AS CODIGO1,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) + 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) 
AS PREV,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) + 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN REAL END)
AS REAL


FROM
(
WITH BAS AS
(



/*PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*REAL DA DESPESA TGFFIN DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')


),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV AS PREV,
REAL AS REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),

GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)



UNION ALL


SELECT
'TOTAL' AS GRAU, '0702999999' AS CODIGO1,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) + 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0700000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) 
AS PREV,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) + 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) + 
SUM(CASE WHEN CODIGO1 LIKE '0700000000' AND GRAU LIKE 'GRAU 1' THEN REAL END)
AS REAL


FROM
(
WITH BAS AS
(



/*PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*REAL DA DESPESA TGFFIN DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')


),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV AS PREV,
REAL AS REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),

GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)



UNION ALL




SELECT
'TOTAL' AS GRAU, '0899999998' AS CODIGO1,
SUM(CASE WHEN CODIGO1 LIKE '0800000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) AS PREV,
SUM(CASE WHEN CODIGO1 LIKE '0800000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) AS REAL
FROM
(
WITH BAS AS
(
/*PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*REAL DA DESPESA TGFFIN DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')


),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV AS PREV,
REAL AS REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),

GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)



UNION ALL


SELECT
'TOTAL' AS GRAU, '0899999999' AS CODIGO1,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) + 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0700000000' AND GRAU LIKE 'GRAU 1' THEN PREV END) +
SUM(CASE WHEN CODIGO1 LIKE '0800000000' AND GRAU LIKE 'GRAU 1' THEN PREV END)
AS PREV,
SUM(CASE WHEN CODIGO1 LIKE '0300000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0400000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) + 
SUM(CASE WHEN CODIGO1 LIKE '0500000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0600000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0700000000' AND GRAU LIKE 'GRAU 1' THEN REAL END) +
SUM(CASE WHEN CODIGO1 LIKE '0800000000' AND GRAU LIKE 'GRAU 1' THEN REAL END)
AS REAL
FROM
(
WITH BAS AS
(
/*PREVISTO BASEADO NA TGFMET*/
SELECT 
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
SUM(PREVREC + (PREVDESP*-1)) AS PREV,
0 AS REAL
FROM AD_ORCFIN ORC
INNER JOIN AD_ORCFINDET DET ON ORC.CODIGO = DET.CODIGO
INNER JOIN TGFMET MET ON DET.CODNAT = MET.CODNAT
WHERE CODMETA = 7 AND DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
ORC.CODIGO,
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY')

UNION ALL

/*REAL SOMENTE PARTE DO FATURAMENTO*/
SELECT
ORC.CODIGO,
TO_CHAR(DTNEG,'YYYY') AS ANO,
TO_CHAR(DTNEG,'MM') AS MES,
TO_CHAR(DTNEG,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(CASE WHEN CAB.TIPMOV='D' THEN (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED)*-1 ELSE (ITE.VLRTOT-ITE.VLRDESC-ITE.VLRREPRED) END) AS REAL
FROM TSIEMP EMP
INNER JOIN TGFCAB CAB ON (EMP.CODEMP = CAB.CODEMP)
INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
INNER JOIN TGFITE ITE ON (CAB.NUNOTA = ITE.NUNOTA)
INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)
---LEFT JOIN AD_ITENSGRUPOSATIS GRUS ON (GRUS.CODPROD=PRO.CODPROD AND $P{GRUPOSATIS} IS NOT NULL)
LEFT JOIN AD_ORCFINDET DET ON CAB.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE
(TOP.ATUALEST <> 'N' OR TOP.CODTIPOPER = 1112)
AND CAB.TIPMOV IN ('V','D')
AND CAB.STATUSNOTA='L'
AND (CAB.STATUSNFE = 'A' OR CAB.STATUSNFE = 'T' OR CAB.STATUSNFE IS NULL)
AND ORC.CODIGO IS NOT NULL
AND CAB.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
GROUP BY
TO_CHAR(DTNEG,'YYYY'),
TO_CHAR(DTNEG,'MM'),
TO_CHAR(DTNEG,'MM-YYYY'),
ORC.CODIGO

UNION ALL


/*REAL DA DESPESA TGFFIN DHBAIXA IS NOT NULL*/
SELECT
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY') AS ANO,
TO_CHAR(FIN.DHBAIXA,'MM') AS MES,
TO_CHAR(FIN.DHBAIXA,'MM-YYYY') AS MES_ANO,
0 AS PREV,
SUM(FIN.VLRBAIXA * FIN.RECDESP) AS REAL
FROM TGFFIN FIN
LEFT JOIN AD_ORCFINDET DET ON FIN.CODNAT = DET.CODNAT
LEFT JOIN AD_ORCFIN ORC ON DET.CODIGO = ORC.CODIGO
WHERE FIN.DHBAIXA IS NOT NULL
AND FIN.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ORC.CODIGO >= 400000000
GROUP BY
ORC.CODIGO,
TO_CHAR(FIN.DHBAIXA,'YYYY'),
TO_CHAR(FIN.DHBAIXA,'MM'),
TO_CHAR(FIN.DHBAIXA,'MM-YYYY')


),

GRAU1 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000' AS CODIGO1,
'GRAU 1' AS GRAU,
PREV AS PREV,
REAL AS REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 2)||'00000000',PREV,REAL),

GRAU2 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000' AS CODIGO1,
'GRAU 2' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 4)||'000000',PREV,REAL),

GRAU3 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000' AS CODIGO1,
'GRAU 3' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 6)||'0000',PREV,REAL),

GRAU4 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00' AS CODIGO1,
'GRAU 4' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO,MES,MES_ANO,SUBSTR(LPAD(CODIGO, 10, '0'), 1, 8)||'00',PREV,REAL),

GRAU5 AS (
SELECT
ANO,
MES,
MES_ANO,
SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10) AS CODIGO1,
'GRAU 5' AS GRAU,
PREV,
REAL
FROM BAS
GROUP BY
ANO, MES, MES_ANO, SUBSTR(LPAD(CODIGO, 10, '0'), 1, 10), PREV, REAL)

SELECT * FROM GRAU1

UNION ALL

SELECT * FROM GRAU2

UNION ALL

SELECT * FROM GRAU3

UNION ALL

SELECT * FROM GRAU4

UNION ALL

SELECT * FROM GRAU5

)



) A
LEFT JOIN B ON A.CODIGO1 = B.CODIGO1

GROUP BY
A.CODIGO1,B.DESCRICAO,B.GRAU, A.PREV,A.REAL
ORDER BY A.CODIGO1
]]></expression>
        <metadata>
          <field name="CODIGO1" label="Código" type="S" visible="true" useFooter="false"/>
          <field name="DESCRICAO" label="Descrição" type="S" visible="true" useFooter="false"/>
          <field name="GRAU" label="Grau" type="S" visible="true" useFooter="false"/>
          <field name="PREV" label="Previsto" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="REAL" label="Realizado" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="BKCOLOR" label="BKCOLOR" type="S" visible="true" useFooter="false"/>
          <field name="FGCOLOR" label="FGCOLOR" type="S" visible="true" useFooter="false"/>
        </metadata>
      </grid>
    </container>
  </level>
</gadget>
