<gadget>
  <prompt-parameters>
    <parameter id="P_PERIODO" description="Periodo" metadata="datePeriod" required="true" keep-last="true" keep-date="false" order="0"/>
    <parameter id="P_DTENTSAI" description="Data Despesas" metadata="singleList:Text" listType="text" required="true" keep-last="true" keep-date="false" order="1">
      <item value="1" label="Data de Baixa"/>
      <item value="2" label="Data de Entrada"/>
    </parameter>
    <parameter id="P_CODMETA" description="Cód. Meta" metadata="entity:ConfiguracaoMeta@CODMETA" required="true" keep-last="true" keep-date="false" order="2" label="P_CODMETA : Entidade/Tabela"/>
    <parameter id="P_CODPARC" description="Cliente" metadata="entity:Parceiro@CODPARC" required="false" keep-last="true" keep-date="false" order="3" label="P_CODPARC : Entidade/Tabela"/>
    <parameter id="VENDEDOR_MATRIZ" description="Vendedor Matriz" metadata="boolean" required="false" keep-last="true" keep-date="false" default="false" order="4"/>
    <parameter id="P_CODVEND" description="Vendedor" metadata="multiList:Text" listType="sql" required="false" keep-last="true" keep-date="false" order="5">
      <expression type="SQL"><![CDATA[

        

SELECT

MET.CODVEND AS VALUE

, MET.CODVEND  ||' - '|| VEN.APELIDO AS LABEL

FROM TGMMET MET

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

WHERE

(

	MET.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR MET.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR MET.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

GROUP BY

MET.CODVEND

, VEN.APELIDO

ORDER BY VEN.APELIDO

      

      ]]></expression>
    </parameter>
    <parameter id="P_COORD" description="Supervisor / Coordenador" metadata="multiList:Text" listType="sql" required="false" keep-last="true" keep-date="false" order="6">
      <expression type="SQL"><![CDATA[SELECT 

VALUE

,LABEL

FROM (

SELECT 

VEN.CODGER AS VALUE,

CASE WHEN VEN.CODGER = 0 THEN 'SEM VENDEDOR' ELSE VEN1.APELIDO END AS LABEL,

SUM(CASE WHEN VEN.CODVEND = VEN.CODGER THEN 0 ELSE 1 END) AS ORDEM

FROM TGFVEN VEN

INNER JOIN TGFVEN VEN1 ON VEN.CODGER = VEN1.CODVEND

WHERE 

(

	VEN1.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR VEN1.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR VEN1.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

GROUP BY VEN.CODGER, VEN1.APELIDO

) X

ORDER BY X.ORDEM DESC]]></expression>
    </parameter>
    <parameter id="P_GRUPOPROD" description="Grupo Produto" metadata="entity:GrupoProduto@CODGRUPOPROD" required="false" keep-last="true" keep-date="false" order="7"/>
    <parameter id="P_MARCA" description="Marca" metadata="multiList:Text" listType="sql" required="false" keep-last="true" keep-date="false" order="8">
      <expression type="SQL"><![CDATA[SELECT DISTINCT
TRIM(MARCA) AS VALUE,
TRIM(MARCA) AS LABEL
FROM(
SELECT
MARCA
FROM TGFPRO
WHERE MARCA IS NOT NULL
GROUP BY 
MARCA
)
GROUP BY
MARCA
ORDER BY 1]]></expression>
    </parameter>
    <parameter id="P_NTEMMETA" description="Ignorar Ref. Sem Meta Prev./Real" metadata="boolean" required="false" keep-last="true" keep-date="false" default="false" order="9" label="P_NTEMMETA : Verdadeiro/Falso"/>
    <parameter id="P_NATUREZA" description="Natureza" metadata="multiList:Text" listType="sql" required="false" keep-last="true" keep-date="false" order="10">
      <expression type="SQL"><![CDATA[SELECT
  CODNAT AS VALUE,
  CODNAT || '-' || DESCRNAT AS LABEL
FROM TGFNAT
]]></expression>
    </parameter>
    <parameter id="P_DADOS_FIN" description="Filtro de Dados Financeiros" metadata="boolean" required="false" keep-last="true" keep-date="false" default="false" order="11"/>
  </prompt-parameters>
  <level id="lvl_c3rh8k" description="Principal">
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="H" tamanhoRelativo="425">
        <container orientacao="V" tamanhoRelativo="1162">
          <simple-value id="svl_eadypt">
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(VLR_PREV) AS VLR_PREV,

SUM(VLR_REAL) AS VLR_REAL,

CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC,

CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR



FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(QTDPREV * PRECOLT) AS VLR_PREV,

SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(

SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND



GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)

WHERE 

CODMETA = :P_CODMETA

AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<> 0)) OR :P_NTEMMETA = 'N')

AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)



AND (MARCA IN :P_MARCA)



AND

(

	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

]]></expression>
            <metadata>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            </metadata>
            <value-expression><![CDATA[<center><table cellspacing="0"><tr><td height = 20 bgcolor = "#FFFFFF " colspan="7" ><span style='color: #000000 ; font-size: 18px;'><center><B>&nbspANALISE DA META&nbsp<br><span style='font-size: 14px;'>Período: :P_PERIODO.INI a :P_PERIODO.FIN</span></b></center></span></td></tr><tr bgcolor = "#E8F5E9"><td height = 20 bgcolor = "#FFFFFF " ><span style='color: #FFFFFF ;'><center>&nbsp&nbsp</center></span></td><td height = 20 bgcolor = "#4CAF50 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspQtd. Prev.&nbsp</b></center></span></td><td height = 20 bgcolor = "#FF9800 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspQtd. Real&nbsp</b></center></span></td><td height = 20 bgcolor = "#F44336 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbsp%&nbsp</b></center></span></td><td height = 20 bgcolor = "#4CAF50 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspVlr. Prev.&nbsp</b></center></span></td><td height = 20 bgcolor = "#FF9800 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbspVlr. Real&nbsp</b></center></span></td><td height = 20 bgcolor = "#F44336 " width = 180><span style='color: #FFFFFF ;'><center><b>&nbsp%&nbsp</b></center></span></td></tr><tr bgcolor = "#E8F5E9"><td height = 20 bgcolor = "#FFFFFF "><b>&nbspTotais&nbsp</b></td><td height = 20 bgcolor = "#E8F5E9 "><div style='text-align: right;'><center><b>&nbsp$QTDPREV&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFF3E0 "><div style='text-align: right;'><center><b>&nbsp$QTDREAL&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFEBEE "><div style='text-align: right;'><center><b>&nbsp$PERC&nbsp</b></center></div></td><td height = 20 bgcolor = "#E8F5E9 "><div style='text-align: right;'><center><b>&nbsp$VLR_PREV&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFF3E0 "><div style='text-align: right;'><center><b>&nbsp$VLR_REAL&nbsp</b></center></div></td><td height = 20 bgcolor = "#FFEBEE "><div style='text-align: right;'><center><b>&nbsp$PERC_VLR&nbsp</b></center></div></td></table></center>]]></value-expression>
          </simple-value>
        </container>
        <container orientacao="V" tamanhoRelativo="100">
          <simple-value id="svl_rlk0e7">
            <value-expression><![CDATA[<div style='text-align: center;'><div style='text-align: center;'><b>Comparativo<br>Comercial</b></div><img src='https://e7.pngegg.com/pngimages/595/756/png-clipart-computer-icons-compare-icon-blue-angle-thumbnail.png' alt='Comparison Icon' style='width: 50px; height: 50px;'></div>]]></value-expression>
            <on-click-launcher resource-id="br.com.sankhya.menu.adicional.nuDsb.167.1"/>
          </simple-value>
        </container>
      </container>
      <container orientacao="H" tamanhoRelativo="448">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_dvthgf" type="gauge">
            <title><![CDATA[<b>Percentual de Atingimento da Meta de VOLUME</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC_ATINGIDO

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(QTDPREV * PRECOLT) AS VLR_PREV,

SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(

SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)



)

WHERE 

CODMETA = :P_CODMETA

AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<>0)) OR :P_NTEMMETA = 'N')

AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)

AND (MARCA IN :P_MARCA)



AND

(

	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)]]></expression>
            <metadata>
              <field name="PERC_ATINGIDO" label="% Atingido" type="F" visible="true" useFooter="false"/>
            </metadata>
            <show-ticks>true</show-ticks>
            <min-value>0</min-value>
            <max-value>100</max-value>
            <value-field>PERC_ATINGIDO</value-field>
            <alert-colors values="0,30,50,70,90,100" colors="0xff0000,0xff9900,0xffff,0xff,0xff00"/>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_dvthg2" type="gauge">
            <title><![CDATA[<b>Percentual de Atingimento da Meta de VALOR</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_ATINGIDO

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(QTDPREV * PRECOLT) AS VLR_PREV,

SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(

SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)



)

WHERE 

CODMETA = :P_CODMETA

AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<>0)) OR :P_NTEMMETA = 'N')

AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)

AND (MARCA IN :P_MARCA)



AND

(

	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)]]></expression>
            <metadata>
              <field name="PERC_ATINGIDO" label="% Atingido" type="F" visible="true" useFooter="false"/>
            </metadata>
            <show-ticks>true</show-ticks>
            <min-value>0</min-value>
            <max-value>100</max-value>
            <value-field>PERC_ATINGIDO</value-field>
            <alert-colors values="0,30,50,70,90,100" colors="0xff0000,0xff9900,0xffff,0xff,0xff00"/>
          </chart>
        </container>
      </container>
      <container orientacao="H" tamanhoRelativo="582">
        <container orientacao="H" tamanhoRelativo="100">
          <container orientacao="V" tamanhoRelativo="50">
            <chart id="cht_f1xjzp" type="column" nroColuna="10">
              <title><![CDATA[<b>TOP 10 Vendedores - Volume</b>]]></title>
              <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND

, APELIDO

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

    CODVEND,

    APELIDO

ORDER BY QTDREAL DESC, QTDPREV DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
              <metadata>
                <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
                <field name="APELIDO" label="APELIDO" type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC_VLR" label="Vendedor e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
                <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
                <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
                <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
                <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
                <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
                <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
              </metadata>
              <horizontal-axis>
                <category field="" rotation="-90" dropLabel="false">
                  <initView value="first"/>
                </category>
              </horizontal-axis>
              <series>
                <serie type="column">
                  <xField>APELIDO_PERC</xField>
                  <yField>QTDREAL</yField>
                  <color>0xff9800</color>
                </serie>
                <serie type="column">
                  <xField>APELIDO_PERC</xField>
                  <yField>QTDPREV</yField>
                  <color>0x4caf50</color>
                </serie>
              </series>
            </chart>
          </container>
          <container orientacao="V" tamanhoRelativo="50">
            <chart id="cht_f1xjzr" type="column" nroColuna="10">
              <title><![CDATA[<b>TOP 10 Vendedores - Valores</b>]]></title>
              <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND

, APELIDO

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

    CODVEND,

    APELIDO

ORDER BY VLR_REAL DESC,VLR_PREV DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
              <metadata>
                <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
                <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
                <field name="APELIDO_PERC_VLR" label="Vendedor e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
                <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
                <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
                <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false"/>
                <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
                <field name="PERC" label="% Valor" type="F" visible="true" useFooter="false"/>
                <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
              </metadata>
              <horizontal-axis>
                <category field="" rotation="-90" dropLabel="false">
                  <initView value="first"/>
                </category>
              </horizontal-axis>
              <series>
                <serie type="column">
                  <xField>APELIDO_PERC_VLR</xField>
                  <yField>VLR_PREV</yField>
                  <color>0x4caf50</color>
                </serie>
                <serie type="column">
                  <xField>APELIDO_PERC_VLR</xField>
                  <yField>VLR_REAL</yField>
                  <color>0xff9800</color>
                </serie>
              </series>
            </chart>
          </container>
        </container>
      </container>
      <container orientacao="H" tamanhoRelativo="212">
        <container orientacao="H" tamanhoRelativo="20">
          <simple-value id="svl_f1xj1w">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Vendedor</button></div>]]></value-expression>
            <on-click navigate-to="lvl_g2sil3"/>
          </simple-value>
        </container>
        <container orientacao="H" tamanhoRelativo="20">
          <simple-value id="svl_g2sils">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Cliente</button></div>]]></value-expression>
            <on-click navigate-to="lvl_f1xj5j"/>
          </simple-value>
        </container>
        <container orientacao="H" tamanhoRelativo="20">
          <simple-value id="svl_g8hnqe">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Marca</button></div>]]></value-expression>
            <on-click navigate-to="lvl_g8hnbl"/>
          </simple-value>
        </container>
        <container orientacao="V" tamanhoRelativo="20">
          <simple-value id="svl_v5w4vx">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Custo</button></div>]]></value-expression>
            <on-click navigate-to="lvl_v5w4xf"/>
          </simple-value>
        </container>
        <container orientacao="V" tamanhoRelativo="20">
          <simple-value id="svl_axj9hg6">
            <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px;'>Análise Geral</button></div>]]></value-expression>
            <on-click navigate-to="lvl_axj9hi0"/>
          </simple-value>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g2sil3" description="Nivel1">
    <args>
      <arg id="A_CODVEND" type="integer" label="A_CODVEND : Número Inteiro"/>
      <arg id="A_APELIDO" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="148">
        <grid id="grd_htp5r4" entityName="MetaAtual" multiplaSelecao="N" useNewGrid="S">
          <title><![CDATA[<b>Consolidado por Vendedor</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 

CODVEND

, APELIDO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO


FROM

	(

	SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

	FROM(



		SELECT MET.CODMETA,

		MET.DTREF, 

		VEN.CODVEND,

		VEN.APELIDO,

		VEN.AD_VENDEDOR_MATRIZ,

		NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC,

		NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

		NVL(MET.MARCA,0) AS MARCA,

		NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

		NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

		NVL(MET.QTDPREV,0) AS QTDPREV, 

		SUM(NVL(VGF.QTD,0)) AS QTDREAL,

		NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

		SUM(NVL(VGF.VLR,0)) AS VLRREAL

		FROM TGFMET MET

		LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

		LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

		LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

		LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND



		GROUP BY MET.CODMETA,MET.DTREF,

		VEN.CODVEND, VEN.APELIDO, VEN.AD_VENDEDOR_MATRIZ,

		NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)



	) X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND



	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN



	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND) 

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)



	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD

)

GROUP BY CODVEND, APELIDO

ORDER BY 7 DESC]]></expression>
          <metadata>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter lessEqualThan="40"><![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="70"><![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="90"><![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]></formatter>
              <formatter greaterThan="90"><![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]></formatter>
            </field>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter lessEqualThan="40"><![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagRed">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="70"><![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]></formatter>
              <formatter lessEqualThan="90"><![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]></formatter>
              <formatter greaterThan="90"><![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]></formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
          <on-click navigate-to="lvl_g8hnu8">
            <param id="A_APELIDO">$APELIDO</param>
            <param id="A_CODVEND">$CODVEND</param>
          </on-click>
          <refresh-details ui-list="svl_axj9gzc,svl_axj9gzd">
            <param id="A_CODVEND">$CODVEND</param>
            <param id="A_APELIDO">$APELIDO</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="103">
        <container orientacao="H" tamanhoRelativo="100">
          <container orientacao="V" tamanhoRelativo="33">
            <simple-value id="svl_axj9gzc">
              <args>
                <arg id="A_CODVEND" type="integer"/>
                <arg id="A_APELIDO" type="text"/>
              </args>
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Consolidado Vendedor</button></div>]]></value-expression>
              <on-click navigate-to="lvl_g8hoge">
                <param id="A_CODVEND">:A_CODVEND</param>
                <param id="A_APELIDO">:A_APELIDO</param>
              </on-click>
            </simple-value>
          </container>
          <container orientacao="V" tamanhoRelativo="33">
            <simple-value id="svl_axj9gzd">
              <args>
                <arg id="A_CODVEND" type="integer"/>
                <arg id="A_APELIDO" type="text"/>
              </args>
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Auditoria Valores</button></div>]]></value-expression>
              <on-click navigate-to="lvl_g8hogf">
                <param id="A_CODVEND">:A_CODVEND</param>
              </on-click>
            </simple-value>
          </container>
          <container orientacao="V" tamanhoRelativo="33">
            <simple-value id="svl_1r1vtz">
              <args>
                <arg id="A_CODVEND" type="integer"/>
                <arg id="A_APELIDO" type="text"/>
              </args>
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Vendedor por UF</button></div>]]></value-expression>
              <on-click navigate-to="lvl_1r1vr3"/>
            </simple-value>
          </container>
        </container>
        <container orientacao="V" tamanhoRelativo="489">
          <chart id="cht_g8hni1" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Vendedores - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND

, APELIDO

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

CODVEND

, APELIDO

ORDER BY 6 DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC_VLR" label="APELIDO_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>APELIDO_PERC</xField>
                <yField>QTDPREV</yField>
                <color>0x4caf50</color>
                <on-click navigate-to="lvl_a6aky8"/>
              </serie>
              <serie type="column">
                <xField>APELIDO_PERC</xField>
                <yField>QTDREAL</yField>
                <color>0xff9800</color>
                <on-click navigate-to="lvl_a6aky8"/>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="291">
          <chart id="cht_g8hni3" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Vendedores - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND

, APELIDO

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

CODVEND

, APELIDO

ORDER BY 6 DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC" label="APELIDO_PERC" type="S" visible="true" useFooter="false"/>
              <field name="APELIDO_PERC_VLR" label="Vendedor e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>APELIDO_PERC_VLR</xField>
                <yField>VLR_PREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>APELIDO_PERC_VLR</xField>
                <yField>VLR_REAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_f1xj5j" description="Nivel2">
    <args>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="146">
        <grid id="grd_g8hnak" multiplaSelecao="N" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Consolidado por Cliente]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 

CODPARC, PARCEIRO, NOMECID,UF

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,
NOMECID,
UF,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL,
    NOMECID,
    UF

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL,
CID.NOMECID,
EST.UF

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
LEFT JOIN TSICID CID ON PAR.CODCID = CID.CODCID
LEFT JOIN TSIUFS EST ON CID.UF = EST.CODUF

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
,CID.NOMECID,EST.UF
)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,
    NOMECID,
   UF

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,
NOMECID,
UF,
CODGRUPOPROD

)



GROUP BY CODPARC, PARCEIRO, NOMECID,UF

ORDER BY 7 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="NOMECID" label="Cidade" type="S" visible="true" useFooter="false"/>
            <field name="UF" label="UF" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
          <on-click navigate-to="lvl_g8hn8s">
            <param id="A_CODPARC">$CODPARC</param>
            <param id="A_CLIENTE">$PARCEIRO</param>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnjk" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODPARC

, PARCEIRO

, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS RAZAO_PERC

, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS RAZAO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

CODPARC , PARCEIRO

ORDER BY 6 DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC" label="Cliente e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC_VLR" label="RAZAO_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="% Volume" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>RAZAO_PERC</xField>
                <yField>QTDPREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>RAZAO_PERC</xField>
                <yField>QTDREAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnjm" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODPARC

, PARCEIRO

, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS RAZAO_PERC

, SUBSTR(PARCEIRO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS RAZAO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

CODPARC , PARCEIRO

ORDER BY 6 DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC" label="Cliente e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="RAZAO_PERC_VLR" label="RAZAO_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>RAZAO_PERC_VLR</xField>
                <yField>VLR_PREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>RAZAO_PERC_VLR</xField>
                <yField>VLR_REAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hnbl" description="Nivel3">
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="187">
        <grid id="grd_g8hncu" useNewGrid="S">
          <title><![CDATA[Consolidado por Marca]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 

MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY MARCA

ORDER BY 6 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
          <on-click navigate-to="lvl_g8hn8u">
            <param id="A_MARCA">$MARCA</param>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="109">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnj5" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Marcas - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

MARCA



, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS MARCA_PERC

, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS MARCA_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

MARCA



ORDER BY 5 DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC" label="Marca e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC_VLR" label="MARCA_PERC_VLR" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="% Volume" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>MARCA_PERC</xField>
                <yField>QTDPREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>MARCA_PERC</xField>
                <yField>QTDREAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hnj7" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Marcas - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

MARCA



, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS MARCA_PERC

, MARCA ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS MARCA_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

MARCA



ORDER BY 5 DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC" label="MARCA_PERC" type="S" visible="true" useFooter="false"/>
              <field name="MARCA_PERC_VLR" label="Marca e % Atingido Meta Vlr." type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="Vlr. Prev" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <horizontal-axis>
              <category field="" rotation="-90" dropLabel="false">
                <initView value="first"/>
              </category>
            </horizontal-axis>
            <series>
              <serie type="column">
                <xField>MARCA_PERC_VLR</xField>
                <yField>VLR_PREV</yField>
                <color>0x4caf50</color>
              </serie>
              <serie type="column">
                <xField>MARCA_PERC_VLR</xField>
                <yField>VLR_REAL</yField>
                <color>0xff9800</color>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hnu8" description="Nivel1_A">
    <args>
      <arg id="A_APELIDO" type="text" label="A_APELIDO : Texto"/>
      <arg id="A_CODVEND" type="integer" label="A_CODVEND : Número Inteiro"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="237">
        <container orientacao="V" tamanhoRelativo="100">
          <grid id="grd_g8hnva" useNewGrid="S">
            <args>
              <arg id="A_APELIDO" type="text"/>
              <arg id="A_CODVEND" type="integer"/>
            </args>
            <title><![CDATA[<b> :A_APELIDO - Meta por Vendedor << Cliente</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE CODVEND = :A_CODVEND

GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO

ORDER BY 8 DESC]]></expression>
            <metadata>
              <field name="CODVEND" label="Cód.Vend." type="I" visible="false" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="false" useFooter="false"/>
              <field name="CODPARC" label="Cód.Parc." type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
                </formatter>
              </field>
              <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
              <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
                </formatter>
                <formatter formula="true">
                  <formula><![CDATA[]]></formula>
                  <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
                </formatter>
              </field>
              <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
              <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
              <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            </metadata>
            <on-click navigate-to="lvl_g8hn41">
              <param id="A_CODVEND">$CODVEND</param>
              <param id="A_CODPARC">$CODPARC</param>
              <param id="A_APELIDO">$APELIDO</param>
              <param id="A_PARCEIRO">$PARCEIRO</param>
            </on-click>
          </grid>
        </container>
      </container>
      <container orientacao="V" tamanhoRelativo="158">
        <container orientacao="H" tamanhoRelativo="4940">
          <chart id="cht_aj4ls5w" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

A.CODPARC

, A.PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, NULL AS RN



FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (A.CODVEND = :A_CODVEND)

GROUP BY

A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)

WHERE ROWNUM <= 3





UNION ALL



SELECT



9999 AS CODPARC

, 'OUTROS' AS PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM

(

SELECT * FROM

(SELECT

A.CODPARC

, A.PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (A.CODVEND = :A_CODVEND)

GROUP BY

A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="H" tamanhoRelativo="5940">
          <chart id="cht_aj4ltd1" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

A.CODPARC

, A.PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, NULL AS RN



FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (A.CODVEND = :A_CODVEND)

GROUP BY

A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)

WHERE ROWNUM <= 3





UNION ALL



SELECT



9999 AS CODPARC

, 'OUTROS' AS PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM

(

SELECT * FROM

(SELECT

A.CODPARC

, A.PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (A.CODVEND = :A_CODVEND)

GROUP BY

A.CODPARC, A.PARCEIRO ORDER BY 4 DESC)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn41" description="Nivel1_B">
    <args>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
      <arg id="A_PARCEIRO" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="156">
        <grid id="grd_g8hn43" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>:A_APELIDO - Meta por Vendedor << Cliente: :A_PARCEIRO << Marca</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODPARC, PARCEIRO, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO


FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

AND (CODVEND = :A_CODVEND)

GROUP BY CODPARC, PARCEIRO, MARCA

ORDER BY 7 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="false" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="false" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticke Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. %. Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hn72" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

A.MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, NULL AS RN

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (CODPARC = :A_CODPARC)

AND (CODVEND = :A_CODVEND)

GROUP BY A.MARCA

ORDER BY 3 DESC

)

WHERE ROWNUM <= 3





UNION ALL



SELECT





'OUTROS' AS MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(

SELECT * FROM

(

SELECT

A.MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (A.CODPARC = :A_CODPARC)

AND (A.CODVEND = :A_CODVEND)

GROUP BY A.MARCA

ORDER BY 3 DESC

)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_g8hn74" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores </b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

A.MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, NULL AS RN

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (CODPARC = :A_CODPARC)

AND (CODVEND = :A_CODVEND)

GROUP BY A.MARCA

ORDER BY 3 DESC

)

WHERE ROWNUM <= 3





UNION ALL



SELECT





'OUTROS' AS MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(

SELECT * FROM

(

SELECT

A.MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)A

WHERE (A.CODPARC = :A_CODPARC)

AND (A.CODVEND = :A_CODVEND)

GROUP BY A.MARCA

ORDER BY 3 DESC

)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8s" description="Nivel2_A">
    <args>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_CLIENTE" type="text"/>
      <arg id="A_APELIDO" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="170">
        <grid id="grd_g8ho4t" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>Vendedor -  Meta por Cliente - :A_CLIENTE >> Marca</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODPARC

, PARCEIRO

, CODVEND

, APELIDO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

GROUP BY CODPARC, PARCEIRO, CODVEND, APELIDO, MARCA

ORDER BY 10 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="false" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="false" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
          <on-click navigate-to="lvl_g8hn8s">
            <param id="A_CODPARC"/>
            <param id="A_CLIENTE"/>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="H" tamanhoRelativo="171">
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy34">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Consolidado Cliente</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5ox1">
                <param id="A_CODPARC">:A_CODPARC</param>
                <param id="A_APELIDO">:A_APELIDO</param>
                <param id="A_PARCEIRO">:A_CLIENTE</param>
              </on-click>
            </simple-value>
          </container>
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy36">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Auditoria Valores</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5o1d">
                <param id="A_CODPARC">:A_CODPARC</param>
              </on-click>
            </simple-value>
          </container>
        </container>
        <container orientacao="H" tamanhoRelativo="531">
          <chart id="cht_mrdy32" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

CODPARC

, PARCEIRO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, NULL AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)

WHERE ROWNUM <= 3



UNION ALL





SELECT



9999 AS CODPARC

, 'OUTROS' AS PARCEIRO

, 'OUTROS' AS MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(



SELECT * FROM

(SELECT

CODPARC

, PARCEIRO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="H" tamanhoRelativo="586">
          <chart id="cht_mrdy30" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

CODPARC

, PARCEIRO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, NULL AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)

WHERE ROWNUM <= 3



UNION ALL





SELECT



9999 AS CODPARC

, 'OUTROS' AS PARCEIRO

, 'OUTROS' AS MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(



SELECT * FROM

(SELECT

CODPARC

, PARCEIRO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

GROUP BY CODPARC,PARCEIRO, MARCA ORDER BY 5 DESC)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza">
                <field>VLR_REAL</field>
                <nameField>MARCA</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8t" description="Nivel2_B">
    <args>
      <arg id="A_MARCA" type="text"/>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="50">
        <grid id="grd_iyh30e" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>Meta por Cliente >> Marca >> Vendedor</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
  CODPARC,
  PARCEIRO,
  MARCA,
  CODVEND,
  APELIDO,
  CIDADE,
  UF,
  SUM(QTDPREV) AS QTDPREV,
  SUM(QTDREAL) AS QTDREAL,
  SUM(VLR_PREV) AS VLR_PREV,
  SUM(VLR_REAL) AS VLR_REAL,
  CASE 
    WHEN SUM(QTDPREV) = 0 THEN 0 
    ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) 
  END AS PERC,
  CASE 
    WHEN SUM(VLR_PREV) = 0 THEN 0 
    ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) 
  END AS PERC_VLR,
  NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO,
  NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META,
  CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO

FROM (
  SELECT
    DTREF,
    CODMETA,
    CODVEND,
    APELIDO,
    CODGER,
    CODPARC,
    PARCEIRO,
    MARCA,
    CODGRUPOPROD,
    CIDADE,
    UF,
    SUM(QTDPREV) AS QTDPREV,
    SUM(QTDREAL) AS QTDREAL,
    SUM(NVL(VLR_PREV,0)) AS VLR_PREV,
    SUM(NVL(VLR_REAL, 0)) AS VLR_REAL
  FROM (
    SELECT
      X.DTREF,
      X.CODMETA,
      VEN1.CODVEND,
      VEN1.APELIDO,
      VEN1.CODGER,
      X.CODPARC,
      X.PARCEIRO,
      X.MARCA,
      X.CODGRUPOPROD,
      X.CIDADE,
      X.UF,
      SUM(QTDPREV) AS QTDPREV,
      SUM(QTDREAL) AS QTDREAL,
      SUM(QTDPREV * PRECOLT) AS VLR_PREV,
      SUM(NVL(VLRREAL, 0)) AS VLR_REAL
    FROM (
      SELECT
        MET.CODMETA,
        MET.DTREF, 
        VEN.CODVEND,
        VEN.APELIDO,
        VEN.AD_VENDEDOR_MATRIZ,
        NVL(VEN.CODGER,0) AS CODGER,
        NVL(MET.CODPARC,0) AS CODPARC, 
        NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
        NVL(MET.MARCA,0) AS MARCA,
        NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,
        NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
        NVL(MET.QTDPREV,0) AS QTDPREV, 
        SUM(NVL(VGF.QTD,0)) AS QTDREAL,
        NVL(PRC.VLRVENDALT,0) AS PRECOLT, 
        SUM(NVL(VGF.VLR,0)) AS VLRREAL,
        CID.NOMECID AS CIDADE,
        EST.UF AS UF
      FROM TGFMET MET
      LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') 
        AND MET.CODVEND = VGF.CODVEND 
        AND MET.CODPARC = VGF.CODPARC 
        AND MET.MARCA = VGF.MARCA 
        AND VGF.BONIFICACAO = 'N'
      LEFT JOIN AD_PRECOMARCA PRC ON MET.MARCA = PRC.MARCA 
        AND PRC.CODMETA = MET.CODMETA 
        AND PRC.DTREF = (
          SELECT MAX(DTREF) 
          FROM AD_PRECOMARCA 
          WHERE CODMETA = MET.CODMETA 
            AND DTREF <= MET.DTREF 
            AND MARCA = MET.MARCA
        )
      LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
      LEFT JOIN TSICID CID ON PAR.CODCID = CID.CODCID
      LEFT JOIN TSIUFS EST ON CID.UF = EST.CODUF
      LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
      GROUP BY MET.CODMETA, MET.DTREF, VEN.CODVEND, VEN.APELIDO, VEN.AD_VENDEDOR_MATRIZ,
               NVL(VEN.CODGER,0), NVL(MET.CODPARC,0), NVL(PAR.RAZAOSOCIAL,0), NVL(MET.MARCA,0),
               NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)), NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), 
               NVL(PRC.VLRVENDALT,0), CID.NOMECID, EST.UF
    ) X
    LEFT JOIN TGFVEN VEN1 ON 
      CASE 
        WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ, X.CODVEND) 
        ELSE X.CODVEND 
      END = VEN1.CODVEND
    WHERE 
      X.CODMETA = :P_CODMETA
      AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
      AND (
        (:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <> 0 OR X.VLRREAL <> 0)) 
        OR :P_NTEMMETA = 'N'
      )
      AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
      AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
      AND (X.CODVEND IN :P_CODVEND)
      AND (X.CODGER IN :P_COORD)
      AND (X.MARCA IN :P_MARCA)
      AND (
        X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
        OR X.CODVEND IN (
          SELECT VEN.CODVEND 
          FROM TGFVEN VEN, TSIUSU USU 
          WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO
        )
        OR X.CODVEND IN (
          SELECT VEN.CODVEND 
          FROM TGFVEN VEN, TSIUSU USU 
          WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO
        )
        OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
      )
    GROUP BY
      X.DTREF,
      X.CODMETA,
      VEN1.CODVEND,
      VEN1.APELIDO,
      VEN1.CODGER,
      X.CODPARC,
      X.PARCEIRO,
      X.MARCA,
      X.CODGRUPOPROD,
      X.CIDADE,
      X.UF
  )
  GROUP BY
    DTREF,
    CODMETA,
    CODVEND,
    APELIDO,
    CODGER,
    CODPARC,
    PARCEIRO,
    MARCA,
    CODGRUPOPROD,
    CIDADE,
    UF
)
GROUP BY 
  CODPARC,
  PARCEIRO,
  MARCA,
  CODVEND,
  APELIDO,
  CIDADE,
  UF
ORDER BY 8
]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód.Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CIDADE" label="CIDADE" type="S" visible="true" useFooter="false"/>
            <field name="UF" label="UF" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
          <on-click navigate-to="lvl_g8hn8t">
            <param id="A_MARCA"/>
            <param id="A_CODPARC"/>
            <param id="A_CODVEND"/>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="50">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh36p" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Cliente >> Marca >> Vendedor - Volume</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

A.CODPARC

, RAZAOSOCIAL

, MARCA

, A.CODVEND

, APELIDO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(QTDPREV * PRECOLT)  AS VLR_PREV

, SUM(VLRREAL)  AS VLR_REAL

, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 0 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR

FROM

(

SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

WHERE MET.CODMETA = :P_CODMETA

AND MET.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')

AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)A

INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND

INNER JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC



WHERE 

A.CODPARC = :A_CODPARC

AND MARCA = :A_MARCA

AND (VEN.CODVEND IN :P_CODVEND)

/*AND (VEN.CODGER IN :P_CODGER)*/

/*AND (A.CODCENCUS = :P_CR OR :P_CR IS NULL)*/



GROUP BY 

A.CODPARC

, RAZAOSOCIAL

, MARCA

, A.CODVEND

, APELIDO

ORDER BY 8

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="RAZAOSOCIAL" label="Cliente" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="% Volume" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="column" show-tip="false">
                <xField>APELIDO</xField>
                <yField>PERC</yField>
                <display><![CDATA[Vendedor]]></display>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh36r" type="column" nroColuna="10">
            <title><![CDATA[<b>TOP 10 Cliente >> Vendedor >> Marca - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

A.CODPARC

, RAZAOSOCIAL

, MARCA

, A.CODVEND

, APELIDO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(QTDPREV * PRECOLT)  AS VLR_PREV

, SUM(VLRREAL)  AS VLR_REAL

, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 0 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR

FROM

(

SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

WHERE MET.CODMETA = :P_CODMETA

AND MET.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')

AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)A

INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND

INNER JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC



WHERE 

A.CODPARC = :A_CODPARC

AND MARCA = :A_MARCA

AND (VEN.CODVEND IN :P_CODVEND)

/*AND (VEN.CODGER IN :P_CODGER)*/

/*AND (A.CODCENCUS = :P_CR OR :P_CR IS NULL)*/



GROUP BY 

A.CODPARC

, RAZAOSOCIAL

, MARCA

, A.CODVEND

, APELIDO

ORDER BY 11

FETCH FIRST 10 ROWS ONLY]]></expression>
            <metadata>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="RAZAOSOCIAL" label="Cliente" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="PERC_VLR" label="% Valor" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="column" show-tip="false">
                <xField>APELIDO</xField>
                <yField>PERC_VLR</yField>
                <display><![CDATA[Vendedor]]></display>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8u" description="Nivel3_A">
    <args>
      <arg id="A_MARCA" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="184">
        <grid id="grd_hn5n6c" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>:A_MARCA - Meta por Marca << Vendedor </b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

MARCA

, CODVEND

, APELIDO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO

FROM

(





SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

	

)

WHERE (MARCA = :A_MARCA)

GROUP BY 

MARCA

, CODVEND

, APELIDO

ORDER BY 8 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="Marca" type="S" visible="false" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
          <on-click navigate-to="lvl_g8hn8v">
            <param id="A_MARCA">$MARCA</param>
            <param id="A_CODVEND">$CODVEND</param>
            <param id="A_CODPARC">$CODPARC</param>
            <param id="A_APELIDO">$APELIDO</param>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="H" tamanhoRelativo="343">
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy2e">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Consolidado Marca</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5o9h">
                <param id="A_MARCA">:A_MARCA</param>
              </on-click>
            </simple-value>
          </container>
          <container orientacao="V" tamanhoRelativo="50">
            <simple-value id="svl_mrdy2g">
              <value-expression><![CDATA[<div style='text-align: center;'><button style='font-weight: bold; padding: 5px 15px; font-size: 12px; background-color: green; color: white;'>Auditoria Valores</button></div>]]></value-expression>
              <on-click navigate-to="lvl_hn5pc2">
                <param id="A_MARCA">:A_MARCA</param>
              </on-click>
            </simple-value>
          </container>
        </container>
        <container orientacao="H" tamanhoRelativo="1462">
          <chart id="cht_mrdy2c" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume </b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

CODVEND

, APELIDO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (MARCA = :A_MARCA)

GROUP BY CODVEND,APELIDO, MARCA)

WHERE RN <= 3



UNION ALL





SELECT



9999 AS CODVEND

, 'OUTROS' AS APELIDO

, 'OUTROS' AS MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(



SELECT * FROM

(SELECT

CODVEND

, APELIDO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (MARCA = :A_MARCA)

GROUP BY CODVEND,APELIDO, MARCA)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>APELIDO</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="H" tamanhoRelativo="1256">
          <chart id="cht_mrdy2a" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

CODVEND

, APELIDO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (MARCA = :A_MARCA)

GROUP BY CODVEND,APELIDO, MARCA)

WHERE RN <= 3



UNION ALL





SELECT



9999 AS CODVEND

, 'OUTROS' AS APELIDO

, 'OUTROS' AS MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(



SELECT * FROM

(SELECT

CODVEND

, APELIDO

, MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (MARCA = :A_MARCA)

GROUP BY CODVEND,APELIDO, MARCA)

WHERE RN > 3)]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>APELIDO</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hn8v" description="Nivel3_B">
    <args>
      <arg id="A_MARCA" type="text"/>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="184">
        <grid id="grd_iyh4x8" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>Meta por Marca: - :A_MARCA << Vendedor - :A_APELIDO << Cliente</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

, NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) TICKET_MEDIO_META

, CASE 
    WHEN NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0) = 0 THEN 0
    ELSE (
      (NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) - NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0))
      / NVL(SUM(VLR_PREV)/NULLIF(SUM(QTDPREV),0),0)
    ) * 100
  END AS VAR_PERC_TICKET_MEDIO

FROM

(





SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	/*AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD	



)

WHERE (CODVEND = :A_CODVEND)

AND (MARCA = :A_MARCA)

GROUP BY

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO

ORDER BY 2 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="Marca" type="S" visible="false" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="false" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="false" useFooter="false"/>
            <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00">
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
              </formatter>
              <formatter formula="true">
                <formula><![CDATA[]]></formula>
                <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
              </formatter>
            </field>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="TICKET_MEDIO_META" label="Ticket Médio Meta" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
            <field name="VAR_PERC_TICKET_MEDIO" label="Var. % Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
          </metadata>
          <on-click navigate-to="lvl_g8hn8v">
            <param id="A_MARCA"/>
            <param id="A_CODVEND"/>
            <param id="A_CODPARC"/>
          </on-click>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="100">
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh4ya" type="pizza">
            <title><![CDATA[<b>TOP 3 - Volume </b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(





SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	/*AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD



)

WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)

GROUP BY

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO)

WHERE RN <= 3



UNION ALL







SELECT



'OUTROS' AS MARCA

, 9999 AS CODVEND

, 'OUTROS' AS APELIDO

, 9999 AS CODPARC

, 'OUTROS' AS RAZAOSOCIAL

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(



SELECT * FROM

(SELECT

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)

GROUP BY

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO)

WHERE RN > 3)

ORDER BY 9 DESC]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="CODPARC" label="CODPARC" type="I" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>QTDREAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
        <container orientacao="V" tamanhoRelativo="50">
          <chart id="cht_iyh4yc" type="pizza">
            <title><![CDATA[<b>TOP 3 - Valores</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT * FROM

(SELECT

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(





SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	/*AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD



)

WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)

GROUP BY

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO)

WHERE RN <= 3



UNION ALL







SELECT



'OUTROS' AS MARCA

, 9999 AS CODVEND

, 'OUTROS' AS APELIDO

, 9999 AS CODPARC

, 'OUTROS' AS RAZAOSOCIAL

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV) AS VLR_PREV

, SUM(VLR_REAL) AS VLR_REAL

, 4 AS RN

FROM



(



SELECT * FROM

(SELECT

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, ROW_NUMBER() OVER (ORDER BY SUM(QTDREAL) DESC) AS RN

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODVEND = :A_CODVEND) AND (MARCA = :A_MARCA)

GROUP BY

MARCA

, CODVEND

, APELIDO

, CODPARC

, PARCEIRO)

WHERE RN > 3)

ORDER BY 9 DESC]]></expression>
            <metadata>
              <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
              <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
              <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
              <field name="CODPARC" label="CODPARC" type="F" visible="true" useFooter="false"/>
              <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
              <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
              <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
              <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
              <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false"/>
              <field name="RN" label="RN" type="F" visible="true" useFooter="false"/>
            </metadata>
            <series>
              <serie type="pizza" labelSize="15">
                <field>VLR_REAL</field>
                <nameField>PARCEIRO</nameField>
              </serie>
            </series>
          </chart>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_g8hoge" description="Nivel1_A1">
    <args>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_g8hoid" useNewGrid="S">
        <title><![CDATA[Vendedor - :A_APELIDO]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO
FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODVEND = :A_CODVEND)

GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA

ORDER BY "PERC_VLR" DESC]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="false" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="false" useFooter="false"/>
          <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
          <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
          <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_g8hogf" description="Nivel1_A2">
    <args>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="101">
        <grid id="grd_g8hot5" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria por Vendedor]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 

CODVEND

, APELIDO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODVEND = :A_CODVEND)

GROUP BY CODVEND, APELIDO

ORDER BY APELIDO ASC, "QTDREAL" DESC]]></expression>
          <metadata>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          </metadata>
          <refresh-details ui-list="grd_aklqjbd">
            <param id="A_CODVEND">$CODVEND</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="302">
        <grid id="grd_aklqjbd" useNewGrid="S">
          <args>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria do Realizado]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

NUNOTA,NUMNOTA,DTMOV,CODVEND,APELIDO,CODPARC,PARCEIRO,MARCA,CODPROD,DESCRPROD,QTD,VLR,TOP

FROM(

SELECT

X.CODMETA,X.DTREF,X.NUNOTA,X.NUMNOTA,X.DTMOV,X.CODVEND,X.APELIDO,X.CODPARC,X.PARCEIRO,X.MARCA,X.CODPROD,X.DESCRPROD,X.CODGRUPOPROD,X.QTD,X.VLR,X.TOP

FROM(	

SELECT

MET.CODMETA,MET.DTREF,VGF.NUNOTA,VGF.NUMNOTA,VGF.DTMOV,VGF.CODVEND,VEN.AD_VENDEDOR_MATRIZ,VEN.CODGER,VEN.APELIDO,VGF.CODPARC,PAR.RAZAOSOCIAL AS PARCEIRO,VGF.MARCA,VGF.CODPROD,VGF.DESCRPROD,VGF.CODGRUPOPROD,VGF.QTD,VGF.VLR,VGF.TOP

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTD <> 0 OR X.VLR<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	/*AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)



	AND(

	:A_CODVEND IS NULL 

	OR X.AD_VENDEDOR_MATRIZ = :A_CODVEND 

	OR X.CODVEND = :A_CODVEND

	)	

)





]]></expression>
          <metadata>
            <field name="NUNOTA" label="Nro Único" type="I" visible="true" useFooter="false"/>
            <field name="NUMNOTA" label="Nro Nota" type="I" visible="true" useFooter="false"/>
            <field name="DTMOV" label="Dt. Movimento" type="D" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CODPARC" label="Cód. Cliente" type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="CODPROD" label="Cód. Produto" type="I" visible="true" useFooter="false"/>
            <field name="DESCRPROD" label="Produto" type="S" visible="true" useFooter="false"/>
            <field name="QTD" label="Qtd." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR" label="Vlr." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="TOP" label="Top" type="S" visible="true" useFooter="false"/>
          </metadata>
          <on-click-launcher resource-id="br.com.sankhya.com.mov.CentralNotas">
            <NUNOTA>$NUNOTA</NUNOTA>
          </on-click-launcher>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_hn5ox1" description="Nivel2_A1">
    <args>
      <arg id="A_CODPARC" type="integer"/>
      <arg id="A_APELIDO" type="text"/>
      <arg id="A_PARCEIRO" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_hn5ox3" useNewGrid="S">
        <title><![CDATA[Vendedor >> Cliente - :A_PARCEIRO]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

FROM



(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA

ORDER BY "PERC_VLR" DESC]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
          <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
          <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="null"/>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_hn5o1d" description="Nivel2_A2">
    <args>
      <arg id="A_CODPARC" type="integer"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="120">
        <grid id="grd_hn5o1f" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria por Cliente]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 

CODPARC

, PARCEIRO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

WHERE (CODPARC = :A_CODPARC)

GROUP BY

CODPARC

, PARCEIRO

ORDER BY 5 DESC]]></expression>
          <metadata>
            <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC" label="%" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="PERC_VLR" label="%" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          </metadata>
          <refresh-details ui-list="grd_hn5o1h">
            <param id="A_CODPARC">$CODPARC</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="363">
        <grid id="grd_hn5o1h" useNewGrid="S">
          <args>
            <arg id="A_CODPARC" type="integer"/>
          </args>
          <title><![CDATA[Auditoria do Realizado]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

NUNOTA,NUMNOTA,DTMOV,CODVEND,APELIDO,CODPARC,PARCEIRO,MARCA,CODPROD,DESCRPROD,QTD,VLR,TOP

FROM(

SELECT

X.CODMETA,X.DTREF,X.NUNOTA,X.NUMNOTA,X.DTMOV,X.CODVEND,X.APELIDO,X.CODPARC,X.PARCEIRO,X.MARCA,X.CODPROD,X.DESCRPROD,X.CODGRUPOPROD,X.QTD,X.VLR,X.TOP

FROM(	

SELECT

MET.CODMETA,MET.DTREF,VGF.NUNOTA,VGF.NUMNOTA,VGF.DTMOV,VGF.CODVEND,VEN.AD_VENDEDOR_MATRIZ,VEN.CODGER,VEN.APELIDO,VGF.CODPARC,PAR.RAZAOSOCIAL AS PARCEIRO,VGF.MARCA,VGF.CODPROD,VGF.DESCRPROD,VGF.CODGRUPOPROD,VGF.QTD,VGF.VLR,VGF.TOP

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTD <> 0 OR X.VLR<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	/*AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)*/

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

)

WHERE (CODPARC = :A_CODPARC)]]></expression>
          <metadata>
            <field name="NUNOTA" label="Nro Único" type="I" visible="true" useFooter="false"/>
            <field name="NUMNOTA" label="Nro Nota" type="I" visible="true" useFooter="false"/>
            <field name="DTMOV" label="Dt. Movimento" type="D" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CODPARC" label="Cód. Cliente" type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="CODPROD" label="Cód. Produto" type="I" visible="true" useFooter="false"/>
            <field name="DESCRPROD" label="Produto" type="S" visible="true" useFooter="false"/>
            <field name="QTD" label="Qtd." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR" label="Vlr." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="TOP" label="Top" type="S" visible="true" useFooter="false"/>
          </metadata>
          <on-click-launcher resource-id="br.com.sankhya.com.mov.CentralNotas">
            <NUNOTA>$NUNOTA</NUNOTA>
          </on-click-launcher>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_hn5o9h" description="Nivel3_A1">
    <args>
      <arg id="A_MARCA" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_hn5o9j" useNewGrid="S">
        <title><![CDATA[Marca - :A_MARCA]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

, NVL(SUM(VLR_REAL)/NULLIF(SUM(QTDREAL),0),0) TICKET_MEDIO

FROM



(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(QTDPREV * PRECOLT) AS VLR_PREV,

SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(

SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)



)

WHERE 

CODMETA = :P_CODMETA

AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (QTDPREV <> 0 OR QTDREAL <>  0 OR VLRREAL<>0)) OR :P_NTEMMETA = 'N')

AND (CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

AND (CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (CODVEND IN :P_CODVEND) AND (CODGER IN :P_COORD)

AND (MARCA = :A_MARCA)



AND

(

	CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)



GROUP BY CODVEND, APELIDO, CODPARC, PARCEIRO,MARCA

ORDER BY 8 DESC]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
          <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
          <field name="MARCA" label="Marca" type="S" visible="false" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00;-n"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; background-color:#FFFFFF; src:iconFlagBlue">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]>
            </formatter>
            <formatter formula="true">
              <formula><![CDATA[]]></formula>
              <![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]>
            </formatter>
          </field>
          <field name="TICKET_MEDIO" label="Ticket Médio" type="F" visible="true" useFooter="AVG" mask="#.##0,00"/>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_hn5pc2" description="Nivel3_A2">
    <args>
      <arg id="A_MARCA" type="text"/>
    </args>
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="100">
        <grid id="grd_hn5pc4" useNewGrid="S">
          <args>
            <arg id="A_APELIDO" type="text"/>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[Auditoria por Marca]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 

MARCA

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(VLR_REAL)  AS VLR_REAL

, CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)



	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

WHERE (MARCA = :A_MARCA)

GROUP BY

MARCA

ORDER BY 5 DESC]]></expression>
          <metadata>
            <field name="MARCA" label="MARCA" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="Qtd.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="QTDREAL" label="Qtd.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLR_PREV" label="Vlr.Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR_REAL" label="Vlr.Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          </metadata>
          <refresh-details ui-list="grd_aklqhce">
            <param id="A_MARCA">$MARCA</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="234">
        <grid id="grd_aklqhce" useNewGrid="S">
          <args>
            <arg id="A_MARCA" type="text"/>
          </args>
          <title><![CDATA[Auditoria do Realizado]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

NUNOTA,NUMNOTA,DTMOV,CODVEND,APELIDO,CODPARC,PARCEIRO,MARCA,CODPROD,DESCRPROD,QTD,VLR,TOP

FROM(

SELECT

X.CODMETA,X.DTREF,X.NUNOTA,X.NUMNOTA,X.DTMOV,X.CODVEND,X.APELIDO,X.CODPARC,X.PARCEIRO,X.MARCA,X.CODPROD,X.DESCRPROD,X.CODGRUPOPROD,X.QTD,X.VLR,X.TOP

FROM(	

SELECT

MET.CODMETA,MET.DTREF,VGF.NUNOTA,VGF.NUMNOTA,VGF.DTMOV,VGF.CODVEND,VEN.AD_VENDEDOR_MATRIZ,VEN.CODGER,VEN.APELIDO,VGF.CODPARC,PAR.RAZAOSOCIAL AS PARCEIRO,VGF.MARCA,VGF.CODPROD,VGF.DESCRPROD,VGF.CODGRUPOPROD,VGF.QTD,VGF.VLR,VGF.TOP

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTD <> 0 OR X.VLR<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	/*AND (X.MARCA IN :P_MARCA)*/

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

)

WHERE (MARCA = :A_MARCA)]]></expression>
          <metadata>
            <field name="NUNOTA" label="Nro Único" type="I" visible="true" useFooter="false"/>
            <field name="NUMNOTA" label="Nro Nota" type="I" visible="true" useFooter="false"/>
            <field name="DTMOV" label="Dt. Movimento" type="D" visible="true" useFooter="false"/>
            <field name="CODVEND" label="Cód. Vendedor" type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CODPARC" label="Cód. Cliente" type="I" visible="true" useFooter="false"/>
            <field name="PARCEIRO" label="PARCEIRO" type="S" visible="true" useFooter="false"/>
            <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
            <field name="CODPROD" label="Cód. Produto" type="I" visible="true" useFooter="false"/>
            <field name="DESCRPROD" label="Produto" type="S" visible="true" useFooter="false"/>
            <field name="QTD" label="Qtd." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="VLR" label="Vlr" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="TOP" label="TOP" type="S" visible="true" useFooter="false"/>
          </metadata>
          <on-click-launcher resource-id="br.com.sankhya.com.mov.CentralNotas">
            <NUNOTA>$NUNOTA</NUNOTA>
          </on-click-launcher>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_v5w4xf" description="Nivel4 Analise Custo">
    <args>
      <arg id="A_CODVEND" type="integer"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="152">
        <grid id="grd_v5w40d" entityName="AD_PERCECUSTO" useNewGrid="S">
          <title><![CDATA[<b>Consolidado por Vendedor</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT 
    CODVEND,
    APELIDO,
    CR_LISTA,
    VLR_PREV,
    VLRREAL,
    VLRDESP,
    (SELECT PERCCUSTO FROM AD_PERCECUSTO) PERCUSTO,
    VLRDESP+(VLRDESP *((SELECT PERCCUSTO FROM AD_PERCECUSTO)/100))VLRCUSTOPREV,
    CASE WHEN VLR_PREV = 0 THEN 100 ELSE NVL(VLRREAL * 100 / NULLIF(VLR_PREV, 0), 0) END AS PERC_VLR,
    CASE WHEN VLRREAL = 0 THEN 0 ELSE VLRDESP / NULLIF(VLRREAL, 0) * -1 * 100 END AS PERC_VLRDESP_EM_REAL
FROM (
    SELECT 
        CODVEND,
        APELIDO,
        LISTAGG(CR_LISTA, ', ') WITHIN GROUP (ORDER BY CR_LISTA) AS CR_LISTA,
        SUM(VLR_PREV) AS VLR_PREV,
        SUM(VLRREAL) AS VLRREAL,
        SUM(VLRDESP) AS VLRDESP
    FROM (
        SELECT
            CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(V.AD_VENDEDOR_MATRIZ, V.CODVEND) ELSE V.CODVEND END AS CODVEND,
            CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(VEN1.APELIDO, V.APELIDO) ELSE V.APELIDO END AS APELIDO,
            SUM(V.VLR_PREV) AS VLR_PREV,
            SUM(V.VLRREAL) AS VLRREAL,
            SUM(V.VLRDESP) AS VLRDESP,
            V.CR_LISTA
        FROM (
            WITH CUS4 AS (
                SELECT
                    AD_VENDEDOR_RESP,
                    LISTAGG(DISTINCT NVL(AD_APELIDO,DESCRCENCUS), '|| ') WITHIN GROUP (ORDER BY CODCENCUS) AS CR_LISTA,
                    SUM(VLRDESP) AS VLRDESP
                FROM (
                    SELECT
                        
                        CASE WHEN :P_DTENTSAI = '1' THEN DHBAIXA WHEN :P_DTENTSAI = '2' THEN DTENTSAI END AS DATA,
                        AD_VENDEDOR_RESP,
                        CODCENCUS,
                        DESCRCENCUS,
                        GRAU,
                        ANALITICO,
                        AD_APELIDO,
                        CODNAT,
                        DESCRNAT,
                        VLRDESDOB_REC,
                        VLRDESDOB_DESP,
                        VLRDESDOB,
                        VLRJURO,
                        VLRMULTA,
                        VLRDESC,
                        VLRBAIXA_REC,
                        VLRBAIXA_DESP,
                        VLRBAIXA,
                        VLRREC,
                        VLRDESP
                    FROM (

                        --ANÁLITICO INICIO

                        SELECT 
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
                            CUS1.CODCENCUS,
                            CASE 
                                WHEN CUS1.GRAU = 2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
                                ELSE CUS1.GRAU || '_' || CUS1.DESCRCENCUS 
                            END AS DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_DESP,
                            NVL(SUM(X.VLRDESDOB), 0) AS VLRDESDOB,
                            NVL(SUM(X.VLRJURO), 0) AS VLRJURO,
                            NVL(SUM(X.VLRMULTA), 0) AS VLRMULTA,
                            NVL(SUM(X.VLRDESC), 0) AS VLRDESC,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_DESP,
                            NVL(SUM(X.VLRBAIXA), 0) AS VLRBAIXA,
                            NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRREC,
                            NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1, 0) THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRDESP
                        FROM TSICUS CUS1
                        LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS = CUS1.CODCENCUS
                        INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT
                        WHERE 

                        ((:P_DADOS_FIN = 'S' AND

                        (
                            --TRATATIVA ESPECIFICA PARA COMISSÕES
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR DIFERENTE DE P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES PROVISIONADAS)
                                (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                                OR
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR IGUAL A P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES REAIS)
                                (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                            OR
                            --TRATATIVA PARA LANÇAMENTOS DIFERENTES DE COMISSÕES E RECEITA DE VENDAS
                                --FILTRAR PELA DATA DE BAIXA (APENAS DESPESAS COM NATUREZA DIFERENTE DE COMISSÕES E RECEITA DE VENDAS)
                                (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
                                AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                        )) OR :P_DADOS_FIN = 'N')


                        --DESCONSIDERA MOVIMENTOS RELACIONADOS AO FATURAMENTO (RECEITA E DEVOLUÇÃO DE VENDAS) POIS ESSES VALORES VEM DA VIEW DE VENDAS
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS A ANTECIPAÇÕES (ADIANTAMENTO/CRÉDITO)
                        AND X.CODNAT NOT IN (1010000, 1020000, 6010100, 6010200)
                        --CONSIDERA APENAS CR COMERCIAL, PORÉM ISSO ANULA O FILTRO DE COMISSÕES DO C.R P&D
                        AND X.CODCENCUS LIKE '9%'
                        AND X.PROVISAO = 'N'
                        AND X.VLRBAIXA <> 0
                        --PARAMETRO INPUTADO PELO USUÁRIO
                        AND (X.CODNAT IN :P_NATUREZA)

                        GROUP BY
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0),
                            CUS1.CODCENCUS,
                            CUS1.DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT

                        --ANÁLITICO FIM

                    )
                    WHERE 
                    (
                        (:P_DTENTSAI = '2' AND DTENTSAI BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
                        OR
                        (:P_DTENTSAI = '1' AND DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
                    )
                )
                GROUP BY AD_VENDEDOR_RESP
            )
            SELECT 
                A.CODVEND,
                APELIDO,
                AD_VENDEDOR_MATRIZ,
                CUS4.CR_LISTA,
                SUM(QTDPREV) AS QTDPREV,
                SUM(QTDREAL) AS QTDREAL,
                SUM(QTDPREV * PRECOLT) AS VLR_PREV,
                SUM(VLRREAL) AS VLRREAL,
                NVL(CUS4.VLRDESP, 0) AS VLRDESP
            FROM (
                SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS, 0) AS CODCENCUS, NVL(MET.QTDPREV, 0) AS QTDPREV, 
                SUM(NVL(VGF.QTD, 0)) AS QTDREAL, NVL(PRC.VLRVENDALT, 0) AS PRECOLT, SUM(NVL(VGF.VLR, 0)) AS VLRREAL
                FROM TGFMET MET
                LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV, 'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
                LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
                WHERE MET.CODMETA = :P_CODMETA
                AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
                AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')
                AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
                GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS, 0), NVL(MET.QTDPREV, 0), NVL(PRC.VLRVENDALT, 0)
            ) A
            INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND
            LEFT JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC
            LEFT JOIN CUS4 ON A.CODVEND = NVL(CUS4.AD_VENDEDOR_RESP,0)
            WHERE
                (VEN.CODVEND IN :P_CODVEND)
                AND (VEN.CODGER IN :P_COORD)
                AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
                AND (A.MARCA IN :P_MARCA)
            GROUP BY A.CODVEND, APELIDO, NVL(CUS4.VLRDESP, 0), CUS4.CR_LISTA, AD_VENDEDOR_MATRIZ
        ) V
        LEFT JOIN TGFVEN VEN1 ON VEN1.CODVEND = V.AD_VENDEDOR_MATRIZ  
        WHERE 
        (
            (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
        )
        /*AND v.VLRDESP <> 0 */
        GROUP BY V.AD_VENDEDOR_MATRIZ, V.CODVEND, VEN1.APELIDO, V.APELIDO, V.CR_LISTA
    )
    GROUP BY CODVEND, APELIDO
)
ORDER BY 2]]></expression>
          <metadata>
            <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
            <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
            <field name="CR_LISTA" label="Apelido CR's" type="S" visible="true" useFooter="false"/>
            <field name="VLR_PREV" label="Vlr. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter greaterThan="0"><![CDATA[<span style="color:#0000FF">$VALUE</span>]]></formatter>
            </field>
            <field name="VLRREAL" label="Vlr. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter greaterThan="0"><![CDATA[<span style="color:#339900">$VALUE</span>]]></formatter>
            </field>
            <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
            </field>
            <field name="PERCUSTO" label="% Custo Pevisto" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
            <field name="VLRCUSTOPREV" label="Custo Previsto" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
            <field name="PERC_VLR" label="% Real" type="F" visible="true" useFooter="AVG" mask="###0,0000">
              <formatter lessThan="80"><![CDATA[<span style="color:#FFFFFF; background-color:#FF0000">$VALUE</span>]]></formatter>
              <formatter between="80" and="99.99"><![CDATA[<span style="color:#000000; background-color:#FFFF00">$VALUE</span>]]></formatter>
              <formatter greaterEqualThan="100"><![CDATA[<span style="color:#FFFFFF; background-color:#009900">$VALUE</span>]]></formatter>
            </field>
            <field name="PERC_VLRDESP_EM_REAL" label="% Custo" type="F" visible="true" useFooter="AVG" mask="###0,0000">
              <formatter lessThan="21"><![CDATA[<span style="color:#FFFFFF; background-color:#339900">$VALUE</span>]]></formatter>
              <formatter between="21" and="24.99"><![CDATA[<span style="color:#000000; background-color:#FFFF00">$VALUE</span>]]></formatter>
              <formatter greaterEqualThan="25"><![CDATA[<span style="color:#FFFFFF; background-color:#FF0000">$VALUE</span>]]></formatter>
            </field>
          </metadata>
          <on-click navigate-to="lvl_xrixyq">
            <param id="A_CODVEND">$CODVEND</param>
            <param id="A_CODCENCUS">$CODVEND</param>
            <param id="A_VENDEDOR">$APELIDO</param>
            <param id="A_DESCRCENCUS">$APELIDO</param>
          </on-click>
          <refresh-details ui-list="grd_qifqrm,cht_aizxkjx">
            <param id="A_CODVEND">$CODVEND</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="118">
        <container orientacao="H" tamanhoRelativo="226">
          <grid id="grd_qifqrm" useNewGrid="S">
            <args>
              <arg id="A_CODVEND" type="integer"/>
            </args>
            <title><![CDATA[<b>Detalhamento por Natureza</b>]]></title>
            <expression type="sql" data-source="MGEDS"><![CDATA[SELECT
    CODVEND, CODNAT, DESCRNAT,
    SUM(VLRDESP) VLRDESP,
    SUM(CASE WHEN VLRREAL = 0 THEN 0 ELSE VLRDESP / NULLIF(VLRREAL, 0) * -1 * 100 END) AS PERC_VLR
FROM (
    SELECT
        CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(V.AD_VENDEDOR_MATRIZ, V.CODVEND) ELSE V.CODVEND END CODVEND,
        V.CODNAT,
        V.DESCRNAT,
        SUM(V.VLRDESP) VLRDESP,
        SUM(V.VLRREAL) VLRREAL
    FROM (
        WITH CUS4 AS (
            SELECT
                CODNAT, DESCRNAT, AD_VENDEDOR_RESP, SUM(VLRDESP) AS VLRDESP
            FROM (
                SELECT
                    CASE WHEN :P_DTENTSAI = '1' THEN DHBAIXA WHEN :P_DTENTSAI = '2' THEN DTENTSAI END AS DATA,
                    AD_VENDEDOR_RESP,
                    CODCENCUS,
                    DESCRCENCUS,
                    GRAU,
                    ANALITICO,
                    CODNAT,
                    DESCRNAT,
                    VLRDESDOB_REC,
                    VLRDESDOB_DESP,
                    VLRDESDOB,
                    VLRJURO,
                    VLRMULTA,
                    VLRDESC,
                    VLRBAIXA_REC,
                    VLRBAIXA_DESP,
                    VLRBAIXA,
                    VLRREC,
                    VLRDESP
                FROM (


                        --ANÁLITICO INICIO
                        SELECT 
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
                            CUS1.CODCENCUS,
                            CASE 
                                WHEN CUS1.GRAU = 2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
                                ELSE CUS1.GRAU || '_' || CUS1.DESCRCENCUS 
                            END AS DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_DESP,
                            NVL(SUM(X.VLRDESDOB), 0) AS VLRDESDOB,
                            NVL(SUM(X.VLRJURO), 0) AS VLRJURO,
                            NVL(SUM(X.VLRMULTA), 0) AS VLRMULTA,
                            NVL(SUM(X.VLRDESC), 0) AS VLRDESC,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_DESP,
                            NVL(SUM(X.VLRBAIXA), 0) AS VLRBAIXA,
                            NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRREC,
                            NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1, 0) THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRDESP
                        FROM TSICUS CUS1
                        LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS = CUS1.CODCENCUS
                        LEFT JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT
                        WHERE 

                        ((:P_DADOS_FIN = 'S' AND

                        (
                            --TRATATIVA ESPECIFICA PARA COMISSÕES
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR DIFERENTE DE P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES PROVISIONADAS)
                                (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                                OR
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR IGUAL A P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES REAIS)
                                (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                            OR
                            --TRATATIVA PARA LANÇAMENTOS DIFERENTES DE COMISSÕES E RECEITA DE VENDAS
                                --FILTRAR PELA DATA DE BAIXA (APENAS DESPESAS COM NATUREZA DIFERENTE DE COMISSÕES E RECEITA DE VENDAS)
                                (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
                                AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                        )) OR :P_DADOS_FIN = 'N')

                        --DESCONSIDERA MOVIMENTOS RELACIONADOS AO FATURAMENTO (RECEITA E DEVOLUÇÃO DE VENDAS) POIS ESSES VALORES VEM DA VIEW DE VENDAS
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS A ANTECIPAÇÕES (ADIANTAMENTO/CRÉDITO)
                        AND X.CODNAT NOT IN (1010000, 1020000, 6010100, 6010200)
                        --CONSIDERA APENAS CR COMERCIAL, PORÉM ISSO ANULA O FILTRO DE COMISSÕES DO C.R P&D
                        AND X.CODCENCUS LIKE '9%'
                        AND X.PROVISAO = 'N'
                        AND X.VLRBAIXA <> 0
                        --PARAMETRO INPUTADO PELO USUÁRIO
                        AND (X.CODNAT IN :P_NATUREZA)
                        

                        GROUP BY
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0),
                            CUS1.CODCENCUS,
                            CUS1.DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT
                        --ANÁLITICO FIM


                )
                WHERE 
                (
                    (:P_DTENTSAI = 2 AND DTENTSAI BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
                    OR
                    (:P_DTENTSAI = 1 AND DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
                )
            )
            GROUP BY AD_VENDEDOR_RESP, CODNAT, DESCRNAT
        )
        SELECT 
            A.CODVEND,
            AD_VENDEDOR_MATRIZ,
            APELIDO,
            CODNAT,
            DESCRNAT,
            SUM(QTDPREV) AS QTDPREV,
            SUM(QTDREAL) AS QTDREAL,
            CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC,
            SUM(QTDPREV * PRECOLT) AS VLR_PREV,
            SUM(VLRREAL) AS VLRREAL,
            CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 100 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR,
            NVL(CUS4.VLRDESP, 0) AS VLRDESP
        FROM (
            SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS, 0) AS CODCENCUS, NVL(MET.QTDPREV, 0) AS QTDPREV, 
            SUM(NVL(VGF.QTD, 0)) AS QTDREAL, NVL(PRC.VLRVENDALT, 0) AS PRECOLT, SUM(NVL(VGF.VLR, 0)) AS VLRREAL
            FROM TGFMET MET
            LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV, 'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
            LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
            WHERE MET.CODMETA = :P_CODMETA
            AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
            AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')
            AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
            GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS, 0), NVL(MET.QTDPREV, 0), NVL(PRC.VLRVENDALT, 0)
        ) A
        INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND
        LEFT JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC
        LEFT JOIN CUS4 ON A.CODVEND = CUS4.AD_VENDEDOR_RESP
        WHERE
            (VEN.CODVEND IN :P_CODVEND)
            AND (VEN.CODGER IN :P_COORD)
            AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
            AND (A.MARCA IN :P_MARCA)
        GROUP BY A.CODVEND, APELIDO, CODNAT, DESCRNAT, NVL(CUS4.VLRDESP, 0), AD_VENDEDOR_MATRIZ
    ) V
    WHERE V.VLRDESP <> 0 


    AND EXISTS (
        SELECT 1 FROM TGFVEN V2
        WHERE V2.CODVEND = V.CODVEND
        AND (
            (:VENDEDOR_MATRIZ = 'S' AND NVL(V2.AD_VENDEDOR_MATRIZ, V2.CODVEND) = :A_CODVEND)
            OR (:VENDEDOR_MATRIZ <> 'S' AND V2.CODVEND = :A_CODVEND)
        )
    )    


    AND
    (
        (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
    )
    GROUP BY V.CODVEND, V.CODNAT, V.DESCRNAT, V.AD_VENDEDOR_MATRIZ
)
GROUP BY CODVEND, CODNAT, DESCRNAT
ORDER BY 2]]></expression>
            <metadata>
              <field name="CODVEND" label="CODVEND" type="I" visible="false" useFooter="false"/>
              <field name="CODNAT" label="Cód. Nat." type="I" visible="true" useFooter="false"/>
              <field name="DESCRNAT" label="Natureza" type="S" visible="true" useFooter="false"/>
              <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
                <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
              </field>
              <field name="PERC_VLR" label="%" type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
            </metadata>
          </grid>
        </container>
        <container orientacao="V" tamanhoRelativo="294">
          <container orientacao="V" tamanhoRelativo="240">
            <chart id="cht_aizxkjx" type="line" nroColuna="6">
              <args>
                <arg id="A_CODVEND" type="integer"/>
              </args>
              <title><![CDATA[<b style="font-size: 16px;">Evolução Real x Custo</b>]]></title>
              <expression type="sql" data-source="MGEDS"><![CDATA[WITH CUS4 AS (
        SELECT
            TO_CHAR(DATA,'YYYY')ANO,
            TO_CHAR(DATA,'MM')MES,
            TO_CHAR(DATA,'MM/YYYY')DATAM,  
            NVL(AD_VENDEDOR_RESP,0) AD_VENDEDOR_RESP,
            
            SUM(VLRDESP) AS VLRDESP
        FROM (
            SELECT
                CASE WHEN :P_DTENTSAI = '1' THEN DHBAIXA WHEN :P_DTENTSAI = '2' THEN DTENTSAI END AS DATA,
                AD_VENDEDOR_RESP,
                CODCENCUS,
                DESCRCENCUS,
                GRAU,
                ANALITICO,
                AD_APELIDO,
                CODNAT,
                DESCRNAT,
                VLRDESDOB_REC,
                VLRDESDOB_DESP,
                VLRDESDOB,
                VLRJURO,
                VLRMULTA,
                VLRDESC,
                VLRBAIXA_REC,
                VLRBAIXA_DESP,
                VLRBAIXA,
                VLRREC,
                VLRDESP
            FROM (



                        --ANÁLITICO INICIO
                        SELECT 
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
                            CUS1.CODCENCUS,
                            CASE 
                                WHEN CUS1.GRAU = 2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
                                ELSE CUS1.GRAU || '_' || CUS1.DESCRCENCUS 
                            END AS DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_DESP,
                            NVL(SUM(X.VLRDESDOB), 0) AS VLRDESDOB,
                            NVL(SUM(X.VLRJURO), 0) AS VLRJURO,
                            NVL(SUM(X.VLRMULTA), 0) AS VLRMULTA,
                            NVL(SUM(X.VLRDESC), 0) AS VLRDESC,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_DESP,
                            NVL(SUM(X.VLRBAIXA), 0) AS VLRBAIXA,
                            NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRREC,
                            NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1, 0) THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRDESP
                        FROM TSICUS CUS1
                        LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS = CUS1.CODCENCUS
                        LEFT JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT
                        WHERE 
                        ((:P_DADOS_FIN = 'S' AND

                        (
                            --TRATATIVA ESPECIFICA PARA COMISSÕES
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR DIFERENTE DE P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES PROVISIONADAS)
                                (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                                OR
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR IGUAL A P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES REAIS)
                                (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                            OR
                            --TRATATIVA PARA LANÇAMENTOS DIFERENTES DE COMISSÕES E RECEITA DE VENDAS
                                --FILTRAR PELA DATA DE BAIXA (APENAS DESPESAS COM NATUREZA DIFERENTE DE COMISSÕES E RECEITA DE VENDAS)
                                (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
                                AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                        )) OR :P_DADOS_FIN = 'N')

                        --DESCONSIDERA MOVIMENTOS RELACIONADOS AO FATURAMENTO (RECEITA E DEVOLUÇÃO DE VENDAS) POIS ESSES VALORES VEM DA VIEW DE VENDAS
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS A ANTECIPAÇÕES (ADIANTAMENTO/CRÉDITO)
                        AND X.CODNAT NOT IN (1010000, 1020000, 6010100, 6010200)
                        --CONSIDERA APENAS CR COMERCIAL, PORÉM ISSO ANULA O FILTRO DE COMISSÕES DO C.R P&D
                        AND X.CODCENCUS LIKE '9%'
                        AND X.PROVISAO = 'N'
                        AND X.VLRBAIXA <> 0
                        --PARAMETRO INPUTADO PELO USUÁRIO
                        AND (X.CODNAT IN :P_NATUREZA)
                        

                        GROUP BY
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0),
                            CUS1.CODCENCUS,
                            CUS1.DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT
                        --ANÁLITICO FIM


            )
            WHERE 
            (
                (:P_DTENTSAI = 2 AND DTENTSAI BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
                OR
                (:P_DTENTSAI = 1 AND DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
            )
        )
        GROUP BY TO_CHAR(DATA,'YYYY'),TO_CHAR(DATA,'MM'),TO_CHAR(DATA,'MM/YYYY'),AD_VENDEDOR_RESP

)



SELECT 
TO_CHAR(A.DTREF,'YYYY')ANO,
TO_CHAR(A.DTREF,'MM')MES,
TO_CHAR(A.DTREF,'MM/YYYY')DATA,                    
A.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
SUM(A.VLRREAL) AS VLR_REAL,
CUS4.VLRDESP
FROM (

SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS, 0) AS CODCENCUS, NVL(MET.QTDPREV, 0) AS QTDPREV, 
SUM(NVL(VGF.QTD, 0)) AS QTDREAL, NVL(PRC.VLRVENDALT, 0) AS PRECOLT, SUM(NVL(VGF.VLR, 0)) AS VLRREAL
FROM TGFMET MET
LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV, 'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
WHERE MET.CODMETA = :P_CODMETA
AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')
AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS, 0), NVL(MET.QTDPREV, 0), NVL(PRC.VLRVENDALT, 0)
) A
INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND
LEFT JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC
LEFT JOIN CUS4 ON A.CODVEND = NVL(CUS4.AD_VENDEDOR_RESP,0) AND TO_CHAR(A.DTREF,'MM/YYYY') = CUS4.DATAM

WHERE



(VEN.CODVEND IN :P_CODVEND)
AND (VEN.CODGER IN :P_COORD)
AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
AND (A.MARCA IN :P_MARCA)
AND
(
( :VENDEDOR_MATRIZ = 'S' AND NVL(VEN.AD_VENDEDOR_MATRIZ, A.CODVEND) = :A_CODVEND)
OR 
( :VENDEDOR_MATRIZ <> 'S' AND A.CODVEND = :A_CODVEND)
)


GROUP BY 
TO_CHAR(A.DTREF,'YYYY'),
TO_CHAR(A.DTREF,'MM'),
TO_CHAR(A.DTREF,'MM/YYYY'),
A.CODVEND,
VEN.APELIDO,
VEN.AD_VENDEDOR_MATRIZ,
CUS4.VLRDESP]]></expression>
              <metadata>
                <field name="ANO" label="ANO" type="S" visible="true" useFooter="false"/>
                <field name="MES" label="MES" type="S" visible="true" useFooter="false"/>
                <field name="DATA" label="Periodo" type="S" visible="true" useFooter="false"/>
                <field name="CODVEND" label="Cód.Vend." type="I" visible="true" useFooter="false"/>
                <field name="APELIDO" label="APELIDO" type="S" visible="true" useFooter="false"/>
                <field name="AD_VENDEDOR_MATRIZ" label="AD_VENDEDOR_MATRIZ" type="I" visible="true" useFooter="false"/>
                <field name="VLR_REAL" label="Vlr. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
                <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
              </metadata>
              <horizontal-axis>
                <category field="CODVEND" rotation="0" dropLabel="false">
                  <initView value="first"/>
                </category>
              </horizontal-axis>
              <series>
                <serie type="line" circle-intersection="true">
                  <xField>DATA</xField>
                  <yField>VLR_REAL</yField>
                  <display><![CDATA[Vlr. Real]]></display>
                  <color>0x33cc00</color>
                </serie>
                <serie type="line" circle-intersection="true">
                  <xField>DATA</xField>
                  <yField>VLRDESP</yField>
                  <display><![CDATA[Vlr. Custo]]></display>
                  <color>0xff0000</color>
                </serie>
              </series>
            </chart>
          </container>
          <container orientacao="V" tamanhoRelativo="112">
            <simple-value id="svl_qifqmc">
              <value-expression><![CDATA[<div style="text-align: center;">
  <div 
    style="display: inline-flex; align-items: center; justify-content: center; gap: 8px; background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; max-width: 100%;"
    onmouseover="this.style.backgroundColor='#0056b3';"
    onmouseout="this.style.backgroundColor='#007bff';">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 16 16">
      <path d="M0 0h1v16H0V0zm3 6h2v10H3V6zm3-4h2v14H6V2zm3 6h2v8H9V8zm3-3h2v11h-2V5z"/>
    </svg>
    <b>Custos Regionais</b>
  </div>
</div>
]]></value-expression>
              <on-click navigate-to="lvl_oygv47"/>
            </simple-value>
          </container>
        </container>
      </container>
    </container>
  </level>
  <level id="lvl_xrixyq" description="Nivel4_A Analise Custo">
    <args>
      <arg id="A_CODVEND" type="integer"/>
      <arg id="A_CODCENCUS" type="integer"/>
      <arg id="A_VENDEDOR" type="text"/>
      <arg id="A_DESCRCENCUS" type="text"/>
    </args>
    <container orientacao="H" tamanhoRelativo="100">
      <container orientacao="V" tamanhoRelativo="163">
        <grid id="grd_xrixyr" useNewGrid="S">
          <title><![CDATA[<b>Consolidado por CR - :A_VENDEDOR</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[select
codcencus,
descrcencus,
AD_APELIDO,
vlrdesp,
vlrreal,
CASE WHEN VLRREAL = 0 THEN 100 ELSE (VLRDESP*-1/VLRREAL)*100 END AS PERC
from(

SELECT
CODCENCUS,
DESCRCENCUS,
AD_APELIDO,
SUM(VLRDESP) VLRDESP,
sum(vlrreal) vlrreal
FROM

(

WITH CUS4 AS



(

SELECT
AD_VENDEDOR_RESP,CODCENCUS,DESCRCENCUS,AD_APELIDO,SUM(VLRDESP) AS VLRDESP
FROM
(

SELECT


CASE WHEN :P_DTENTSAI = '1' THEN DHBAIXA WHEN :P_DTENTSAI = '2' THEN DTENTSAI END AS DATA

,AD_VENDEDOR_RESP

,CODCENCUS

,DESCRCENCUS

,GRAU

,ANALITICO

,AD_APELIDO

,CODNAT

,DESCRNAT

,VLRDESDOB_REC

,VLRDESDOB_DESP

,VLRDESDOB

,VLRJURO

,VLRMULTA

,VLRDESC

,VLRBAIXA_REC

,VLRBAIXA_DESP

,VLRBAIXA

,VLRREC

,VLRDESP

FROM(



                        --ANÁLITICO INICIO
                        SELECT 
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
                            CUS1.CODCENCUS,
                            CASE 
                                WHEN CUS1.GRAU = 2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
                                ELSE CUS1.GRAU || '_' || CUS1.DESCRCENCUS 
                            END AS DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_DESP,
                            NVL(SUM(X.VLRDESDOB), 0) AS VLRDESDOB,
                            NVL(SUM(X.VLRJURO), 0) AS VLRJURO,
                            NVL(SUM(X.VLRMULTA), 0) AS VLRMULTA,
                            NVL(SUM(X.VLRDESC), 0) AS VLRDESC,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_DESP,
                            NVL(SUM(X.VLRBAIXA), 0) AS VLRBAIXA,
                            NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRREC,
                            NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1, 0) THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRDESP
                        FROM TSICUS CUS1
                        LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS = CUS1.CODCENCUS
                        LEFT JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT
                        WHERE 

                        

                        ((:P_DADOS_FIN = 'S' AND

                        (
                            --TRATATIVA ESPECIFICA PARA COMISSÕES
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR DIFERENTE DE P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES PROVISIONADAS)
                                (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                                OR
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR IGUAL A P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES REAIS)
                                (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                            OR
                            --TRATATIVA PARA LANÇAMENTOS DIFERENTES DE COMISSÕES E RECEITA DE VENDAS
                                --FILTRAR PELA DATA DE BAIXA (APENAS DESPESAS COM NATUREZA DIFERENTE DE COMISSÕES E RECEITA DE VENDAS)
                                (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
                                AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                        )) OR :P_DADOS_FIN = 'N')
                        
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS AO FATURAMENTO (RECEITA E DEVOLUÇÃO DE VENDAS) POIS ESSES VALORES VEM DA VIEW DE VENDAS
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS A ANTECIPAÇÕES (ADIANTAMENTO/CRÉDITO)
                        AND X.CODNAT NOT IN (1010000, 1020000, 6010100, 6010200)
                        --CONSIDERA APENAS CR COMERCIAL, PORÉM ISSO ANULA O FILTRO DE COMISSÕES DO C.R P&D
                        AND X.CODCENCUS LIKE '9%'
                        AND X.PROVISAO = 'N'
                        AND X.VLRBAIXA <> 0
                        --PARAMETRO INPUTADO PELO USUÁRIO
                        AND (X.CODNAT IN :P_NATUREZA)
                        

                        GROUP BY
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0),
                            CUS1.CODCENCUS,
                            CUS1.DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT
                        --ANÁLITICO FIM






)
WHERE 
(
(:P_DTENTSAI = 2 AND DTENTSAI BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
OR
(:P_DTENTSAI = 1 AND DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
)

)



GROUP BY AD_VENDEDOR_RESP,CODCENCUS,DESCRCENCUS,AD_APELIDO

)



SELECT 

A.CODVEND

, APELIDO

, AD_VENDEDOR_MATRIZ

, CUS4.CODCENCUS

, CUS4.DESCRCENCUS

, CUS4.AD_APELIDO

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(QTDPREV * PRECOLT)  AS VLR_PREV

, SUM(VLRREAL) AS VLRREAL

, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 100 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR

, NVL(CUS4.VLRDESP,0) AS VLRDESP

FROM

(

SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

WHERE MET.CODMETA = :P_CODMETA

AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')

AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)



GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)







)A

LEFT JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND

LEFT JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC

LEFT JOIN CUS4 ON A.CODVEND = NVL(CUS4.AD_VENDEDOR_RESP,0)

WHERE

(VEN.CODVEND IN :P_CODVEND)

AND (VEN.CODGER IN :P_COORD)

AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (A.MARCA IN :P_MARCA)





GROUP BY A.CODVEND, APELIDO,NVL(CUS4.VLRDESP,0),CUS4.CODCENCUS,CUS4.DESCRCENCUS, CUS4.AD_APELIDO, AD_VENDEDOR_MATRIZ

)

WHERE 
(
  (:VENDEDOR_MATRIZ = 'S' AND NVL(AD_VENDEDOR_MATRIZ, CODVEND) = NVL(:A_CODVEND, 0))
  OR 
  (:VENDEDOR_MATRIZ <> 'S' AND CODVEND = NVL(:A_CODVEND, 0))
)

AND
(
	/*CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR */(SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)

GROUP BY CODCENCUS, DESCRCENCUS,AD_APELIDO
)
ORDER BY 2]]></expression>
          <metadata>
            <field name="CODCENCUS" label="Cód. CR" type="I" visible="true" useFooter="false"/>
            <field name="DESCRCENCUS" label="Descrição CR" type="S" visible="true" useFooter="false"/>
            <field name="AD_APELIDO" label="Apelido CR" type="S" visible="true" useFooter="false"/>
            <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
            </field>
            <field name="VLRREAL" label="Vlr. Real" type="F" visible="false" useFooter="false" mask="#.##0,00"/>
            <field name="PERC" label="%" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          </metadata>
          <refresh-details ui-list="grd_xrix7y">
            <param id="A_CODCENCUS">$CODCENCUS</param>
            <param id="A_DESCRCENCUS">$DESCRCENCUS</param>
          </refresh-details>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="110">
        <grid id="grd_xrix7y" useNewGrid="S">
          <args>
            <arg id="A_CODCENCUS" type="integer"/>
            <arg id="A_DESCRCENCUS" type="text"/>
          </args>
          <title><![CDATA[<b>Detalhamento por Natureza | CR: :A_CODCENCUS - :A_DESCRCENCUS</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[

SELECT
CODNAT,DESCRNAT,SUM(VLRDESP) AS VLRDESP,
ROUND(SUM(VLRDESP) / SUM(SUM(VLRDESP)) OVER () * 100, 2) AS PERC

FROM
(
SELECT
CASE WHEN :P_DTENTSAI = '1' THEN DHBAIXA WHEN :P_DTENTSAI = '2' THEN DTENTSAI END AS DATA

,NUFIN
,AD_VENDEDOR_RESP
,CODCENCUS
,DESCRCENCUS
,GRAU
,ANALITICO
,CODNAT
,DESCRNAT
,VLRDESDOB_REC
,VLRDESDOB_DESP
,VLRDESDOB
,VLRJURO
,VLRMULTA
,VLRDESC
,VLRBAIXA_REC
,VLRBAIXA_DESP
,VLRBAIXA
,VLRREC
,VLRDESP
FROM(

                        --ANÁLITICO INICIO
                        SELECT 
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
                            CUS1.CODCENCUS,
                            CASE 
                                WHEN CUS1.GRAU = 2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
                                ELSE CUS1.GRAU || '_' || CUS1.DESCRCENCUS 
                            END AS DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_DESP,
                            NVL(SUM(X.VLRDESDOB), 0) AS VLRDESDOB,
                            NVL(SUM(X.VLRJURO), 0) AS VLRJURO,
                            NVL(SUM(X.VLRMULTA), 0) AS VLRMULTA,
                            NVL(SUM(X.VLRDESC), 0) AS VLRDESC,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_DESP,
                            NVL(SUM(X.VLRBAIXA), 0) AS VLRBAIXA,
                            NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRREC,
                            NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1, 0) THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRDESP
                        FROM TSICUS CUS1
                        LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS = CUS1.CODCENCUS
                        LEFT JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT
                        WHERE 

                        ((:P_DADOS_FIN = 'S' AND

                        (
                            --TRATATIVA ESPECIFICA PARA COMISSÕES
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR DIFERENTE DE P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES PROVISIONADAS)
                                (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                                OR
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR IGUAL A P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES REAIS)
                                (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                            OR
                            --TRATATIVA PARA LANÇAMENTOS DIFERENTES DE COMISSÕES E RECEITA DE VENDAS
                                --FILTRAR PELA DATA DE BAIXA (APENAS DESPESAS COM NATUREZA DIFERENTE DE COMISSÕES E RECEITA DE VENDAS)
                                (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
                                AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                        )) OR :P_DADOS_FIN = 'N')
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS AO FATURAMENTO (RECEITA E DEVOLUÇÃO DE VENDAS) POIS ESSES VALORES VEM DA VIEW DE VENDAS
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS A ANTECIPAÇÕES (ADIANTAMENTO/CRÉDITO)
                        AND X.CODNAT NOT IN (1010000, 1020000, 6010100, 6010200)
                        --CONSIDERA APENAS CR COMERCIAL, PORÉM ISSO ANULA O FILTRO DE COMISSÕES DO C.R P&D
                        AND X.CODCENCUS LIKE '9%'
                        AND X.PROVISAO = 'N'
                        AND X.VLRBAIXA <> 0
                        --PARAMETRO INPUTADO PELO USUÁRIO
                        AND (X.CODNAT IN :P_NATUREZA)
                        

                        GROUP BY
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0),
                            CUS1.CODCENCUS,
                            CUS1.DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT
                        --ANÁLITICO FIM

)
WHERE 
(
(:P_DTENTSAI = '2' AND DTENTSAI BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
OR
(:P_DTENTSAI = '1' AND DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)

)

AND CODCENCUS = :A_CODCENCUS
)

GROUP BY CODNAT,DESCRNAT,AD_VENDEDOR_RESP
ORDER BY 2]]></expression>
          <metadata>
            <field name="CODNAT" label="Cód. Nat." type="I" visible="true" useFooter="false"/>
            <field name="DESCRNAT" label="Natureza" type="S" visible="true" useFooter="false"/>
            <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
            </field>
            <field name="PERC" label="%" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          </metadata>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_ai7ew9s" description="TESTE">
    <container orientacao="V" tamanhoRelativo="100">
      <container orientacao="H" tamanhoRelativo="50">
        <grid id="grd_qifqrk" useNewGrid="S">
          <args>
            <arg id="A_CODVEND" type="integer"/>
          </args>
          <title><![CDATA[<b>Detalhamento por Natureza</b>]]></title>
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND,

CODNAT,

DESCRNAT,

SUM(VLRDESP) VLRDESP,

SUM(CASE WHEN VLRREAL = 0 THEN 0 ELSE VLRDESP / NULLIF(VLRREAL,0)*-1*100 END) AS PERC_VLR



FROM

(

WITH CUS4 AS



(

SELECT
CODNAT,DESCRNAT,AD_VENDEDOR_RESP,SUM(VLRDESP) AS VLRDESP
FROM
(

SELECT


NVL(DHBAIXA,DTENTSAI) DATA

,AD_VENDEDOR_RESP

,CODCENCUS

,DESCRCENCUS

,GRAU

,ANALITICO

,CODNAT

,DESCRNAT

,VLRDESDOB_REC

,VLRDESDOB_DESP

,VLRDESDOB

,VLRJURO

,VLRMULTA

,VLRDESC

,VLRBAIXA_REC

,VLRBAIXA_DESP

,VLRBAIXA

,VLRREC

,VLRDESP

FROM(


SELECT 
X.DTENTSAI

,X.DHBAIXA

, NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP

,CUS1.CODCENCUS

,CASE WHEN CUS1.GRAU=2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS

WHEN CUS1.GRAU=3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS

WHEN CUS1.GRAU=4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS

WHEN CUS1.GRAU=5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS

ELSE CUS1.GRAU||'_'||CUS1.DESCRCENCUS END AS DESCRCENCUS

,CUS1.GRAU

,CUS1.ANALITICO

,X.CODNAT

,X.DESCRNAT

,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_REC

,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_DESP

,NVL(SUM(X.VLRDESDOB),0) AS VLRDESDOB

,NVL(SUM(X.VLRJURO),0) AS VLRJURO

,NVL(SUM(X.VLRMULTA),0) AS VLRMULTA

,NVL(SUM(X.VLRDESC),0) AS VLRDESC

,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_REC

,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_DESP

,NVL(SUM(X.VLRBAIXA),0) AS VLRBAIXA

,NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 

		WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 

		ELSE 0 END),0) AS VLRREC

,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 

		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 

		ELSE 0 END),0) AS VLRDESP

FROM TSICUS CUS1

LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS

INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT



WHERE



((

    (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

    OR

    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

    OR

    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
    AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
    )
    
    /* VERSAO VELHA    
    AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
    */

    

)

OR

( (

    X.RECDESP IN (1,0,-1)

    AND X.PROVISAO = 'N' 

    AND X.CODNAT <> 2020202 

    AND X.NUNOTA IN (

        SELECT NUNOTA 

        FROM TGFCAB CAB

        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)

        WHERE

            TOP.ATUALEST <> 'N'

            AND CAB.TIPMOV IN ('V','D')

            AND CAB.STATUSNOTA='L'

            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)

            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )

		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

  )

OR

    X.RECDESP IN (1)

    AND X.PROVISAO = 'N' 

    AND X.CODNAT <> 1010000

/*VERSAO ANTIGA
    AND(X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
*/

/*VERSAO NOVA*/
AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)

    

))

AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)

AND (X.CODNAT IN :P_NATUREZA)

/*

AND X.CODCENCUS IN :CR AND X.CODCENCUS <> 0 AND (X.RECDESP=:P_RECDESP OR :P_RECDESP = 0)

AND (X.CODCENCUS >= :P_CRINI OR :P_CRINI IS NULL)

AND (X.CODCENCUS < :P_CRFIN OR :P_CRFIN IS NULL)

AND (X.CODNAT <> :NATDIF OR :NATDIF IS NULL)

AND ( (X.CODNAT IN (SELECT CODNAT FROM TGFNAT WHERE AD_CUSTOFIXO = 'S') AND :P_CUSFIXO='S') OR :P_CUSFIXO='N' )

*/

AND X.CODCENCUS LIKE '9%'



GROUP BY
X.DTENTSAI

,X.DHBAIXA

,NVL(CUS1.AD_VENDEDOR_RESP,0)

,CUS1.CODCENCUS

,CUS1.DESCRCENCUS

,CUS1.GRAU

,CUS1.ANALITICO

,X.CODNAT

,X.DESCRNAT
)
WHERE 
(
(:P_DTENTSAI = 2 AND DTENTSAI BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
OR
(:P_DTENTSAI = 1 AND DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
)

)



GROUP BY AD_VENDEDOR_RESP,CODNAT,DESCRNAT

)



SELECT 

A.CODVEND

, APELIDO

, CODNAT

, DESCRNAT

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(QTDPREV * PRECOLT)  AS VLR_PREV

, SUM(VLRREAL) AS VLRREAL

, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 100 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR

, NVL(CUS4.VLRDESP,0) AS VLRDESP

FROM

(

SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

WHERE MET.CODMETA = :P_CODMETA

AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')

AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)



GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)







)A

INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND

LEFT JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC

LEFT JOIN CUS4 ON A.CODVEND = CUS4.AD_VENDEDOR_RESP

WHERE

(VEN.CODVEND IN :P_CODVEND)

AND (VEN.CODGER IN :P_COORD)

AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (A.MARCA IN :P_MARCA)



GROUP BY A.CODVEND, APELIDO,CODNAT,DESCRNAT,NVL(CUS4.VLRDESP,0)

)

WHERE CODVEND <> 0 
AND CODVEND = :A_CODVEND
AND
(
	/*CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR */(SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)

GROUP BY CODVEND,CODNAT,DESCRNAT
ORDER BY 2]]></expression>
          <metadata>
            <field name="CODVEND" label="CODVEND" type="I" visible="false" useFooter="false"/>
            <field name="CODNAT" label="Cód. Nat." type="I" visible="true" useFooter="false"/>
            <field name="DESCRNAT" label="Natureza" type="S" visible="true" useFooter="false"/>
            <field name="VLRDESP" label="Vlr. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00">
              <formatter lessThan="0"><![CDATA[<span style="color:#FF0000">$VALUE</span>]]></formatter>
            </field>
            <field name="PERC_VLR" label="%" type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
          </metadata>
        </grid>
      </container>
      <container orientacao="V" tamanhoRelativo="50">
        <grid id="grd_ai7exc2" useNewGrid="S">
          <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND

, APELIDO

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

	AND (X.CODVEND IN :P_CODVEND)

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

    CODVEND,

    APELIDO

ORDER BY QTDREAL DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
          <metadata>
            <field name="CODVEND" label="CODVEND" type="F" visible="true" useFooter="false"/>
            <field name="APELIDO" label="APELIDO" type="S" visible="true" useFooter="false"/>
            <field name="APELIDO_PERC" label="APELIDO_PERC" type="S" visible="true" useFooter="false"/>
            <field name="APELIDO_PERC_VLR" label="APELIDO_PERC_VLR" type="S" visible="true" useFooter="false"/>
            <field name="QTDPREV" label="QTDPREV" type="F" visible="true" useFooter="false"/>
            <field name="QTDREAL" label="QTDREAL" type="F" visible="true" useFooter="false"/>
            <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false"/>
            <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false"/>
            <field name="PERC" label="PERC" type="F" visible="true" useFooter="false"/>
            <field name="PERC_VLR" label="PERC_VLR" type="F" visible="true" useFooter="false"/>
          </metadata>
        </grid>
      </container>
    </container>
  </level>
  <level id="lvl_a6aky8" description="Max_Graf1_Nivel_1">
    <container orientacao="V" tamanhoRelativo="100">
      <chart id="cht_a6ak2k" type="column" nroColuna="10">
        <title><![CDATA[<b>TOP 10 Vendedores - Volume</b>]]></title>
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND

, APELIDO

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END,'9,999.99')||'%' AS APELIDO_PERC

, SUBSTR(APELIDO,1,15) ||' - '|| TO_CHAR(CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END,'9,999.99')||'%' AS APELIDO_PERC_VLR

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, SUM(VLR_PREV)  AS VLR_PREV

, SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 0 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, CASE WHEN SUM(VLR_PREV) = 0 THEN 0 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR

FROM

(

SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(NVL(VLR_PREV,0)) AS VLR_PREV,

SUM(NVL(VLR_REAL, 0)) AS VLR_REAL

FROM(



SELECT

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD,

	SUM(QTDPREV) AS QTDPREV,

	SUM(QTDREAL) AS QTDREAL,

	SUM(QTDPREV * PRECOLT) AS VLR_PREV,

	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(	

SELECT

MET.CODMETA,

MET.DTREF, 

VEN.CODVEND,

VEN.APELIDO,

VEN.AD_VENDEDOR_MATRIZ,

NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,VEN.CODVEND,VEN.APELIDO,VEN.AD_VENDEDOR_MATRIZ,NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)

)X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA

	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')

	AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)

	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

/*	AND (X.CODVEND IN :P_CODVEND)*/

	AND (X.CODGER IN :P_COORD)

	AND (X.MARCA IN :P_MARCA)

	AND

	(

	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)

	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 

)

	GROUP BY

	X.DTREF,

	X.CODMETA,

	VEN1.CODVEND,

	VEN1.APELIDO,

	VEN1.CODGER,

	X.CODPARC,

	X.PARCEIRO,

	X.MARCA,

	X.CODGRUPOPROD	

)

GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)

GROUP BY

CODVEND

, APELIDO

ORDER BY 6 DESC

FETCH FIRST 10 ROWS ONLY]]></expression>
        <metadata>
          <field name="CODVEND" label="CODVEND" type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="APELIDO_PERC" label="Vendedor e % Atingido Meta Qtd." type="S" visible="true" useFooter="false"/>
          <field name="APELIDO_PERC_VLR" label="APELIDO_PERC_VLR" type="S" visible="true" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="VLR_PREV" label="VLR_PREV" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="VLR_REAL" label="VLR_REAL" type="F" visible="true" useFooter="false" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false"/>
        </metadata>
        <series>
          <serie type="undefined"/>
          <serie type="undefined"/>
        </series>
      </chart>
    </container>
  </level>
  <level id="lvl_oygv47" description="Custos Regionais">
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_oygv8q" useNewGrid="S">
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT

CODVEND,
APELIDO,
CODCENCUS,
DESCRCENCUS,
SUM(VLRDESP) VLRDESP,
SUM(AJUD_CUSTO) AJUD_CUSTO
, SUM(JUL_VAR) JUL_VAR
, SUM(JUL_AJU) JUL_AJU
, SUM(AGO_VAR) AGO_VAR
, SUM(AGO_AJU) AGO_AJU
, SUM(SEP_VAR) SEP_VAR
, SUM(SEP_AJU) SEP_AJU
, SUM(OCT_VAR) OCT_VAR
, SUM(OCT_AJU) OCT_AJU
, SUM(NOV_VAR) NOV_VAR
, SUM(NOV_AJU) NOV_AJU
, SUM(DEZ_VAR) DEZ_VAR
, SUM(DEZ_AJU) DEZ_AJU
, SUM(JAN_VAR) JAN_VAR
, SUM(JAN_AJU) JAN_AJU
, SUM(FEV_VAR) FEV_VAR
, SUM(FEV_AJU) FEV_AJU
, SUM(MAR_VAR) MAR_VAR
, SUM(MAR_AJU) MAR_AJU
, SUM(ABR_VAR) ABR_VAR
, SUM(ABR_AJU) ABR_AJU
, SUM(MAI_VAR) MAI_VAR
, SUM(MAI_AJU) MAI_AJU
, SUM(JUN_VAR) JUN_VAR
, SUM(JUN_AJU) JUN_AJU

FROM (


SELECT

CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(V.AD_VENDEDOR_MATRIZ, V.CODVEND) ELSE V.CODVEND END AS CODVEND,
CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(VEN1.APELIDO, V.APELIDO) ELSE V.APELIDO END AS APELIDO,

V.CODCENCUS,

V.DESCRCENCUS,

SUM(V.VLRDESP)VLRDESP,

SUM(V.AJUD_CUSTO)AJUD_CUSTO

, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 6), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) JUL_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 6), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) JUL_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 7), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) AGO_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 7), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) AGO_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 8), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) SEP_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 8), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) SEP_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 9), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) OCT_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 9), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) OCT_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 10), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) NOV_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 10), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) NOV_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 11), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) DEZ_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 11), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) DEZ_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 0), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) JAN_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 0), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) JAN_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 1), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) FEV_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 1), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) FEV_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 2), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) MAR_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 2), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) MAR_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 3), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) ABR_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 3), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) ABR_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 4), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) MAI_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 4), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) MAI_AJU
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 5), 'YYYY-MM') THEN V.VLRDESP ELSE 0 END) JUN_VAR
, SUM(CASE WHEN TO_CHAR(V.DATA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(TRUNC(V.DATA, 'YEAR'), 5), 'YYYY-MM') THEN V.AJUD_CUSTO ELSE 0 END) JUN_AJU
FROM

(

WITH CUS4 AS



(

SELECT
DATA,AD_VENDEDOR_RESP,CODCENCUS,DESCRCENCUS,


SUM(CASE WHEN CODNAT <> 3030202 THEN VLRDESP ELSE 0  END) AS VLRDESP,
SUM(CASE WHEN CODNAT = 3030202 THEN VLRDESP ELSE 0  END) AJUD_CUSTO
FROM
(

SELECT


CASE WHEN :P_DTENTSAI = '1' THEN DHBAIXA WHEN :P_DTENTSAI = '2' THEN DTENTSAI END AS DATA

,AD_VENDEDOR_RESP

,CODCENCUS

,DESCRCENCUS

,GRAU

,ANALITICO

,CODNAT

,DESCRNAT

,VLRDESDOB_REC

,VLRDESDOB_DESP

,VLRDESDOB

,VLRJURO

,VLRMULTA

,VLRDESC

,VLRBAIXA_REC

,VLRBAIXA_DESP

,VLRBAIXA

,VLRREC

,VLRDESP



FROM(






                        --ANÁLITICO INICIO
                        SELECT 
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0) AS AD_VENDEDOR_RESP,
                            CUS1.CODCENCUS,
                            CASE 
                                WHEN CUS1.GRAU = 2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS
                                WHEN CUS1.GRAU = 5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS
                                ELSE CUS1.GRAU || '_' || CUS1.DESCRCENCUS 
                            END AS DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END), 0) AS VLRDESDOB_DESP,
                            NVL(SUM(X.VLRDESDOB), 0) AS VLRDESDOB,
                            NVL(SUM(X.VLRJURO), 0) AS VLRJURO,
                            NVL(SUM(X.VLRMULTA), 0) AS VLRMULTA,
                            NVL(SUM(X.VLRDESC), 0) AS VLRDESC,
                            NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_REC,
                            NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END), 0) AS VLRBAIXA_DESP,
                            NVL(SUM(X.VLRBAIXA), 0) AS VLRBAIXA,
                            NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRREC,
                            NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1, 0) THEN X.VLRDESDOB 
                                WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 
                                ELSE 0 END), 0) AS VLRDESP
                        FROM TSICUS CUS1
                        LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS = CUS1.CODCENCUS
                        LEFT JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT
                        WHERE 

                        ((:P_DADOS_FIN = 'S' AND

                        (
                            --TRATATIVA ESPECIFICA PARA COMISSÕES
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR DIFERENTE DE P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES PROVISIONADAS)
                                (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                                OR
                                --FILTRAR PELA DATA DE NEGOCIAÇÃO (CR IGUAL A P&D E DIF. DE RECEITA E NATUREZA DE COMISSÕES REAIS)
                                (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                            OR
                            --TRATATIVA PARA LANÇAMENTOS DIFERENTES DE COMISSÕES E RECEITA DE VENDAS
                                --FILTRAR PELA DATA DE BAIXA (APENAS DESPESAS COM NATUREZA DIFERENTE DE COMISSÕES E RECEITA DE VENDAS)
                                (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
                                AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))
                        )) OR :P_DADOS_FIN = 'N')


                        --DESCONSIDERA MOVIMENTOS RELACIONADOS AO FATURAMENTO (RECEITA E DEVOLUÇÃO DE VENDAS) POIS ESSES VALORES VEM DA VIEW DE VENDAS
                        --DESCONSIDERA MOVIMENTOS RELACIONADOS A ANTECIPAÇÕES (ADIANTAMENTO/CRÉDITO)
                        AND X.CODNAT NOT IN (1010000, 1020000, 6010100, 6010200)
                        --CONSIDERA APENAS CR COMERCIAL, PORÉM ISSO ANULA O FILTRO DE COMISSÕES DO C.R P&D
                        AND X.CODCENCUS LIKE '9%'
                        AND X.PROVISAO = 'N'
                        AND X.VLRBAIXA <> 0
                        --PARAMETRO INPUTADO PELO USUÁRIO
                        AND (X.CODNAT IN :P_NATUREZA)
                        

                        GROUP BY
                            X.PROVISAO,
                            X.NUFIN,
                            X.DTENTSAI,
                            X.DHBAIXA,
                            NVL(CUS1.AD_VENDEDOR_RESP, 0),
                            CUS1.CODCENCUS,
                            CUS1.DESCRCENCUS,
                            CUS1.GRAU,
                            CUS1.ANALITICO,
                            CUS1.AD_APELIDO,
                            X.CODNAT,
                            X.DESCRNAT
                        --ANÁLITICO FIM










)
WHERE 
(
(:P_DTENTSAI = 2 AND DTENTSAI BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
OR
(:P_DTENTSAI = 1 AND DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)
)

)



GROUP BY DATA,AD_VENDEDOR_RESP,CODCENCUS,DESCRCENCUS

)



SELECT 

CUS4.DATA

, A.CODVEND

, AD_VENDEDOR_MATRIZ

, APELIDO

, CUS4.CODCENCUS

, CUS4.DESCRCENCUS

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(QTDPREV * PRECOLT)  AS VLR_PREV

, SUM(VLRREAL) AS VLRREAL

, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 100 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR

, NVL(CUS4.VLRDESP,0) AS VLRDESP

, NVL(CUS4.AJUD_CUSTO,0) AS AJUD_CUSTO

FROM

(

SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

WHERE MET.CODMETA = :P_CODMETA

AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')

AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)



GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)







)A

INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND

LEFT JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC

LEFT JOIN CUS4 ON A.CODVEND = CUS4.AD_VENDEDOR_RESP

WHERE

(VEN.CODVEND IN :P_CODVEND)

AND (VEN.CODGER IN :P_COORD)

AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (A.MARCA IN :P_MARCA)



GROUP BY CUS4.DATA , A.CODVEND, APELIDO,CUS4.CODCENCUS, CUS4.DESCRCENCUS,NVL(CUS4.VLRDESP,0),NVL(CUS4.AJUD_CUSTO,0),AD_VENDEDOR_MATRIZ

) V

LEFT JOIN TGFVEN VEN1 ON VEN1.CODVEND = V.AD_VENDEDOR_MATRIZ  

WHERE  
V.CODCENCUS IS NOT NULL
AND

(
	/*CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR */(SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)

GROUP BY V.CODVEND,V.APELIDO,V.CODCENCUS,V.DESCRCENCUS,V.AD_VENDEDOR_MATRIZ,VEN1.APELIDO
)

GROUP BY CODVEND,APELIDO,CODCENCUS,DESCRCENCUS

ORDER BY 2]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="CODCENCUS" label="Cód. CR" type="I" visible="true" useFooter="false"/>
          <field name="DESCRCENCUS" label="Descr. CR" type="S" visible="true" useFooter="false"/>
          <field name="VLRDESP" label="Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="AJUD_CUSTO" label="Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="JUL_VAR" label="JUL Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="JUL_AJU" label="JUL Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="AGO_VAR" label="AGO Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="AGO_AJU" label="AGO Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="SEP_VAR" label="SET Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="SEP_AJU" label="SET Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="OCT_VAR" label="OUT Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="OCT_AJU" label="OUT Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="NOV_VAR" label="NOV Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="NOV_AJU" label="NOV Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="DEZ_VAR" label="DEZ Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="DEZ_AJU" label="DEZ Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="JAN_VAR" label="JAN Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="JAN_AJU" label="JAN Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="FEV_VAR" label="FEV Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="FEV_AJU" label="FEV Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="MAR_VAR" label="MAR Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="MAR_AJU" label="MAR Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="ABR_VAR" label="ABR Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="ABR_AJU" label="ABR Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="MAI_VAR" label="MAI Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="MAI_AJU" label="MAI Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="JUN_VAR" label="JUN Variáveis" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="JUN_AJU" label="JUN Ajud. Custo" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_axj9hi0" description="Nível5_Geral">
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_axj9hku" entityName="MetaAtual" useNewGrid="S">
        <expression type="sql" data-source="MGEDS"><![CDATA[WITH BASE AS (
    SELECT 
        DTREF,
        CODVEND,
        APELIDO,
        CODPARC,
        PARCEIRO,
        MARCA,
        CODMETA,
        SUM(QTDPREV) AS QTDPREV,
        SUM(QTDREAL) AS QTDREAL,
        CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC,
        SUM(VLR_PREV)  AS VLR_PREV,
        SUM(VLR_REAL) AS VLR_REAL,
        CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR
    FROM (

        SELECT
            X.DTREF,
            X.CODMETA,
            VEN1.CODVEND,
            VEN1.APELIDO,
            VEN1.CODGER,
            X.CODPARC,
            X.PARCEIRO,
            X.MARCA,
            X.CODGRUPOPROD,
            SUM(QTDPREV) AS QTDPREV,
            SUM(QTDREAL) AS QTDREAL,
            SUM(QTDPREV * PRECOLT) AS VLR_PREV,
            SUM(NVL(VLRREAL, 0)) AS VLR_REAL
        FROM (
            SELECT 
                MET.CODMETA,
                MET.DTREF, 
                VEN.CODVEND,
                VEN.APELIDO,
                VEN.AD_VENDEDOR_MATRIZ,
                NVL(VEN.CODGER,0) AS CODGER,
                NVL(MET.CODPARC,0) AS CODPARC,
                NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
                NVL(MET.MARCA,0) AS MARCA,
                NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,
                NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
                NVL(MET.QTDPREV,0) AS QTDPREV, 
                SUM(NVL(VGF.QTD,0)) AS QTDREAL,
                NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
                SUM(NVL(VGF.VLR,0)) AS VLRREAL
            FROM TGFMET MET
            LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
            LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
            LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
            LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND
            GROUP BY MET.CODMETA,MET.DTREF,
                     VEN.CODVEND, VEN.APELIDO, VEN.AD_VENDEDOR_MATRIZ,
                     NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),
                     NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0),
                     NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
        ) X
        LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND
        WHERE 
            X.CODMETA = :P_CODMETA
            AND X.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN
            AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <> 0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
            AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
            AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
            AND (X.CODVEND IN :P_CODVEND) 
            AND (X.CODGER IN :P_COORD)
            AND (X.MARCA IN :P_MARCA)
            AND (
                X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
                OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
                OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
                OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
            )
        GROUP BY
            X.DTREF, X.CODMETA, VEN1.CODVEND, VEN1.APELIDO, VEN1.CODGER,
            X.CODPARC, X.PARCEIRO, X.MARCA, X.CODGRUPOPROD
    )
    GROUP BY CODVEND, APELIDO, DTREF, CODPARC, PARCEIRO, MARCA, CODMETA
),

TOTAL_VENDEDOR AS (
    SELECT 
        CODVEND,
        APELIDO,
        NULL AS DTREF,
        NULL AS CODPARC,
        NULL AS PARCEIRO,
        'RESUMO VENDEDOR' AS MARCA,
        NULL AS CODMETA,
        SUM(QTDPREV) AS QTDPREV,
        SUM(QTDREAL) AS QTDREAL,
        CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC,
        SUM(VLR_PREV) AS VLR_PREV,
        SUM(VLR_REAL) AS VLR_REAL,
        CASE WHEN SUM(VLR_PREV) = 0 THEN 100 ELSE NVL(SUM(VLR_REAL) * 100 / NULLIF(SUM(VLR_PREV), 0), 0) END AS PERC_VLR,
        'TOTAL' AS TOTAL
    FROM BASE
    GROUP BY CODVEND, APELIDO
),

GERAL AS (
    SELECT 
        CODVEND, APELIDO, DTREF, CODPARC, PARCEIRO, MARCA, CODMETA,
        QTDPREV, QTDREAL, PERC, VLR_PREV, VLR_REAL, PERC_VLR,
        'DETALHE' AS TOTAL
    FROM BASE
)

-- União final com nomes de campos explícitos
SELECT 
    CODVEND,
    APELIDO,
    DTREF,
    CODPARC,
    PARCEIRO,
    MARCA,
    CODMETA,
    QTDPREV,
    QTDREAL,
    PERC,
    VLR_PREV,   
    VLR_REAL,
    PERC_VLR,
    TOTAL,
 '#99cc99' AS BKCOLOR,
'Black' AS FGCOLOR
FROM TOTAL_VENDEDOR

UNION ALL

SELECT 
    CODVEND,
    APELIDO,    
    DTREF,
    CODPARC,
    PARCEIRO,
    MARCA,
    CODMETA,
    QTDPREV,
    QTDREAL,
    PERC,
    VLR_PREV,
    VLR_REAL,
    PERC_VLR,
    TOTAL,
    NULL AS BKCOLOR,
    NULL AS FGCOLOR
FROM GERAL

ORDER BY CODVEND, TOTAL ASC, DTREF, CODPARC, MARCA DESC
]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="DTREF" label="Dt. Ref." type="D" visible="true" useFooter="false"/>
          <field name="CODPARC" label="Cód. Parc." type="I" visible="true" useFooter="false"/>
          <field name="PARCEIRO" label="Parceiro" type="S" visible="true" useFooter="false"/>
          <field name="MARCA" label="Marca" type="S" visible="true" useFooter="false"/>
          <field name="CODMETA" label="Cód. Met" type="I" visible="false" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC" label="% Qtd." type="F" visible="true" useFooter="false">
            <formatter lessEqualThan="40"><![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]></formatter>
            <formatter lessEqualThan="70"><![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]></formatter>
            <formatter greaterThan="90"><![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]></formatter>
            <formatter lessEqualThan="90"><![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]></formatter>
          </field>
          <field name="VLR_PREV" label="Vlr. Prev." type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="VLR_REAL" label="Vlr. Real" type="I" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="PERC_VLR" label="% Vlr." type="F" visible="true" useFooter="false">
            <formatter lessEqualThan="40"><![CDATA[<span style="color:#000000; src:iconFlagRed">$VALUE</span>]]></formatter>
            <formatter lessEqualThan="70"><![CDATA[<span style="color:#000000; src:iconFlagYellow">$VALUE</span>]]></formatter>
            <formatter lessEqualThan="90"><![CDATA[<span style="color:#000000; src:iconFlagBlue">$VALUE</span>]]></formatter>
            <formatter greaterThan="90"><![CDATA[<span style="color:#000000; src:iconFlagGreen">$VALUE</span>]]></formatter>
          </field>
          <field name="TOTAL" label="TOTAL" type="S" visible="false" useFooter="false"/>
          <field name="BKCOLOR" label="BKCOLOR" type="S" visible="true" useFooter="false"/>
          <field name="FGCOLOR" label="FGCOLOR" type="S" visible="true" useFooter="false"/>
        </metadata>
      </grid>
    </container>
  </level>
  <level id="lvl_1r1vr3" description="Vendedor por UF">
    <container orientacao="V" tamanhoRelativo="100">
      <grid id="grd_1r1vr4" useNewGrid="S">
        <expression type="sql" data-source="MGEDS"><![CDATA[SELECT CODVEND,APELIDO,UF,SUM(QTDPREV)QTDPREV,SUM(QTDREAL)QTDREAL,SUM(VLR_PREV)VLRPREV,SUM(VLR_REAL)VLRREAL
FROM(

	SELECT
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
	X.UF,
	SUM(QTDPREV) AS QTDPREV,
	SUM(QTDREAL) AS QTDREAL,
	SUM(QTDPREV * PRECOLT) AS VLR_PREV,
	SUM(NVL(VLRREAL, 0)) AS VLR_REAL

	FROM(

		SELECT MET.CODMETA,
		MET.DTREF, 
		VEN.CODVEND,
		VEN.APELIDO,
		VEN.AD_VENDEDOR_MATRIZ,
		NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC,
		NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 
		NVL(MET.MARCA,0) AS MARCA,
		NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)) AS CODGRUPOPROD,
		NVL(VGF.CODCENCUS,0) AS CODCENCUS, 
		NVL(MET.QTDPREV,0) AS QTDPREV, 
		SUM(NVL(VGF.QTD,0)) AS QTDREAL,
		NVL(PRC.VLRVENDALT,0)AS PRECOLT, 
		SUM(NVL(VGF.VLR,0)) AS VLRREAL,
		NVL(SUBSTR(VGF.UF, 1, 2),UFS.UF) AS UF

		FROM TGFMET MET

		LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'
		LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))
		LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC
        INNER JOIN TSICID CID ON PAR.CODCID = CID.CODCID
        INNER JOIN TSIUFS UFS ON CID.UF = UFS.CODUF

		LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

		GROUP BY MET.CODMETA,MET.DTREF,
		VEN.CODVEND, VEN.APELIDO, VEN.AD_VENDEDOR_MATRIZ,NVL(SUBSTR(VGF.UF, 1, 2),UFS.UF),
		NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,FN_GET_GRU_MARCA(MET.MARCA)),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)
	) X

	LEFT JOIN TGFVEN VEN1 ON CASE WHEN :VENDEDOR_MATRIZ = 'S' THEN NVL(X.AD_VENDEDOR_MATRIZ,X.CODVEND) ELSE X.CODVEND END = VEN1.CODVEND

	WHERE 

	X.CODMETA = :P_CODMETA
	AND X.DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN
	AND ((:P_NTEMMETA = 'S' AND (X.QTDPREV <> 0 OR X.QTDREAL <>  0 OR X.VLRREAL<>0)) OR :P_NTEMMETA = 'N')
    AND (X.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)
	AND (X.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
	AND (X.CODVEND IN :P_CODVEND) 
	AND (X.CODGER IN :P_COORD)
	AND (X.MARCA IN :P_MARCA)
	AND
	(
	X.CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR X.CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR (SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
    )
	GROUP BY
	X.DTREF,
	X.CODMETA,
	VEN1.CODVEND,
	VEN1.APELIDO,
	VEN1.CODGER,
	X.CODPARC,
	X.PARCEIRO,
	X.MARCA,
	X.CODGRUPOPROD,
    X.UF
)
GROUP BY CODVEND,APELIDO,UF]]></expression>
        <metadata>
          <field name="CODVEND" label="Cód. Vend." type="I" visible="true" useFooter="false"/>
          <field name="APELIDO" label="Vendedor" type="S" visible="true" useFooter="false"/>
          <field name="UF" label="UF" type="S" visible="true" useFooter="false"/>
          <field name="QTDPREV" label="Qtd. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="QTDREAL" label="Qtd. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="VLRPREV" label="Vlr. Prev." type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
          <field name="VLRREAL" label="Vlr. Real" type="F" visible="true" useFooter="SUM" mask="#.##0,00"/>
        </metadata>
      </grid>
    </container>
  </level>
</gadget>