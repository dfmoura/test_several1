
8:30 12:20
CRIAÇÃO DE FLAG TOP
INSERSAO DE CAMPO

CRIAÇAO DO DASH RENTABILIDADE E PUBLICAÇÃO
DIVISAO NIVEL PRINCIPAL EM DUAS PARTES
ONGANIZAÇÃO DE PARAMETRO PRINCIPAIS PARA O DASH
ORGANIZAÇÃO DO SELECT 
VLRFAT - OK
GRUPO PRODUTOS - feito o select para obter o grupo pai.
PRE FORMATAÇÃO DAS CORES DAS COLUNAS NA PRIMEIRA TABELA DO NIVE PRICIPAL
arrumar o titulo DAS COLUNAS da primeira tabela


13 as 15:40 
ADICIONAR O GRAFICO DE RENTABILIDADE PARA A PRIMEIRA TABELA E JA CONFIGURAR OS ARGUMENTOS
AJUSTAR EVENTO DE ATUALIZAÇÃO NA TABELA PARA RESPONDER AO GRAFICO DE RENTABILIDADE.
SEGUIR EXECUÇÃO DA COLUNA QUE BUSCA O KG
	fazendo a vericação de quando nao for kg consultar
	aplicado o kg e o ton no dash

iniciado a execução do custo
de 16 ate 19	
-----------------------------------


1 paragrafo) 8:30 as 12:20
2 paragrafo) 13:30 16:30
3 paragrafo) 19:00 as 21
criacao de view com todos os dados para montar o dash envolvendo, faturamento, devoluções,custos,volumes,impostos e margem bruta.


----------------
07/08/2025
8:30 as 11:00 
moldagem do laytou principal com replicação do existente, deixando somente o html e o css.
ajuste na escrita do card de volume de HL para KG


----------
12:10 as 16:00 
Deixar o head colado no top da tela.
	atualizar o layout do header 
	semelhante ao que foi utilizado no fixed-header do arquivo prod35.jsp



retirar o este html e css correspondente:
    <div class="header-actions">
      <!-- Campo de usuário atual -->
      <div id="usuario-info" class="text-white text-xs mr-4 px-3 py-1 bg-white bg-opacity-20 rounded border border-white border-opacity-30">
        <i class="fas fa-user mr-1"></i>
        <span id="usuario-display">Carregando usuário...</span>
      </div>
    </div>


deixar o 'Rentabilidade Financeira 2.0' centralizado

para o Fixed Header mutar o verde para o mesmo azul dos cards


para o select da view fazer o primeiro card faturamento periodo atual e anterior e variação

--->
select 
    sum(case when dtneg between '01/08/2025' and '31/08/2025' then totalliq else 0 end) as totalliq_atual,
    sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
    and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end) as totalliq_anterior,
    case 
        when sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
        and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end) = 0 then null
        else round(((sum(case when dtneg between '01/08/2025' and '31/08/2025' then totalliq else 0 end) - 
          sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
          and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end)) * 100.0 / 
         sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
         and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end)), 2)
    end as variacao_percentual
from vw_rentabilidade_aco 
where tipmov = 'V' and ATIVO_TOP = 'S' and AD_COMPOE_FAT = 'S'

prod6.jsp = colocar este select no jsp. 


nesta parte do codigo:

</div>
<h1>Faturamento</h1>
<p>Faturamento</p>
</div>
<div class="card-footer text-muted">
<b>Per. Ant.:</b> 0 <b>Var.%:</b> 0
</div>


de acordo com o select a seguir preencher as partes:
<p>Faturamento</p>
<b>Per. Ant.:</b> 0 <b>Var.%:</b> 0


utilizar o arquivo prod35.jsp pois ele possui uma implementação do metodo JX.consultar da biblioteca SankhyaJX
e pode auxiliar no processo


select para utilizar
select 
    sum(case when dtneg between '01/08/2025' and '31/08/2025' then totalliq else 0 end) as totalliq_atual,
    sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
    and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end) as totalliq_anterior,
    case 
        when sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
        and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end) = 0 then null
        else round(((sum(case when dtneg between '01/08/2025' and '31/08/2025' then totalliq else 0 end) - 
          sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
          and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end)) * 100.0 / 
         sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
         and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end)), 2)
    end as variacao_percentual
from vw_rentabilidade_aco 
where tipmov = 'V' and ATIVO_TOP = 'S' and AD_COMPOE_FAT = 'S'


----------------

16:20 20:00

sem estragar os dados e o codigo
retirar este html do codigo e o css js relacionado sem comprometar nada:

    <div class="header-buttons">
      <button onclick="atualizarDadosFaturamento()" class="header-btn" title="Atualizar Dados">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>

----



sem estragar os dados e o codigo:
organizar o codigo para a seta para cima verde quando maior igual a zero e seta para baixo vermelha quando menor que zero
deixar o layout css e script js no padrao 

sem comprometer nada do codigo.


-----

sem estragar os dados e o codigo:
a seta ficou muito grande desproporcional aos outros registros
sem comprometer nada do codigo

----------------------



sem estragar os dados e o codigo:

sem estragar o codigo criar campos de filtro de data em alguma parte da tela, 

as datas estao em 'DD/MM/YYYY'
      

de modo a nao comprometer o layout
este filtro ira atuar diretamente nos pontos de data da query que nao estao dinamicos


      const sql = `
        select 
            sum(case when dtneg between '01/08/2025' and '31/08/2025' then totalliq else 0 end) as totalliq_atual,
            sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
            and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end) as totalliq_anterior,
            case 
                when sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
                and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end) = 0 then null
                else round(((sum(case when dtneg between '01/08/2025' and '31/08/2025' then totalliq else 0 end) - 
                  sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
                  and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end)) * 100.0 / 
                 sum(case when dtneg between DATEADD(month, -1, '01/08/2025') 
                 and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then totalliq else 0 end)), 2)
            end as variacao_percentual
        from vw_rentabilidade_aco 
        where tipmov = 'V' and ATIVO_TOP = 'S' and AD_COMPOE_FAT = 'S'
      `;




----------------------
20:30 as 22:00



prod16.jsp

sem estragar os dados e o codigo:
melhorar o layout do filtro de datas para ficar fixo, colocar debaixo rente ao 'header fixo', utilizando toda extensão da tela


tentar utilizar como modelo o jeito que foi feito o layout dos filtros no arquivo prod35.jsp

cuidado, so mexer no layout.

nao deu certo ainda, ja fiz varias tentativas

------------------------------------
prod17.jsp

sem estragar os dados e o codigo:


criar um multi-list para pesquisar a empresa, colocar lado direito do filtro de datas,
para interagir no where da query feita


SELECT 
    EMP.CODEMP AS VALUE,
    CAST(EMP.CODEMP AS VARCHAR) + ' - ' + EMP.RAZAOSOCIAL AS LABEL
FROM TSIEMP EMP
GROUP BY
    EMP.CODEMP,
    EMP.RAZAOSOCIAL
ORDER BY EMP.CODEMP

--------------------------------------
prod18.jsp
sem estragar o codigo
deixar o filtro de empresa mais moderno,
tem um exemplo de filtro de parceiro no arquivo prod35.jsp
verificar para adaptar no de empresa, lembrando que tem que manter multilist
muita atenção para nao estragar o codigo



---------
08/08/2025

8:40 - 12:20

sem estragar o codigo,
o seletor de datas esta apresentando as datas depois de escolher como  MM/DD/YYYY, sem comprometer nada no 
script configurar para ficar DD/MM/YYYY 

cuidado com as partes que precisam desta informação no codigo
cuidado para nao ficar travado em uma data e nao tem como usar o seletor nem editar a data



---------
sem estragar o codigo:

adequar o que foi feito para obter os datos no card de Faturamento para os card de: Desconto

---------------
prod21.jsp
sem estragar o codigo:
verificar o que foi feito obter os dados do card de Faturamento e Desconto, pois ocorreu uma repetição de codigo,
tudo funcionou perfeitamente,
gostaria de verificar uma otimização neste ponto,
sem estragar nada.

---------------
prod22.jsp
sem estragar o codigo:
replicar o que foi feito no card de Faturamento para o card de Devolução utilizando o campo VLRDEV
muita atenção para nao estragar nada no codigo


select
SUM(KG)KG,SUM(VLRDEV)VLRDEV,SUM(VLRDESC)VLRDESC,SUM(CUSREP_TOT)CUSREP_TOT, SUM(VLRIPI+VLRSUBST+VLRICMS+VLRPIS+VLRCOFINS) VLRIMP
from vw_rentabilidade_aco 
-----------------------
13:30 as 16:00
16:20 as 19:30
prod23.jsp

sem estragar o codigo:
replicar o que foi feito no card de Faturamento e Desconto,  para o card de TON utilizando o campo TON para utilizar na query
muita atenção para nao estragar nada no codigo

----


sem estragar o codigo:
replicar o que foi feito no card de Faturamento e Desconto,  para o card de CMV utilizando o campo CUSREP_TOT para utilizar na query
muita atenção para nao estragar nada no codigo

----


sem estragar o codigo:
replicar o que foi feito no card de Faturamento e Desconto,  
para o card de CMV utilizando o campo CUSREP_TOT para utilizar na query
muita atenção para nao estragar nada no codigo

-------------------
prod25.jsp
sem estragar o codigo:
replicar o que foi feito no card de Faturamento e Desconto,  
para o card de IMPOSTOS utilizando os campo (VLRIPI+VLRSUBST+VLRICMS+VLRPIS+VLRCOFINS)  para utilizar na query
*obs: nos outros foi informado somente um campo, agora tem estes campos somados...
muita atenção para nao estragar nada no codigo


-------------------

PROD26.JSP
sem estragar o codigo:
replicar o que foi feito no card de Faturamento e Desconto,  
para o card de Margem de Contribuição Nominal utilizando o campo MARGEMNOM para utilizar na query
muita atenção para nao estragar nada no codigo


-----
PROD27.JSP
sem estragar o codigo:
para o card TON verificar todo codigo relacionado, pois esta apresentando os valores com 'R$',
retirar este 'R$'

sem estragar nada do codigo muito cuidado



-----
09/08/2025 

7:30 as 10:00

sem estragar o codigo:
replicar o que foi feito no card de Faturamento e Desconto,  
para o card 'Margem de Contribuição %' utilizando o campo PERCMARGEM para utilizar na query

IMPORTANTE VERIFIRICAR pois na query deve ser utilizado o avg ao inves do sum para este caso.

muita atenção para nao estragar nada no codigo


-----
09/08/2025 

7:30 as 9:30


prod29.jsp
sem estragar o codigo:
replicar o que foi feito no card de Faturamento e Desconto,  
para o card's de 'DDespesa Operacional' e 'Investimentos'  utilizando o campo VLRDO E VLRIN RESPECTIVAMENTE para utilizar SER UTILIZADO EM UMA NOVA query conforme listado abaixo:


select 
    sum(case when dhbaixa between '${dataInicioFormatada}' and '${dataFimFormatada}' then ${campo} else 0 end) as valor_atual,
    sum(case when dhbaixa between DATEADD(month, -1, '${dataInicioFormatada}') 
    and DATEADD(day, 30, DATEADD(month, -1, '${dataInicioFormatada}')) then ${campo} else 0 end) as valor_anterior,
    case 
        when sum(case when dhbaixa between DATEADD(month, -1, '${dataInicioFormatada}') 
        and DATEADD(day, 30, DATEADD(month, -1, '${dataInicioFormatada}')) then ${campo} else 0 end) = 0 then null
        else round(((sum(case when dhbaixa between '${dataInicioFormatada}' and '${dataFimFormatada}' then ${campo} else 0 end) - 
          sum(case when dhbaixa between DATEADD(month, -1, '${dataInicioFormatada}') 
          and DATEADD(day, 30, DATEADD(month, -1, '${dataInicioFormatada}')) then ${campo} else 0 end)) * 100.0 / 
         sum(case when dhbaixa between DATEADD(month, -1, '${dataInicioFormatada}') 
         and DATEADD(day, 30, DATEADD(month, -1, '${dataInicioFormatada}')) then ${campo} else 0 end)), 2)
    end as variacao_percentual

FROM TGFFIN FIN
INNER JOIN TGFNAT NAT ON FIN.CODNAT = NAT.CODNAT
WHERE 
FIN.RECDESP = -1 
AND NAT.ATIVA = 'S'
AND FIN.DHBAIXA IS NOT NULL ${filtroEmpresa}

importante ressalta que na query deve ter esta verificação para valor, de modo que tem que ser adaptado para o valor atual, valor anterior e variação:

case when NAT.AD_TIPOCUSTO <> 'N'   then 
COALESCE(ROUND(SUM(VLRBAIXA), 2), 0) * -1 end AS VLRDO,

case when NAT.AD_TIPOCUSTO = 'N' then 
COALESCE(ROUND(SUM(VLRBAIXA), 2), 0) * -1 end AS VLRINV


muita atenção para nao estragar nada no codigo


------------

16:00 as 20:00

sem estragar o codigo:

com base nos card's anteriores, calculando valor atual, valor anterior e variação, 
calcular o card 'Resultado'

no entanto, no card 'Resultado' o valor é obtido a partir de:

'Margem de Contribuição Nominal' - 'Despesa Operacional' - 'Investimentos'

utilar o que ja exite para facilitar

-------------------------
prod31.jsp
sem estragar o codigo, pois esta funcionando...
revisar o codigo para otimiza-lo da melhor forma possivel


------

prod32.jsp

sem estragar o codigo, pois esta funcionando...

colocar a função:

    function abrir_fat(){
        var params = '';
        var level = '02Y';
        openLevel(level, params);
    }


-----------

******* fazer ainda *************
verificar em todo codigo...
sugiro um ovelay inteligente, para demonstrar enquanto estiver carregando a os dados, para o usuario entender que esta processando...


-------------

prod33.jsp

sem estragar o codigo:
 limpar o arquivo das querys  fat_total, fat_tipo,cip_total, cip_produto, fat_ger, fat_produto

e colocar alguns dados direto no js

muito cuidado para nao estragar nada


-------------
prod34.jsp
sem estragar o codigo:
 limpar o arquivo das querys  motivo, tot_motivo,cidade,bairro,vendedor,motivo_prod,
e colocar alguns dados direto no js
muito cuidado para nao estragar nada

------
prod32_1.jsp

sem estragar o codigo 
o mesmo que foi feito na função abrir_fat faça para as demais funções de abrir no html e js 

muito cuidado para nao estragar nada....


-------------
prod35.jsp
sem estragar o codigo:
 limpar o arquivo das querys  tot_impostos,impostos,impostos_emp,impostos_tipo,impostos_produto
e colocar alguns dados direto no js
muito cuidado para nao estragar nada
------------------

prod36.jsp
sem estragar o codigo:
 limpar o arquivo das querys  custo_total_emp,custo_emp,custo_total_top,custo_top,custo_total,custo_tipo,custo_produto
e colocar alguns dados de exemplo direto no js (para preencher os componentes)
muito cuidado para nao estragar nada


------------------

prod37.jsp
sem estragar o codigo:
 limpar o arquivo das querys  hl_total, hl_tipo, hl_gerente, hl_cliente, hl_produto
e colocar alguns dados de exemplo direto no js (para preencher os componentes)
muito cuidado para nao estragar nada

***importante: onde estiver hl mudou para ton


------------------

prod38.jsp


sem estragar o codigo:
 limpar o arquivo das querys  desco_total, desc_tipo,desc_ger,desc_cli,desc_produto
e colocar alguns dados de exemplo direto no js (para preencher os componentes)
muito cuidado para nao estragar nada

------------------

prod39.jsp


sem estragar o codigo:
 limpar o arquivo das querys  mar_tot,mar_tipo,mar_ger,mar_cli,mar_prod
e colocar alguns dados de exemplo direto no java script (para preencher os componentes)
muito cuidado para nao estragar nada


------


prod40.jsp


sem estragar o codigo:
 limpar o arquivo das querys  mar_tot,mar_tipo,mar_ger,mar_cli,mar_prod
e colocar alguns dados de exemplo direto no js (para preencher os componentes)
muito cuidado para nao estragar nada

pode utilizar o arquivo prod39.jsp como exemplo


-------------------

prod41.jsp


sem estragar o codigo:
 limpar o arquivo das querys  do_total,do_emp,do_nat,do_cr,do_detalhe
e colocar alguns dados de exemplo direto no js (para preencher os componentes)
muito cuidado para nao estragar nada

pode utilizar o arquivo prod39.jsp como exemplo


-------------------

prod42.jsp

sem estragar o codigo:
 limpar o arquivo das querys  do_total,do_emp,do_nat,do_cr,do_detalhe
e colocar alguns dados de exemplo direto no js (para preencher os componentes)
muito cuidado para nao estragar nada

pode utilizar o arquivo prod39.jsp como exemplo


------------------
11/08/2025

8:40 as 12:30

13:50 as 16:30
17:00 as 19:30

prod33.jsp


sem estragar o codigo:


utilizar o metodo JXconsultar da biblioteca SankhyaJX (o arquivo prod32_1.jsp tem serve como exemplo) para popular com dados dinamicos o grafico de rosca 'Faturamento por Tipo de Produto' - doughnutChart

utilizar o select a seguir


WITH CTE AS (
    SELECT 
        descrgrupo_nivel1,
        SUM(totalliq) AS totalliq,
        ROW_NUMBER() OVER (ORDER BY SUM(totalliq) DESC) AS rn
    FROM vw_rentabilidade_aco 
    WHERE tipmov IN ('V', 'D')
      AND ATIVO_TOP = 'S'
      AND AD_COMPOE_FAT = 'S'
      AND dtneg BETWEEN '${dataInicioFormatada}' and '${dataFimFormatada}' ${filtroEmpresa}
    GROUP BY descrgrupo_nivel1
)
SELECT 
    CASE 
        WHEN rn <= 6 THEN descrgrupo_nivel1
        ELSE 'Outros'
    END AS descrgrupo_nivel1,
    SUM(totalliq) AS totalliq
FROM CTE
GROUP BY CASE 
             WHEN rn <= 6 THEN descrgrupo_nivel1
             ELSE 'Outros'
         END
ORDER BY totalliq DESC



****** atenção focar somente nesta parte.


------------------
prod32_2.jsp



sem estragar o codigo:

colocar nesta função abrir_fat os paramentros de '${dataInicioFormatada}' e '${dataFimFormatada}'
como params na função :A_DtInicial e :A_DtFinal

ajustar no html

a função tem q ficar assim:

function abrir_fat(dataInicioFormatada,dataFimFormatada){
      var params = {
        'A_DtInicial' : dataInicioFormatada , 
        'A_DtFinal' : dataFimFormatada
      },
      var level = 'lvl_aevdk6z';
      openLevel(level, params);
}


para o arquivo zteste.jsp tem o exemplo da função openLevel



-----------------------
12/08/2025
8:40 as 10:50
12:10 as 15:30



prod33_1.jsp


quero que este arquivo html5 zteste1.jsp receba os valores dos argumentos

A_DtFinal
A_DtInicial

o arquivo zteste1.jsp fica dentro do nivel lvl_aevdk6z, este nivel recebe este valores
          <![CDATA[:A_DtFinal :A_DtInicial]]>


e precisa passar de alguma forma para o zteste1.jsp e fazer a apresentação do mesmo.
ja efetuei varias tentativas mas sempre aparece o erro 'Internal Server Error' 
e nao consigo verificar que erro eh.


salvei este xml (zbase.xml ) que consta algumas informações impotante referentes ao 
zteste1.jsp


este é o nivel inferior de uma tela customizada, da opção 'construtor de componentes bi' do erp sankhya



---------------
12/08
16 as 18:30 e 20 as 23:30

*** redefinido dash para busca e replicado para nivel principal e niveis inferiores pelos card's
nivel principal 
faturamento
Devolução
impostos
CMV
ton
Desconto
Margem
Margem %
Despesa Operacional
Investimento




13/08/2025

18 as 20

sem estragar nada do layout atual
reduzir o tamanho do h1 nos cards
pois quando aparece um numero muito grande ele quebra a linha


sem estragar na do layout reduzir o espaçamento horizontamente entre o card's
muito cuidado
sem estragar nada...

o espaçamento horizontal do card de Resultado ainda esta muito grande, corrigir
muito cuidado para nao mudar o tamanho do card,
nem estragar nada do layout atual


SEM ESTRAGAR O CODIGO CHEAR UM POUCO PARA DIREITA O OVERLAY


--- para o nivel de faturamento 
colocado densehenk para a primeira query 
colocado <=5 no case
centraliado valor no grafico rosca
--- para o nivel de devolução
colocado densehenk para a primeira query 
colocado <=5 no case E tambem a ordem é crescente pois o vlrdev é negativo
centraliado valor no grafico rosca

--------------------
14/08/25
--- para o nivel de imposto
colocado densehenk para a primeira query 
colocado <=5 no case E tambem a ordem é desc
centraliado valor no grafico rosca
--- para o nivel de cmv
colocado densehenk para a primeira query 
colocado <=5 no case E tambem a ordem é desc
centraliado valor no grafico rosca
--- para o nivel de ton
colocado densehenk para a primeira query 
colocado <=5 no case E tambem a ordem é desc
centraliado valor no grafico rosca
--- para o nivel de desc
colocado densehenk para a primeira query 
colocado <=5 no case E tambem a ordem é desc
centraliado valor no grafico rosca
--- para o nivel de margem
colocado densehenk para a primeira query 
colocado <=5 no case E tambem a ordem é desc
centraliado valor no grafico rosca
--- para o nivel de des / inv
centraliado valor no grafico rosca
corrigido campo e where da query que mostra o total do grafico de rosca 

-----

18/08/2025
13:30 as 17:00
verifições e validações referente as calculos e campos para obter e validar os dados de acordo com cada conceito.


19/07
8:40 12
estruturação dos dados a ser apresntado de acordo com redefinição internação sobre como é formado cada valor a ser apresentado.

13:30 as 16:10 e 16:30 as 18:10
estruturação dos dados a ser apresntado de acordo com redefinição internação sobre como é formado cada valor a ser apresentado.


20/07
9 as 13
repasse passo a passo para bater valores de cada rubrica do dash de rentabilidade, readequação da view com os novos campos.
13:30 as 15:40
readequação da view nas query do dash de rentabilidade.

15:50 as 17
Ajustar do valor referente ao vlrsubst no total dos impostos. Adequação nas mensagens referente a dica de tela ao passar o mouse em cada card para apresentar
as informações respectivas que se refere o card.