<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="Rel_Demons_Men_Fat" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="1.3310000000000755"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<property name="ireport.definition"/>
	<style name="variacoes">
		<conditionalStyle>
			<conditionExpression><![CDATA[$F{TIPOMOVS}.equals('S')]]></conditionExpression>
			<style forecolor="#FF0000" backcolor="#FF0000" fill="Solid" scaleImage="Clip" hAlign="Left" vAlign="Top" rotation="None" lineSpacing="Single">
				<pen lineWidth="1.0"/>
			</style>
		</conditionalStyle>
		<conditionalStyle>
			<conditionExpression><![CDATA[$F{TIPOMOVS}.equals('E')]]></conditionExpression>
			<style mode="Transparent" forecolor="#CCFFCC" fill="Solid"/>
		</conditionalStyle>
	</style>
	<parameter name="PDIR_MODELO" class="java.lang.String" isForPrompting="false"/>
	<parameter name="P_DATAINI" class="java.sql.Timestamp">
		<parameterDescription><![CDATA[Dt. Inicial]]></parameterDescription>
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="P_DATAFIN" class="java.sql.Timestamp">
		<parameterDescription><![CDATA[Dt. Final]]></parameterDescription>
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="P_TIPNOTAS" class="java.lang.String">
		<parameterDescription><![CDATA[Tip. Nota]]></parameterDescription>
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="P_CODPARC" class="java.math.BigDecimal">
		<parameterDescription><![CDATA[Cód. Parceiro]]></parameterDescription>
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="P_CODPARCMAT" class="java.lang.String">
		<parameterDescription><![CDATA[Cód. Parc. Matriz]]></parameterDescription>
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="P_CONS_OUTRO_CFOP" class="java.lang.String">
		<parameterDescription><![CDATA[Considerar Outros CFOP's]]></parameterDescription>
	</parameter>
	<parameter name="P_CODCFO" class="java.lang.String">
		<parameterDescription><![CDATA[CFOP]]></parameterDescription>
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT
TO_CHAR(DTDOC, 'MONTH', 'NLS_DATE_LANGUAGE=PORTUGUESE') MES,
TO_CHAR(DTDOC, 'MM') M,
TO_CHAR(DTDOC,'YYYY') ANO,
SUM(CASE
WHEN CODCFO IN ('5101', '5102', '5116', '5117', '6101', '6102', '6107', '6108', '6117', '6118', '6116') THEN VLRCTB
WHEN NOT (CODCFO BETWEEN 1201 AND 1209 OR CODCFO BETWEEN 2201 AND 2209) THEN VLRCTB
ELSE 0 END) VLRCTB_BRUTO,
SUM(CASE
WHEN CODCFO IN ('5101', '5102', '5116', '5117', '6101', '6102', '6107', '6108', '6117', '6118', '6116') THEN VLRCTB
WHEN CODCFO IN ('1201', '1202', '2201','2202') THEN VLRCTB*-1
WHEN (CODCFO BETWEEN 1201 AND 1209) OR (CODCFO BETWEEN 2201 AND 2209)THEN VLRCTB * -1
ELSE 0 END) VLRCTB_LIQUIDO


FROM(

SELECT

S.TIPOMOVS,
S.DTDOC,
S.SERIENOTA,
NVL(S.PESO,0) AS PESO,
NVL(S.UNID_VOL,'-') AS UNID_VOL,
ROUND(S.NUMNOTA,0)AS NUMNOTA ,
ROUND(S.CODCFO,0)AS CODCFO,
S.TIPICMS,
ABS(ROUND(S.NUNOTA,0))AS NUNOTA,
S.EMPPARC,
S.CODEMP,
ROUND(S.CODPARC,0)AS CODPARC,
S.NOTA,
S.VLRICMS,
S.VLRCTB,
ROUND(S.CODPARC,0)||'-'||PAR.RAZAOSOCIAL  AS RAZAOSOCIAL,
COOPERADO,
STATUS,
NVL(TOP,0) AS TOP

FROM

    (
    SELECT
    S.TIPOMOVS,
    S.DTDOC,
    S.SERIENOTA,
    NVL(S.PESO,0) AS PESO,
    NVL(S.UNID_VOL,'-') AS UNID_VOL,
    ROUND(S.NUMNOTA,0)AS NUMNOTA ,
    ROUND(S.CODCFO,0)AS CODCFO,
    S.TIPICMS,
    ABS(ROUND(S.NUNOTA,0))AS NUNOTA,
    S.EMPPARC,
    S.CODEMP,
    ROUND(S.CODPARC,0)AS CODPARC,
    S.NOTA,
    S.VLRICMS,
    S.VLRCTB,
    '-' AS COOPERADO,
    (SELECT NVL(CODTIPOPER,0)FROM TGFCAB WHERE NUNOTA = S.NUNOTA )AS TOP,

    CASE WHEN TIPOMOVS = 'E' THEN 'AUTORIZADA'
         WHEN TIPOMOVS = 'S' THEN 'AUTORIZADA'
         WHEN TIPOMOVS = 'C' THEN 'CANCELADA'
         WHEN TIPOMOVS = 'I' THEN 'INUTILIZADA'
    END AS STATUS

    FROM
        (
        --ENTRADAS
        SELECT
                CASE WHEN LIV.NUNOTA < 0 THEN 'C' ELSE 'E' END AS TIPOMOVS,
                LIV.DTDOC,
                LIV.SERIENOTA,
                (SELECT SUM(QTDNEG) FROM TGFITE WHERE NUNOTA = LIV.NUNOTA) AS PESO,
                (SELECT MAX(CODVOL) FROM TGFITE WHERE NUNOTA = LIV.NUNOTA) AS UNID_VOL,
                LIV.NUMNOTA,
                LIV.CODCFO,
                LIV.TIPICMS,
                LIV.ALIQICMS,
                LIV.NUNOTA,
                LIV.EMPPARC,
                LIV.CODEMP,
                LIV.CODPARC,
                1 AS NOTA,
                SUM(LIV.VLRICMS) AS VLRICMS,
                SUM(LIV.VLRCTB) AS VLRCTB
              FROM TGFLIV LIV
              WHERE
                LIV.DTDOC BETWEEN $P{P_DATAINI} AND $P{P_DATAFIN}
                AND LIV.ENTSAI = 'E'
              GROUP BY
                LIV.DTDOC,
                LIV.NUMNOTA,
                LIV.TIPICMS,
                LIV.ALIQICMS,
                LIV.NUNOTA,
                LIV.CODCFO,
                LIV.SERIENOTA,
                LIV.DTDOC,
                LIV.CODPARC,
                LIV.EMPPARC,
                LIV.CODEMP,
                LIV.ESPDOC,
                LIV.CODMODDOC,
                LIV.CODTRIB,
                LIV.UFORIGEM

        UNION ALL

        --SAIDAS
        SELECT
            CASE WHEN LIV.NUNOTA < 0 THEN 'C' ELSE 'S' END AS TIPOMOVS,
            LIV.DTDOC,
            LIV.SERIENOTA,
            (SELECT SUM(QTDNEG) FROM TGFITE WHERE NUNOTA = LIV.NUNOTA) AS PESO,
            (SELECT MAX(CODVOL) FROM TGFITE WHERE NUNOTA = LIV.NUNOTA) AS UNID_VOL,
            CAST(LIV.NUMNOTA AS NUMERIC) AS NUMNOTA,
            CAST(LIV.CODCFO AS NUMERIC) AS CODCFO,
            LIV.TIPICMS,
            LIV.ALIQICMS,
            CAST(LIV.NUNOTA AS NUMERIC) AS NUNOTA,
            LIV.EMPPARC,
            CAST(LIV.CODEMP AS NUMERIC) AS CODEMP,
            CAST(LIV.CODPARC AS NUMERIC) AS CODPARC,
            1 AS NOTA,
            SUM(LIV.VLRICMS) AS VLRICMS,
            SUM(LIV.VLRCTB) AS VLRCTB
        FROM
        	TGFLIV LIV
        WHERE
            LIV.DTDOC BETWEEN $P{P_DATAINI} AND $P{P_DATAFIN}
            AND LIV.ENTSAI = 'S'
        GROUP BY
            LIV.NUNOTA,
            LIV.EMPPARC,
            LIV.CODEMP,
            LIV.CODPARC,
            LIV.DTDOC,
            LIV.DHMOV,
            LIV.SERIENOTA,
            LIV.NUMNOTA,
            LIV.NUMNOTA2,
            LIV.ALIQICMS,
            LIV.CODCFO,
            LIV.ESPDOC,
            LIV.TIPICMS,
            LIV.UFDESTINO,
            LIV.ORIGEM,
            LIV.CODMODDOC,
            CAST(LIV.OBSERVACAO AS VARCHAR(100))

        ) S
        LEFT JOIN TGFPAR PAR ON S.CODPARC = PAR.CODPARC
        INNER JOIN TGFCAB CAB ON S.NUNOTA = CAB.NUNOTA

        UNION ALL



        --INUTILIZADAS
        SELECT
            'I' AS TIPOMOVS,
            INU.DTMOV AS DTDOC,
            INU.SERIENOTA,
            (SELECT SUM(QTDNEG) FROM TGFITE_EXC WHERE NUNOTA = EXC.NUNOTA) AS PESO,
            (SELECT MAX(CODVOL) FROM TGFITE_EXC WHERE NUNOTA = EXC.NUNOTA) AS UNID_VOL,
            CAST(INU.NUMNOTA AS NUMERIC) AS NUMNOTA,
            0 AS CODCFO,
            '0' AS TIPICMS,
            CAST(INU.NUMNOTA AS NUMERIC) AS NUNOTA,
            'P' AS EMPPARC,
            CAST(INU.CODEMP AS NUMERIC) AS CODEMP,
            NVL(EXC.CODPARC,0)AS CODPARC,
            1 AS NOTA,
            0 AS VLRICMS,
            0 AS VLRCTB,
            '-'AS COOPERADO,
            NVL(EXC.CODTIPOPER,0) AS TOP,
            'INUTILIZADA' AS STATUS
        FROM
            TGFINU INU
        LEFT JOIN TGFCAB_EXC EXC ON INU.NUMNOTA = EXC.NUMNOTA AND EXC.SERIENOTA = INU.SERIENOTA AND EXC.CODEMP = INU.CODEMP
        LEFT JOIN TGFPAR PAR ON EXC.CODPARC = PAR.CODPARC
        WHERE
            INU.DTMOV BETWEEN '01/07/2025' AND '31/07/2025'
            AND (INU.TPAMBNFE IS NULL OR INU.TPAMBNFE = '1')
            AND INU.ENTSAI = 'S'


        UNION ALL

        --CANCELADAS
        SELECT
        'C' AS TIPOMOVS,
        CAN.DTMOV AS DTDOC,
        CAN.SERIENOTA,
        (SELECT SUM(QTDNEG) FROM TGFITE WHERE NUNOTA = CAN.NUNOTA) AS PESO,
        NVL((SELECT MAX(CODVOL) FROM TGFITE WHERE NUNOTA = CAN.NUNOTA),'-') AS UNID_VOL,
        CAN.NUMNOTA,
        0 AS CODCFO,
        '0' AS TIPICMS,
        CAN.NUNOTA,
        'P' AS EMPPARC,
        CAN.CODEMP,
        CAN.CODPARC,
        1 AS NOTA,
        0.0 AS VLRICMS,
        CAN.VLRNOTA AS VLRCTB,
        '-'AS COOPERADO,
        NVL((SELECT NVL(CODTIPOPER,0)FROM TGFCAB WHERE NUNOTA = CAN.NUNOTA),0)AS TOP,
        'CANCELADA' AS STATUS

        FROM TGFCAN CAN
        LEFT JOIN TGFPAR PAR ON CAN.CODPARC = PAR.CODPARC

        WHERE CAN.DTMOV BETWEEN $P{P_DATAINI} AND $P{P_DATAFIN}

        )S
        LEFT JOIN TGFPAR PAR ON S.CODPARC = PAR.CODPARC

WHERE
((PAR.CODPARCMATRIZ = $P{P_CODPARCMAT}) OR ($P{P_CODPARCMAT} IS NULL))
AND
((PAR.CODPARC = $P{P_CODPARC}) OR ($P{P_CODPARC} IS NULL))
AND
S.TIPOMOVS IN ($P!{P_TIPNOTAS})



)

WHERE
CODCFO IN ('5101', '5102', '5116', '5117', '6101', '6102', '6107', '6108', '6117', '6118', '6116','1201', '1202', '2201','2202')
OR ($P{P_CONS_OUTRO_CFOP}='S' AND CODCFO IN ($P!{P_CODCFO} ))

GROUP BY
TO_CHAR(DTDOC, 'MONTH', 'NLS_DATE_LANGUAGE=PORTUGUESE'),
TO_CHAR(DTDOC, 'MM'),
TO_CHAR(DTDOC,'YYYY')
ORDER BY 3,2]]>
	</queryString>
	<field name="ANO" class="java.lang.String">
		<fieldDescription><![CDATA[ANO]]></fieldDescription>
	</field>
	<field name="MES" class="java.lang.String">
		<fieldDescription><![CDATA[MÊS]]></fieldDescription>
	</field>
	<field name="VLRCTB_BRUTO" class="java.math.BigDecimal"/>
	<field name="VLRCTB_LIQUIDO" class="java.math.BigDecimal"/>
	<variable name="TOTFATBRU" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{VLRCTB_BRUTO}]]></variableExpression>
	</variable>
	<variable name="TOTFATLIQ" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{VLRCTB_LIQUIDO}]]></variableExpression>
	</variable>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="112" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="0" width="235" height="20"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[SATIS INDUSTRIA COMERCIO LTDA]]></text>
			</staticText>
			<staticText>
				<reportElement x="0" y="20" width="235" height="20"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[CNPJ: 02.677.655/0001-24]]></text>
			</staticText>
			<staticText>
				<reportElement x="0" y="78" width="555" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Demonstrativo Mensal do Faturamento]]></text>
			</staticText>
			<textField>
				<reportElement x="380" y="20" width="175" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[new java.text.SimpleDateFormat("dd/MM/yyyy").format(new java.util.Date())]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="380" y="40" width="175" height="20"/>
				<textElement verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Período: "
+ new java.text.SimpleDateFormat("dd/MM/yyyy").format($P{P_DATAINI})
+ " a "
+ new java.text.SimpleDateFormat("dd/MM/yyyy").format($P{P_DATAFIN})]]></textFieldExpression>
			</textField>
			<line>
				<reportElement x="0" y="111" width="555" height="1"/>
			</line>
		</band>
	</title>
	<pageHeader>
		<band splitType="Stretch"/>
	</pageHeader>
	<columnHeader>
		<band height="26" splitType="Stretch">
			<staticText>
				<reportElement x="194" y="6" width="52" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[ANO]]></text>
			</staticText>
			<staticText>
				<reportElement x="73" y="6" width="121" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[MÊS]]></text>
			</staticText>
			<staticText>
				<reportElement x="294" y="0" width="110" height="26"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[FATURADO (R$)
BRUTO]]></text>
			</staticText>
			<staticText>
				<reportElement x="404" y="0" width="110" height="26"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[FATURADO (R$)
LÍQUIDO]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="20" splitType="Stretch">
			<textField>
				<reportElement x="194" y="0" width="52" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{ANO}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="73" y="0" width="121" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{MES}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00">
				<reportElement x="294" y="0" width="110" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{VLRCTB_BRUTO}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00">
				<reportElement x="404" y="0" width="110" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{VLRCTB_LIQUIDO}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band splitType="Stretch"/>
	</pageFooter>
	<lastPageFooter>
		<band/>
	</lastPageFooter>
	<summary>
		<band height="56" splitType="Stretch">
			<staticText>
				<reportElement x="73" y="0" width="121" height="20"/>
				<textElement verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Total:]]></text>
			</staticText>
			<line>
				<reportElement x="0" y="0" width="555" height="1"/>
			</line>
			<textField pattern="#,##0.00">
				<reportElement x="294" y="1" width="110" height="19"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{TOTFATBRU}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00">
				<reportElement x="404" y="1" width="110" height="19"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{TOTFATLIQ}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="0" y="38" width="555" height="18"/>
				<textElement>
					<font size="4"/>
				</textElement>
				<text><![CDATA[***Nota explicativa sobre a composição do faturamento
CFOP’s considerados para a formação do faturamento bruto:('5101', '5102', '5116', '5117', '6101', '6102', '6107', '6108', '6117', '6118', '6116')
CFOP’s considerados para a formação do faturamento líquido:('5101', '5102', '5116', '5117', '6101', '6102', '6107', '6108', '6117', '6118', '6116') menos ('1201', '1202', '2201', '2202')]]></text>
			</staticText>
		</band>
	</summary>
</jasperReport>
