SELECT --SUM(VLRCTB)VLRCTB 
TO_CHAR(DHMOV, 'MONTH', 'NLS_DATE_LANGUAGE=PORTUGUESE') MES,
TO_CHAR(DHMOV, 'MM') M,
TO_CHAR(DHMOV,'YYYY') ANO,

SUM(CASE
WHEN CODCFO IN ('5101', '5102','5117', '5922', '6101', '6102', '6107', '6108','6116', '6117', '6118', '6922') THEN VLRCTB*-1
WHEN CODCFO IN ('1201', '1202', '2201','2202')THEN VLRCTB
ELSE 0 END) VLRCTB_LIQUIDO

--'5101', '5102', '5922', '6101', '6102', '6107', '6108', '6117', '6118', '6922'
--'5101', '5102','5117', '5922', '6101', '6102', '6107', '6108','6116', '6117', '6118', '6922'
FROM (
SELECT
E.RAZAOSOCIAL,E.INSCESTAD,MASK(2,E.CGC) AS CGC,L.CODPARC,
L.DHMOV,
CASE WHEN L.CODMODDOC = 55 THEN 'NF-e'
     WHEN L.CODMODDOC = 57 THEN 'CT-e'
     WHEN L.CODMODDOC = 65 THEN 'NFC-e'
		       ELSE 'NF' END AS ESPDOC, 
L.SERIENOTA, L.NUMNOTA, L.DTDOC, L.UFDESTINO, SUM(L.VLRCTB) AS VLRCTB, L.CODCFO, SUM(L.BASEICMS) AS BASEICMS, L.ALIQICMS, SUM(L.VLRICMS) AS VLRICMS, SUM(L.ISENTASICMS) AS ISENTASICMS, SUM(L.OUTRASICMS) AS OUTRASICMS, SUM(L.VLRIPI) AS IPI, SUM(ICMSRETENCAO) AS ST, L.NUNOTA
FROM TGFLIV L
INNER JOIN TSIEMP E ON (E.CODEMP = L.CODEMP)

WHERE
    --L.CODEMP = $P{CODEMP}
--AND (L.ENTSAI = CASE WHEN $P{LENT}=1 THEN 'E' ELSE 'Z' END OR L.ENTSAI = CASE WHEN $P{LSAI}=1 THEN 'S' ELSE 'Z' END)
--AND 
L.DHMOV BETWEEN '01/09/2024' and '31/08/2025' --$P{DTMOVINI} AND $P{DTMOVFIM}
AND L.CODCFO IN ('5101', '5102','5117', '5922', '6101', '6102', '6107', '6108','6116', '6117', '6118', '6922','1201', '1202', '2201','2202')
--AND L.CODCFO = NVL($P{CFOP},L.CODCFO)

GROUP BY
L.DHMOV, L.NUMNOTA, L.NUNOTA, L.ESPDOC, L.SERIENOTA, L.DTDOC, L.UFDESTINO, L.CODCFO, L.ALIQICMS, E.RAZAOSOCIAL,E.CGC, E.INSCESTAD,L.CODPARC,L.CODMODDOC

--ORDER BY
--L.DHMOV, L.NUMNOTA, L.CODCFO

)
GROUP BY
TO_CHAR(DHMOV, 'MONTH', 'NLS_DATE_LANGUAGE=PORTUGUESE'),
TO_CHAR(DHMOV, 'MM'),
TO_CHAR(DHMOV,'YYYY')
ORDER BY 3,2
