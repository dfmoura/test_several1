

SELECT

ANO,MES,DATA,CODVEND,APELIDO,SUM(VLR_REAL) AS VLR_REAL,SUM(VLRDESP) * -1 AS VLRDESP



FROM(

SELECT

TO_CHAR(DATA,'YYYY') AS ANO

, TO_CHAR(DATA,'MM') AS MES

, TO_CHAR(DATA,'MM-YYYY') AS DATA

, AD_VENDEDOR_RESP AS CODVEND

, APELIDO

, 0 AS VLR_REAL

, SUM(VLRDESP) AS VLRDESP



FROM

(

SELECT 

CASE WHEN (CASE WHEN :P_DTENTSAI = 2 THEN X.DTENTSAI ELSE X.DHBAIXA END) IS NULL THEN X.DTNEG 
ELSE (CASE WHEN :P_DTENTSAI = 2 THEN X.DTENTSAI ELSE X.DHBAIXA END) END AS DATA



,NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP

,NVL(VEN.APELIDO,0) AS APELIDO

,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 

		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 

		ELSE 0 END),0) AS VLRDESP

FROM TSICUS CUS1

LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS

INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT

INNER JOIN TGFVEN VEN ON CUS1.AD_VENDEDOR_RESP = VEN.CODVEND

WHERE

( (

    (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

    OR

    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

    OR

    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' 
    AND (CASE WHEN :P_DTENTSAI = 2 THEN X.DTENTSAI ELSE X.DHBAIXA END BETWEEN :P_PERIODO_INI AND :P_PERIODO_FIN)
    )



)

OR

( (

    X.RECDESP IN (1,0,-1)

    AND X.PROVISAO = 'N' 

    AND X.CODNAT <> 2020202 

    AND X.NUNOTA IN (

        SELECT NUNOTA 

        FROM TGFCAB CAB

        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)

        WHERE

            TOP.ATUALEST <> 'N'

            AND CAB.TIPMOV IN ('V','D')

            AND CAB.STATUSNOTA='L'

            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)

            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )

		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

  )

OR

    X.RECDESP IN (1)

    AND X.PROVISAO = 'N' 

    AND X.CODNAT <> 1010000


    AND (CASE WHEN :P_DTENTSAI = 2 THEN X.DTENTSAI ELSE X.DHBAIXA END BETWEEN :P_PERIODO_INI AND :P_PERIODO_FIN)

) )

AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)

GROUP BY

X.DTNEG

,X.DHBAIXA

,X.DTENTSAI

,NVL(CUS1.AD_VENDEDOR_RESP,0)

,NVL(VEN.APELIDO,0)

)

WHERE 

AD_VENDEDOR_RESP = :A_CODVEND



GROUP BY

TO_CHAR(DATA,'YYYY')

, TO_CHAR(DATA,'MM')

, TO_CHAR(DATA,'MM-YYYY')

, AD_VENDEDOR_RESP

, APELIDO





UNION ALL





SELECT 

TO_CHAR(DTREF,'YYYY') AS ANO

, TO_CHAR(DTREF,'MM') AS MES

, TO_CHAR(DTREF,'MM-YYYY') AS DATA

, CODVEND

, APELIDO

, SUM(VLR_REAL) AS VLR_REAL

, 0 AS VLRDESP

FROM

(



SELECT

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD,

SUM(QTDPREV) AS QTDPREV,

SUM(QTDREAL) AS QTDREAL,

SUM(QTDPREV * PRECOLT) AS VLR_PREV,

SUM(NVL(VLRREAL, 0)) AS VLR_REAL

FROM(

SELECT MET.CODMETA,MET.DTREF, NVL(MET.CODVEND,0) AS CODVEND, NVL(VEN.APELIDO,0) AS APELIDO,NVL(VEN.CODGER,0) AS CODGER, NVL(MET.CODPARC,0) AS CODPARC, 

NVL(PAR.RAZAOSOCIAL,0) AS PARCEIRO, 

NVL(MET.MARCA,0) AS MARCA,

NVL(VGF.CODGRUPOPROD,0) AS CODGRUPOPROD,

NVL(VGF.CODCENCUS,0) AS CODCENCUS, 

NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,

NVL(PRC.VLRVENDALT,0)AS PRECOLT, 

SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

LEFT JOIN TGFPAR PAR ON MET.CODPARC = PAR.CODPARC

LEFT JOIN TGFVEN VEN ON MET.CODVEND = VEN.CODVEND

GROUP BY MET.CODMETA,MET.DTREF,NVL(MET.CODVEND,0),NVL(VEN.APELIDO,0),NVL(VEN.CODGER,0),NVL(MET.CODPARC,0),NVL(PAR.RAZAOSOCIAL,0),NVL(MET.MARCA,0),NVL(VGF.CODGRUPOPROD,0),NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)



)

WHERE 

CODMETA = :P_CODMETA

AND DTREF BETWEEN :P_PERIODO.INI   AND  :P_PERIODO.FIN

AND (CODVEND = :A_CODVEND)



GROUP BY

DTREF,

CODMETA,

CODVEND,

APELIDO,

CODGER,

CODPARC,

PARCEIRO,

MARCA,

CODGRUPOPROD

)



GROUP BY

CODVEND

, APELIDO

, TO_CHAR(DTREF,'YYYY')

, TO_CHAR(DTREF,'MM')

, TO_CHAR(DTREF,'MM-YYYY')

)


WHERE
(
	/*CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR */(SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)


GROUP BY

ANO,MES,DATA,CODVEND,APELIDO



ORDER BY 1,2
