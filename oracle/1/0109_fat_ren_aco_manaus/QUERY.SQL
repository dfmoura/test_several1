
WITH
DO AS ( /*DESPESA OPERACIONA*/
select 
sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRDO,
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRDO_MA,
case 
when sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) = 0 then null
else round(((sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) - 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)) * 100.0 / 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)), 2)
end as VAR_VLRDO
FROM TGFFIN FIN
INNER JOIN TGFNAT NAT ON FIN.CODNAT = NAT.CODNAT
WHERE 
FIN.RECDESP = -1 
AND NAT.ATIVA = 'S'
AND FIN.DHBAIXA IS NOT NULL AND FIN.CODEMP IN (1,11,2,3)
),
INV AS ( /*INVESTIMENTO*/
select 
sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRINV,
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRINV_MA,
case 
when sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) = 0 then null
else round(((sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) - 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)) * 100.0 / 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)), 2)
end as VAR_VLRINV
FROM TGFFIN FIN
INNER JOIN TGFNAT NAT ON FIN.CODNAT = NAT.CODNAT
WHERE 
FIN.RECDESP = -1 
AND NAT.ATIVA = 'S'
AND FIN.DHBAIXA IS NOT NULL AND FIN.CODEMP IN (1,11,2,3)
),
BAS_MA AS (
SELECT 
1 AS COD,
SUM(TOTALLIQ) VLRFAT_MA,
SUM(VLRDEV) VLRDEVOL_MA,
SUM(VLRIPI+VLRSUBST+VLRICMS+VLRPIS+VLRCOFINS) VLRIMP_MA,
SUM(CUSREP_TOT) VLRCMV_MA,
SUM(TON) TON_MA,
SUM(VLRDESC) VLRDESC_MA,
SUM(MARGEMNON) VLRMCN_MA,
AVG(PERCMARGEM) VLRMCD_MA
FROM vw_rentabilidade_aco
WHERE 
DTNEG BETWEEN DATEADD(month, -1, '01/08/2025') AND DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) 
and tipmov in ('V', 'D') and ATIVO_TOP = 'S' and AD_COMPOE_FAT = 'S'
AND CODEMP IN (1,11,2,3)
),
BAS AS (
SELECT 
1 AS COD,
SUM(TOTALLIQ) VLRFAT,
SUM(VLRDEV) VLRDEVOL,
SUM(VLRIPI+VLRSUBST+VLRICMS+VLRPIS+VLRCOFINS) VLRIMP,
SUM(CUSREP_TOT) VLRCMV,
SUM(TON) TON,
SUM(VLRDESC) VLRDESC,
SUM(MARGEMNON) VLRMCN,
AVG(PERCMARGEM) VLRMCD
FROM vw_rentabilidade_aco
WHERE
DTNEG BETWEEN '01/08/2025' AND  '31/08/2025'
and tipmov in ('V', 'D') and ATIVO_TOP = 'S' and AD_COMPOE_FAT = 'S'
AND CODEMP IN (1,11,2,3)
)
SELECT 
FORMAT(ROUND(VLRFAT, 2), 'N2') AS VLRFAT,
FORMAT(ROUND(VLRFAT_MA, 2), 'N2') AS VLRFAT_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRFAT - VLRFAT_MA) / NULLIF(VLRFAT_MA,0)) * 100,2),0), 2), 'N2') AS VAR_VLRFAT,
FORMAT(ROUND(VLRDEVOL, 2), 'N2') AS VLRDEVOL,
FORMAT(ROUND(VLRDEVOL_MA, 2), 'N2') AS VLRDEVOL_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRDEVOL - VLRDEVOL_MA) / NULLIF(VLRDEVOL_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRDEVOL,
FORMAT(ROUND(VLRIMP, 2), 'N2') AS VLRIMP,
FORMAT(ROUND(VLRIMP_MA, 2), 'N2') AS VLRIMP_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRIMP - VLRIMP_MA) / NULLIF(VLRIMP_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRIMP,
FORMAT(ROUND(VLRCMV, 2), 'N2') AS VLRCMV,
FORMAT(ROUND(VLRCMV_MA, 2), 'N2') AS VLRCMV_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRCMV - VLRCMV_MA) / NULLIF(VLRCMV_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRCMV,
FORMAT(ROUND(VLRDESC, 2), 'N2') AS VLRDESC,
FORMAT(ROUND(VLRDESC_MA, 2), 'N2') AS VLRDESC_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRDESC - VLRDESC_MA) / NULLIF(VLRDESC_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRDESC,
FORMAT(ROUND(VLRMCN, 2), 'N2') AS VLRMCN,
FORMAT(ROUND(VLRMCN_MA, 2), 'N2') AS VLRMCN_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRMCN - VLRMCN_MA) / NULLIF(VLRMCN_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRMCN,
FORMAT(ROUND(VLRMCD, 2), 'N2') AS VLRMCD,
FORMAT(ROUND(VLRMCD_MA, 2), 'N2') AS VLRMCD_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRMCD - VLRMCD_MA) / NULLIF(VLRMCD_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRMCD,
FORMAT(ROUND(VLRDO, 2), 'N2') AS VLRDO,
FORMAT(ROUND(VLRDO_MA, 2), 'N2') AS VLRDO_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRDO - VLRDO_MA) / NULLIF(VLRDO_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRDO,
FORMAT(ROUND(TON, 2), 'N2') AS TON,
FORMAT(ROUND(TON_MA, 2), 'N2') AS TON_MA,
FORMAT(ROUND(ISNULL(ROUND(((TON - TON_MA) / NULLIF(TON_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_TON,
FORMAT(ROUND(VLRINV, 2), 'N2') AS VLRINV,
FORMAT(ROUND(VLRINV_MA, 2), 'N2') AS VLRINV_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRINV - VLRINV_MA) / NULLIF(VLRINV_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRINV,
FORMAT(ROUND(VLRFAT-VLRDO-VLRINV, 2), 'N2') AS VLRRES,
FORMAT(ROUND(VLRFAT_MA-VLRDO_MA-VLRINV_MA, 2), 'N2') AS VLRRES_MA,
FORMAT(ROUND(ISNULL(ROUND(((VLRFAT-VLRDO-VLRINV) - (VLRFAT_MA-VLRDO_MA-VLRINV_MA)) / NULLIF((VLRFAT_MA-VLRDO_MA-VLRINV_MA), 0) * 100, 2), 0), 2), 'N2') AS VAR_VLRRES
FROM BAS
INNER JOIN BAS_MA ON BAS.COD = BAS_MA.COD
INNER JOIN DO ON BAS.COD = DO.COD
INNER JOIN INV ON BAS.COD = INV.COD;

