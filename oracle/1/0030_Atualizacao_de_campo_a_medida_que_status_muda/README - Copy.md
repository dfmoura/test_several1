# Objetivos
```markdown
"Atualizar a TABELA COM VIEW (AD_VGFSTATUSA2W)que retorna o STATUS dos pedidos
Essa tabela com view retorna o status dos pedidos integrados pela A2W, assim os vendedores podem saber no campo, atravez da mobilidade A2W em qual status o pedido se encontra

A VIEW  deve retornar os status:

A - APROVADO
R - REJEITADO
C - CANCELADO
PROGAMADO ENTREGA
FP - FATURADO PARCIAL
FT - FATURADO TOTAL

ADICIONAR O CAMPO ""COMENTARIO"", ELE DEVERÁ GRAVAR A DATA DE ENTREGA PREVISTA PARA OS STATUS DE PROGRAMADO ENTREGA E FATURADO TOTAL E PARCIAL"
      
```
     
### 1. Log's Execução
#### 1.1. 03/04/2024 15:00 as 18:30
```markdown

SATIS - Atualizar a TABELA COM VIEW - A TABELA COM VIEW (AD_VGFSTATUSA2W) foi atualizada para refletir os respectivos status. O status "FATURADO TOTAL" é atribuído quando todos os itens estão marcados como "Pendente = N" em TGFITE. O status "FATURADO PARCIAL" é atribuído se pelo menos um item está marcado como "Pendente = N" e os demais como "Pendente = S". O status "PROGRAMADO ENTREGA" é concedido quando todos os itens estão marcados como "Pendente = S" e a data de entrega prevista (CAB.AD_DTENTREGAPREV) está informada. Para melhorar a visualização e compreensão, um campo "COMENTARIO" foi adicionado para indicar a data de entrega prevista para os status de "PROGRAMADO ENTREGA" e "FATURADO TOTAL E PARCIAL".


SELECT
NUNOTA,
STATUS,
CASE WHEN STATUS IN ('FP','FT','PE') THEN AD_DTENTREGAPREV ELSE NULL END AS COMENTARIO
FROM
(
SELECT
    CAB.NUNOTA,
    CAB.AD_DTENTREGAPREV,
    CASE 
        WHEN CAB.PENDENTE ='N' AND (SELECT COUNT(*) FROM TGFVAR WHERE NUNOTAORIG = CAB.NUNOTA) = 0 THEN 'C'
        WHEN (SELECT COUNT(*) FROM TSILIB WHERE NUCHAVE = CAB.NUNOTA AND REPROVADO = 'S' ) > 0 THEN 'R'
        WHEN CAB.PENDENTE ='S' AND (SELECT COUNT(*)  FROM TSILIB WHERE NUCHAVE = CAB.NUNOTA) = (SELECT COUNT(*) FROM TSILIB WHERE NUCHAVE = CAB.NUNOTA  AND VLRLIBERADO >= VLRATUAL) THEN 'A'
        
        /*FATURADO TOTAL se dá se todos os itens estiverem TGFITE.PENDENTE = N*/
        WHEN NOT EXISTS (SELECT 1 FROM TGFITE WHERE PENDENTE = 'S') THEN 'FT'
        
        /*FATURADO PARCIAL se dá se tiver pelo menos 1 item TGFITE.PENDENTE = N e outros TGFITE.PENDENTE = S*/
        WHEN EXISTS (SELECT 1 FROM TGFITE WHERE PENDENTE = 'N') AND EXISTS (SELECT 1 FROM TGFITE WHERE PENDENTE = 'S') THEN 'FP'
        
        /*PROGRAMADO ENTREGA todos os itens estiverem com TGFITE.PENDENTE = S e a data de entrega prevista CAB.AD_DTENTREGAPREV estiver informada*/
        WHEN ((SELECT COUNT(*) FROM TGFITE WHERE NUNOTA = CAB.NUNOTA AND PENDENTE = 'S') = COUNT(*)) AND CAB.AD_DTENTREGAPREV IS NOT NULL THEN 'PE'
    END AS STATUS
FROM TGFCAB CAB
WHERE CAB.TIPMOV = 'P'
GROUP BY CAB.NUNOTA, CAB.PENDENTE, CAB.AD_DTENTREGAPREV
)




/*
ATENCAO ESTA VIEW ABAIXO EH A ANTIGA:

SELECT
CAB.NUNOTA,
CASE 
WHEN CAB.PENDENTE ='N' AND (SELECT COUNT(*) FROM TGFVAR WHERE NUNOTAORIG = CAB.NUNOTA) = 0 THEN 'C'
WHEN (SELECT COUNT(*) FROM TSILIB WHERE NUCHAVE = CAB.NUNOTA AND REPROVADO = 'S' ) > 0 THEN 'R'
WHEN CAB.PENDENTE ='S' AND (SELECT COUNT(*)  FROM TSILIB WHERE NUCHAVE = CAB.NUNOTA) = (SELECT COUNT(*) FROM TSILIB WHERE NUCHAVE = CAB.NUNOTA  AND VLRLIBERADO >= VLRATUAL) THEN 'A'
WHEN (SELECT SUM(QTDATENDIDA) FROM TGFVAR WHERE NUNOTAORIG = CAB.NUNOTA) = (SELECT SUM(QTDNEG) FROM TGFITE WHERE NUNOTA = CAB.NUNOTA) THEN 'FT'
WHEN (SELECT SUM(QTDATENDIDA) FROM TGFVAR WHERE NUNOTAORIG = CAB.NUNOTA) < (SELECT SUM(QTDNEG) FROM TGFITE WHERE NUNOTA = CAB.NUNOTA) THEN 'FP'
END AS STATUS
FROM TGFCAB CAB
WHERE CAB.TIPMOV = 'P'


*/

```
