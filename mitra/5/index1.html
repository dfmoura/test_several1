<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Compara√ß√£o de Compras por Per√≠odo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
        font-family: "Roboto", sans-serif;
        background-color: #f5f7fa;
        color: #5d6585;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      .dashboard-header {
        margin-bottom: 2rem;
      }

      .dashboard-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .dashboard-header p {
        font-size: 1rem;
        color: #7f8c8d;
      }

      .period-selector {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .period-selector label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #2c3e50;
      }

      .period-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .period-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.875rem;
        font-family: "Roboto", sans-serif;
        color: #5d6585;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.2s;
      }

      .period-btn:hover {
        background-color: #f8f9fa;
        border-color: #3498db;
      }

      .period-btn.active {
        background-color: #3498db;
        color: #ffffff;
        border-color: #3498db;
      }

      .custom-period {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .date-input {
        padding: 0.5rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.875rem;
        font-family: "Roboto", sans-serif;
        color: #5d6585;
        outline: none;
        transition: border-color 0.2s;
      }

      .date-input:focus {
        border-color: #3498db;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .stat-card-title {
        font-size: 0.875rem;
        font-weight: 500;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .stat-card-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .stat-card-subtitle {
        font-size: 0.875rem;
        color: #7f8c8d;
      }

      .stat-card-change {
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-top: 0.5rem;
      }

      .stat-card-change.positive {
        color: #27ae60;
      }

      .stat-card-change.negative {
        color: #e74c3c;
      }

      .chart-container {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .chart-title {
        font-size: 1.25rem;
        font-weight: 500;
        color: #2c3e50;
      }

      .chart-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .chart-wrapper {
        position: relative;
        height: 350px;
      }

      .comparative-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        height: 300px;
        gap: 0.5rem;
        padding: 0 1rem;
      }

      .month-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        min-width: 60px;
        height: 100%;
      }

      .bar-group {
        display: flex;
        gap: 2px;
        width: 100%;
        height: 100%;
        align-items: flex-end;
        justify-content: center;
      }

      .bar {
        flex: 1;
        border-radius: 4px 4px 0 0;
        min-width: 15px;
        min-height: 4px;
        position: relative;
        transition: opacity 0.2s;
        cursor: pointer;
        display: block;
      }

      .bar:hover {
        opacity: 0.8;
      }

      .bar-2023 {
        background: linear-gradient(to top, #3498db, #5dade2);
      }

      .bar-2024 {
        background: linear-gradient(to top, #27ae60, #58d68d);
      }

      .bar-2025 {
        background: linear-gradient(to top, #e74c3c, #ec7063);
      }

      .bar-label {
        font-size: 0.7rem;
        color: #7f8c8d;
        margin-top: 0.5rem;
        text-align: center;
      }

      .legend {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
      }

      .two-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .table-container {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        overflow-x: auto;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .table-title {
        font-size: 1.25rem;
        font-weight: 500;
        color: #2c3e50;
      }

      .filter-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .filter-select {
        padding: 0.5rem 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.875rem;
        font-family: "Roboto", sans-serif;
        color: #5d6585;
        background-color: #ffffff;
        outline: none;
        transition: border-color 0.2s;
        cursor: pointer;
      }

      .filter-select:focus {
        border-color: #3498db;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background-color: #f8f9fa;
      }

      th {
        padding: 1rem;
        text-align: left;
        font-size: 0.875rem;
        font-weight: 500;
        color: #2c3e50;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e0e0e0;
      }

      td {
        padding: 1rem;
        font-size: 0.875rem;
        color: #5d6585;
        border-bottom: 1px solid #f0f0f0;
      }

      tbody tr:hover {
        background-color: #f8f9fa;
      }

      .geo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .geo-item {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        border-left: 4px solid #3498db;
      }

      .geo-item-title {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .geo-item-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #3498db;
      }

      .period-info {
        font-size: 0.875rem;
        color: #7f8c8d;
        margin-top: 0.5rem;
      }

      @media (max-width: 768px) {
        .dashboard-container {
          padding: 1rem;
        }

        .period-selector {
          flex-direction: column;
          align-items: flex-start;
        }

        .period-buttons {
          width: 100%;
        }

        .period-btn {
          flex: 1;
        }

        .custom-period {
          width: 100%;
        }

        .date-input {
          flex: 1;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .two-columns {
          grid-template-columns: 1fr;
        }

        .comparative-chart {
          gap: 0.25rem;
        }

        .month-group {
          min-width: 40px;
        }

        .bar-label {
          font-size: 0.6rem;
        }

        table {
          font-size: 0.75rem;
        }

        th,
        td {
          padding: 0.5rem;
        }

        .filter-controls {
          width: 100%;
        }

        .filter-select {
          flex: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1>Compara√ß√£o de Compras por Per√≠odo</h1>
        <p>
          An√°lise comparativa de compras com diferentes intervalos temporais
        </p>
      </div>

      <div class="period-selector">
        <label>Per√≠odo:</label>
        <div class="period-buttons">
          <button class="period-btn active" data-period="all">Todos</button>
          <button class="period-btn" data-period="1month">√öltimo M√™s</button>
          <button class="period-btn" data-period="3months">
            √öltimos 3 Meses
          </button>
          <button class="period-btn" data-period="6months">
            √öltimos 6 Meses
          </button>
          <button class="period-btn" data-period="1year">√öltimo Ano</button>
          <button class="period-btn" data-period="2years">
            √öltimos 2 Anos
          </button>
          <button class="period-btn" data-period="5years">
            √öltimos 5 Anos
          </button>
        </div>
        <div class="custom-period">
          <input
            type="date"
            class="date-input"
            id="startDate"
            placeholder="Data inicial"
          />
          <span>at√©</span>
          <input
            type="date"
            class="date-input"
            id="endDate"
            placeholder="Data final"
          />
          <button class="period-btn" id="applyCustomPeriod">Aplicar</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Custo Total</span>
            <div class="stat-card-icon" style="background-color: #e8f5e9">
              üí∞
            </div>
          </div>
          <div class="stat-card-value" id="custoTotal">R$ 0,00</div>
          <div class="stat-card-subtitle" id="custoPeriodo">
            Per√≠odo selecionado
          </div>
          <div class="stat-card-change" id="custoChange"></div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Volume Total</span>
            <div class="stat-card-icon" style="background-color: #e3f2fd">
              üì¶
            </div>
          </div>
          <div class="stat-card-value" id="volumeTotal">0</div>
          <div class="stat-card-subtitle">Quantidade adquirida</div>
          <div class="stat-card-change" id="volumeChange"></div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Principal Fornecedor</span>
            <div class="stat-card-icon" style="background-color: #fff3e0">
              üè¢
            </div>
          </div>
          <div
            class="stat-card-value"
            id="principalFornecedor"
            style="font-size: 1.25rem"
          >
            -
          </div>
          <div class="stat-card-subtitle" id="volumeFornecedor">Volume: 0</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Produtos Diferentes</span>
            <div class="stat-card-icon" style="background-color: #f3e5f5">
              üìã
            </div>
          </div>
          <div class="stat-card-value" id="totalProdutos">0</div>
          <div class="stat-card-subtitle">Tipos de produtos</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">Comparativo Mensal</div>
          <div class="chart-controls">
            <select class="filter-select" id="chartInterval">
              <option value="monthly">Mensal</option>
              <option value="quarterly">Trimestral</option>
              <option value="yearly">Anual</option>
            </select>
          </div>
        </div>
        <div class="chart-wrapper">
          <div class="comparative-chart" id="comparativeChart"></div>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color bar-2023"></div>
              <span>2023</span>
            </div>
            <div class="legend-item">
              <div class="legend-color bar-2024"></div>
              <span>2024</span>
            </div>
            <div class="legend-item">
              <div class="legend-color bar-2025"></div>
              <span>2025</span>
            </div>
          </div>
        </div>
      </div>

      <div class="two-columns">
        <div class="table-container">
          <div class="table-header">
            <div class="table-title">Top Fornecedores</div>
            <div class="filter-controls">
              <select class="filter-select" id="yearFilterFornecedor">
                <option value="all">Todos os anos</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Fornecedor</th>
                <th>Volume</th>
                <th>Valor Total</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody id="fornecedoresBody"></tbody>
          </table>
        </div>

        <div class="table-container">
          <div class="table-header">
            <div class="table-title">Detalhamento por Produto</div>
            <div class="filter-controls">
              <select class="filter-select" id="yearFilterProduto">
                <option value="all">Todos os anos</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Produto</th>
                <th>Volume</th>
                <th>Valor Total</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody id="produtosBody"></tbody>
          </table>
        </div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <div class="table-title">An√°lise por Geolocaliza√ß√£o</div>
          <div class="filter-controls">
            <select class="filter-select" id="geoFilter">
              <option value="regiao">Regi√£o</option>
              <option value="estado">Estado</option>
              <option value="cidade">Cidade</option>
            </select>
            <select class="filter-select" id="yearFilterGeo">
              <option value="all">Todos os anos</option>
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
            </select>
          </div>
        </div>
        <div class="geo-grid" id="geoGrid"></div>
      </div>
    </div>

    <script>
      // Dados fict√≠cios baseados nos campos do CSV
      const generateFakeData = () => {
        const fornecedores = [
          "TRANSPANORAMA TRANSPORTES S.A.",
          "POSTOS ALPA LTDA",
          "GRAOS DE OURO TRANSPORTES LTDA",
          "HELGA FRANCA DE PAIVA",
          "COOPDIESEL-COOPERATIVA DE PESSOAS TRANSPORTES",
          "ORTOVEL VEICULOS E PECAS LTDA",
          "EBENEZER COMERCIO DE CEREAIS LTDA",
          "EURIPEDES BENTO DOS REIS",
          "AGRO COMERCIO SUL LTDA",
          "CEREAIS DO BRASIL S.A.",
        ];

        const produtos = [
          "SERVICO DE TRANSPORTE",
          "COMBUSTIVEL",
          "TRIGO EM GRAOS A GRANEL",
          "PRODUTO CONSUMO TRIBUTADO INTEG.",
          "FARINHA DE TRIGO",
          "FERTILIZANTE",
          "SEMENTE DE SOJA",
          "OLEO DE SOJA",
          "MILHO EM GRAOS",
        ];

        const regioes = ["Sul", "Sudeste", "Centro-Oeste", "Norte", "Nordeste"];
        const estados = {
          Sul: ["RS", "SC", "PR"],
          Sudeste: ["SP", "RJ", "MG", "ES"],
          "Centro-Oeste": ["MT", "MS", "GO", "DF"],
          Norte: ["AM", "PA", "RO", "AC"],
          Nordeste: ["BA", "PE", "CE", "RN"],
        };

        const cidades = {
          RS: ["Porto Alegre", "Caxias do Sul", "Pelotas"],
          SC: ["Florian√≥polis", "Joinville", "Blumenau"],
          PR: ["Curitiba", "Londrina", "Maring√°"],
          SP: ["S√£o Paulo", "Campinas", "Ribeir√£o Preto"],
          RJ: ["Rio de Janeiro", "Niter√≥i", "Campos"],
          MG: ["Belo Horizonte", "Uberl√¢ndia", "Juiz de Fora"],
          ES: ["Vit√≥ria", "Vila Velha", "Cariacica"],
        };

        const data = [];
        const meses = [
          "Jan",
          "Fev",
          "Mar",
          "Abr",
          "Mai",
          "Jun",
          "Jul",
          "Ago",
          "Set",
          "Out",
          "Nov",
          "Dez",
        ];

        // Gerar dados para 2020 a 2025 (6 anos de dados)
        for (let ano = 2020; ano <= 2025; ano++) {
          for (let mes = 0; mes < 12; mes++) {
            const diasNoMes = new Date(ano, mes + 1, 0).getDate();
            const registrosPorMes = 20 + Math.floor(Math.random() * 30);

            for (let i = 0; i < registrosPorMes; i++) {
              const dia = Math.floor(Math.random() * diasNoMes) + 1;
              const fornecedor =
                fornecedores[Math.floor(Math.random() * fornecedores.length)];
              const produto =
                produtos[Math.floor(Math.random() * produtos.length)];

              const regiao =
                regioes[Math.floor(Math.random() * regioes.length)];
              const estadoList = estados[regiao];
              const estado =
                estadoList[Math.floor(Math.random() * estadoList.length)];
              const cidadeList = cidades[estado] || ["Cidade Principal"];
              const cidade =
                cidadeList[Math.floor(Math.random() * cidadeList.length)];

              const qtd = Math.random() * 5000 + 100;
              const valorUnit = Math.random() * 200 + 10;
              const total = qtd * valorUnit;

              const dataObj = new Date(ano, mes, dia);

              data.push({
                ano: ano,
                mes: mes + 1,
                mesNome: meses[mes],
                dia: dia,
                dataObj: dataObj,
                fornecedor: fornecedor,
                produto: produto,
                regiao: regiao,
                estado: estado,
                cidade: cidade,
                qtd: qtd,
                valorUnit: valorUnit,
                total: total,
                data: `${String(dia).padStart(2, "0")}/${String(
                  mes + 1
                ).padStart(2, "0")}/${ano}`,
              });
            }
          }
        }

        return data.sort((a, b) => b.dataObj - a.dataObj);
      };

      const formatCurrency = (value) => {
        return new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(value);
      };

      const formatNumber = (value) => {
        return new Intl.NumberFormat("pt-BR", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(value);
      };

      let allData = generateFakeData();
      let filteredData = [...allData];
      let currentPeriod = "all";

      // Filtrar dados por per√≠odo
      const filterByPeriod = (period) => {
        const now = new Date();
        let startDate = new Date(2020, 0, 1);
        let endDate = new Date(2025, 11, 31);

        switch (period) {
          case "1month":
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
          case "3months":
            startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
          case "6months":
            startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
          case "1year":
            startDate = new Date(now.getFullYear() - 1, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31);
            break;
          case "2years":
            startDate = new Date(now.getFullYear() - 2, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31);
            break;
          case "5years":
            startDate = new Date(now.getFullYear() - 5, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31);
            break;
          case "custom":
            const startInput = document.getElementById("startDate").value;
            const endInput = document.getElementById("endDate").value;
            if (startInput && endInput) {
              startDate = new Date(startInput);
              endDate = new Date(endInput);
            }
            break;
        }

        return allData.filter((item) => {
          return item.dataObj >= startDate && item.dataObj <= endDate;
        });
      };

      // Calcular compara√ß√£o com per√≠odo anterior
      const calculateComparison = (currentData, period) => {
        if (period === "all") return null;

        const now = new Date();
        let previousStart, previousEnd;

        switch (period) {
          case "1month":
            previousStart = new Date(now.getFullYear(), now.getMonth() - 2, 1);
            previousEnd = new Date(now.getFullYear(), now.getMonth() - 1, 0);
            break;
          case "3months":
            previousStart = new Date(now.getFullYear(), now.getMonth() - 6, 1);
            previousEnd = new Date(now.getFullYear(), now.getMonth() - 3, 0);
            break;
          case "6months":
            previousStart = new Date(now.getFullYear(), now.getMonth() - 12, 1);
            previousEnd = new Date(now.getFullYear(), now.getMonth() - 6, 0);
            break;
          case "1year":
            previousStart = new Date(now.getFullYear() - 2, 0, 1);
            previousEnd = new Date(now.getFullYear() - 2, 11, 31);
            break;
          default:
            return null;
        }

        const previousData = allData.filter((item) => {
          return item.dataObj >= previousStart && item.dataObj <= previousEnd;
        });

        const currentTotal = currentData.reduce(
          (sum, item) => sum + item.total,
          0
        );
        const previousTotal = previousData.reduce(
          (sum, item) => sum + item.total,
          0
        );
        const currentVolume = currentData.reduce(
          (sum, item) => sum + item.qtd,
          0
        );
        const previousVolume = previousData.reduce(
          (sum, item) => sum + item.qtd,
          0
        );

        return {
          custo: {
            current: currentTotal,
            previous: previousTotal,
            change:
              previousTotal > 0
                ? ((currentTotal - previousTotal) / previousTotal) * 100
                : 0,
          },
          volume: {
            current: currentVolume,
            previous: previousVolume,
            change:
              previousVolume > 0
                ? ((currentVolume - previousVolume) / previousVolume) * 100
                : 0,
          },
        };
      };

      // Calcular estat√≠sticas gerais
      const calculateStats = () => {
        const custoTotal = filteredData.reduce(
          (sum, item) => sum + item.total,
          0
        );
        const volumeTotal = filteredData.reduce(
          (sum, item) => sum + item.qtd,
          0
        );
        const produtosUnicos = new Set(filteredData.map((item) => item.produto))
          .size;

        // Principal fornecedor
        const fornecedoresMap = {};
        filteredData.forEach((item) => {
          if (!fornecedoresMap[item.fornecedor]) {
            fornecedoresMap[item.fornecedor] = { volume: 0, valor: 0 };
          }
          fornecedoresMap[item.fornecedor].volume += item.qtd;
          fornecedoresMap[item.fornecedor].valor += item.total;
        });

        const principalFornecedor = Object.entries(fornecedoresMap).sort(
          (a, b) => b[1].volume - a[1].volume
        )[0];

        document.getElementById("custoTotal").textContent =
          formatCurrency(custoTotal);
        document.getElementById("volumeTotal").textContent =
          formatNumber(volumeTotal);
        document.getElementById("principalFornecedor").textContent =
          principalFornecedor
            ? principalFornecedor[0].substring(0, 30) + "..."
            : "-";
        document.getElementById("volumeFornecedor").textContent =
          principalFornecedor
            ? `Volume: ${formatNumber(principalFornecedor[1].volume)}`
            : "Volume: 0";
        document.getElementById("totalProdutos").textContent = produtosUnicos;

        // Compara√ß√£o com per√≠odo anterior
        const comparison = calculateComparison(filteredData, currentPeriod);
        if (comparison) {
          const custoChange = document.getElementById("custoChange");
          const volumeChange = document.getElementById("volumeChange");

          if (comparison.custo.change !== 0) {
            custoChange.className = `stat-card-change ${
              comparison.custo.change > 0 ? "positive" : "negative"
            }`;
            custoChange.innerHTML = `
              <span>${comparison.custo.change > 0 ? "‚Üë" : "‚Üì"}</span>
              <span>${Math.abs(comparison.custo.change).toFixed(
                1
              )}% vs per√≠odo anterior</span>
            `;
          } else {
            custoChange.innerHTML = "";
          }

          if (comparison.volume.change !== 0) {
            volumeChange.className = `stat-card-change ${
              comparison.volume.change > 0 ? "positive" : "negative"
            }`;
            volumeChange.innerHTML = `
              <span>${comparison.volume.change > 0 ? "‚Üë" : "‚Üì"}</span>
              <span>${Math.abs(comparison.volume.change).toFixed(
                1
              )}% vs per√≠odo anterior</span>
            `;
          } else {
            volumeChange.innerHTML = "";
          }
        } else {
          document.getElementById("custoChange").innerHTML = "";
          document.getElementById("volumeChange").innerHTML = "";
        }

        // Atualizar per√≠odo nos cards
        const periodNames = {
          all: "Todos os per√≠odos",
          "1month": "√öltimo m√™s",
          "3months": "√öltimos 3 meses",
          "6months": "√öltimos 6 meses",
          "1year": "√öltimo ano",
          "2years": "√öltimos 2 anos",
          "5years": "√öltimos 5 anos",
          custom: "Per√≠odo customizado",
        };
        document.getElementById("custoPeriodo").textContent =
          periodNames[currentPeriod] || "Per√≠odo selecionado";
      };

      // Criar gr√°fico comparativo mensal
      const createComparativeChart = (interval = "monthly") => {
        try {
          // Sempre usar allData para o gr√°fico comparativo, pois precisamos dos 3 anos
          const dataToUse = allData;
          const anos = [2023, 2024, 2025];
          let labels = [];
          let dataStructure = {};

          if (interval === "monthly") {
            const meses = [
              "Jan",
              "Fev",
              "Mar",
              "Abr",
              "Mai",
              "Jun",
              "Jul",
              "Ago",
              "Set",
              "Out",
              "Nov",
              "Dez",
            ];
            labels = meses;
            meses.forEach((mes) => {
              dataStructure[mes] = { 2023: 0, 2024: 0, 2025: 0 };
            });

            dataToUse.forEach((item) => {
              if (anos.includes(item.ano) && dataStructure[item.mesNome]) {
                dataStructure[item.mesNome][item.ano] += item.total;
              }
            });
          } else if (interval === "quarterly") {
            labels = ["Q1", "Q2", "Q3", "Q4"];
            labels.forEach((q) => {
              dataStructure[q] = { 2023: 0, 2024: 0, 2025: 0 };
            });

            dataToUse.forEach((item) => {
              if (anos.includes(item.ano)) {
                const quarter = Math.floor((item.mes - 1) / 3);
                const qLabel = labels[quarter];
                if (dataStructure[qLabel]) {
                  dataStructure[qLabel][item.ano] += item.total;
                }
              }
            });
          } else if (interval === "yearly") {
            // Para compara√ß√£o anual, mostramos os anos lado a lado
            labels = ["2023", "2024", "2025"];
            labels.forEach((anoLabel) => {
              const anoNum = parseInt(anoLabel);
              dataStructure[anoLabel] = { 2023: 0, 2024: 0, 2025: 0 };

              dataToUse.forEach((item) => {
                if (item.ano === anoNum) {
                  dataStructure[anoLabel][anoNum] += item.total;
                }
              });
            });
          }

          // Calcular valor m√°ximo para escala
          const allValues = [];
          Object.values(dataStructure).forEach((item) => {
            anos.forEach((ano) => {
              if (item[ano] > 0) {
                allValues.push(item[ano]);
              }
            });
          });

          const maxVenda = allValues.length > 0 ? Math.max(...allValues) : 1;

          const chartContainer = document.getElementById("comparativeChart");
          if (!chartContainer) {
            console.error("Container do gr√°fico n√£o encontrado");
            return;
          }

          chartContainer.innerHTML = "";

          if (labels.length === 0) {
            chartContainer.innerHTML =
              '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">Nenhum dado dispon√≠vel para o per√≠odo selecionado</div>';
            return;
          }

          // Verificar se h√° dados para mostrar
          const hasData = Object.values(dataStructure).some((item) =>
            anos.some((ano) => item[ano] > 0)
          );

          if (!hasData && maxVenda === 1) {
            chartContainer.innerHTML =
              '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">Nenhum dado dispon√≠vel para os anos 2023-2025</div>';
            return;
          }

          labels.forEach((label) => {
            const monthGroup = document.createElement("div");
            monthGroup.className = "month-group";

            const barGroup = document.createElement("div");
            barGroup.className = "bar-group";

            anos.forEach((ano) => {
              const valor = dataStructure[label]
                ? dataStructure[label][ano] || 0
                : 0;
              // Calcular altura com m√≠nimo de 4px para barras vis√≠veis
              const alturaPercent = maxVenda > 0 ? (valor / maxVenda) * 100 : 0;
              const altura = Math.max(alturaPercent, valor > 0 ? 2 : 0); // M√≠nimo de 2% se houver valor

              const bar = document.createElement("div");
              bar.className = `bar bar-${ano}`;
              bar.style.height = `${altura}%`;
              bar.style.minHeight = valor > 0 ? "4px" : "0px";
              bar.style.display = valor > 0 || altura > 0 ? "block" : "none";
              bar.title = `${ano}: ${formatCurrency(valor)}`;

              barGroup.appendChild(bar);
            });

            const labelEl = document.createElement("div");
            labelEl.className = "bar-label";
            labelEl.textContent = label;

            monthGroup.appendChild(barGroup);
            monthGroup.appendChild(labelEl);
            chartContainer.appendChild(monthGroup);
          });
        } catch (error) {
          console.error("Erro ao criar gr√°fico:", error);
          const chartContainer = document.getElementById("comparativeChart");
          if (chartContainer) {
            chartContainer.innerHTML =
              '<div style="text-align: center; padding: 2rem; color: #e74c3c;">Erro ao carregar gr√°fico</div>';
          }
        }
      };

      // Renderizar top fornecedores
      const renderFornecedores = (anoFiltro = "all") => {
        const dataFiltrada =
          anoFiltro === "all"
            ? filteredData
            : filteredData.filter((item) => item.ano === parseInt(anoFiltro));

        const fornecedoresMap = {};
        dataFiltrada.forEach((item) => {
          if (!fornecedoresMap[item.fornecedor]) {
            fornecedoresMap[item.fornecedor] = { volume: 0, valor: 0 };
          }
          fornecedoresMap[item.fornecedor].volume += item.qtd;
          fornecedoresMap[item.fornecedor].valor += item.total;
        });

        const totalValor = Object.values(fornecedoresMap).reduce(
          (sum, f) => sum + f.valor,
          0
        );

        const topFornecedores = Object.entries(fornecedoresMap)
          .sort((a, b) => b[1].volume - a[1].volume)
          .slice(0, 10);

        const tbody = document.getElementById("fornecedoresBody");
        tbody.innerHTML = "";

        topFornecedores.forEach(([fornecedor, dados]) => {
          const row = document.createElement("tr");
          const percentual =
            totalValor > 0 ? (dados.valor / totalValor) * 100 : 0;
          row.innerHTML = `
            <td>${fornecedor.substring(0, 40)}${
            fornecedor.length > 40 ? "..." : ""
          }</td>
            <td>${formatNumber(dados.volume)}</td>
            <td><strong>${formatCurrency(dados.valor)}</strong></td>
            <td>${percentual.toFixed(1)}%</td>
          `;
          tbody.appendChild(row);
        });
      };

      // Renderizar produtos
      const renderProdutos = (anoFiltro = "all") => {
        const dataFiltrada =
          anoFiltro === "all"
            ? filteredData
            : filteredData.filter((item) => item.ano === parseInt(anoFiltro));

        const produtosMap = {};
        dataFiltrada.forEach((item) => {
          if (!produtosMap[item.produto]) {
            produtosMap[item.produto] = { volume: 0, valor: 0 };
          }
          produtosMap[item.produto].volume += item.qtd;
          produtosMap[item.produto].valor += item.total;
        });

        const totalValor = Object.values(produtosMap).reduce(
          (sum, p) => sum + p.valor,
          0
        );

        const topProdutos = Object.entries(produtosMap)
          .sort((a, b) => b[1].valor - a[1].valor)
          .slice(0, 10);

        const tbody = document.getElementById("produtosBody");
        tbody.innerHTML = "";

        topProdutos.forEach(([produto, dados]) => {
          const row = document.createElement("tr");
          const percentual =
            totalValor > 0 ? (dados.valor / totalValor) * 100 : 0;
          row.innerHTML = `
            <td>${produto}</td>
            <td>${formatNumber(dados.volume)}</td>
            <td><strong>${formatCurrency(dados.valor)}</strong></td>
            <td>${percentual.toFixed(1)}%</td>
          `;
          tbody.appendChild(row);
        });
      };

      // Renderizar geolocaliza√ß√£o
      const renderGeolocalizacao = (tipo = "regiao", anoFiltro = "all") => {
        const dataFiltrada =
          anoFiltro === "all"
            ? filteredData
            : filteredData.filter((item) => item.ano === parseInt(anoFiltro));

        const geoMap = {};
        dataFiltrada.forEach((item) => {
          const key =
            tipo === "regiao"
              ? item.regiao
              : tipo === "estado"
              ? item.estado
              : item.cidade;

          if (!geoMap[key]) {
            geoMap[key] = { volume: 0, valor: 0 };
          }
          geoMap[key].volume += item.qtd;
          geoMap[key].valor += item.total;
        });

        const topGeo = Object.entries(geoMap)
          .sort((a, b) => b[1].valor - a[1].valor)
          .slice(0, 12);

        const geoGrid = document.getElementById("geoGrid");
        geoGrid.innerHTML = "";

        topGeo.forEach(([local, dados]) => {
          const geoItem = document.createElement("div");
          geoItem.className = "geo-item";
          geoItem.innerHTML = `
            <div class="geo-item-title">${local}</div>
            <div class="geo-item-value">${formatCurrency(dados.valor)}</div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #7f8c8d;">
              Volume: ${formatNumber(dados.volume)}
            </div>
          `;
          geoGrid.appendChild(geoItem);
        });
      };

      // Atualizar dashboard
      const updateDashboard = () => {
        calculateStats();
        const intervalSelect = document.getElementById("chartInterval");
        const interval = intervalSelect ? intervalSelect.value : "monthly";
        createComparativeChart(interval);
        renderFornecedores();
        renderProdutos();
        renderGeolocalizacao();
      };

      // Event listeners para per√≠odo
      document.querySelectorAll(".period-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          if (e.target.id === "applyCustomPeriod") {
            currentPeriod = "custom";
            filteredData = filterByPeriod("custom");
          } else {
            currentPeriod = e.target.dataset.period;
            filteredData = filterByPeriod(currentPeriod);
          }

          document.querySelectorAll(".period-btn").forEach((b) => {
            b.classList.remove("active");
          });
          if (e.target.id !== "applyCustomPeriod") {
            e.target.classList.add("active");
          }

          updateDashboard();
        });
      });

      // Event listeners para filtros
      document
        .getElementById("chartInterval")
        .addEventListener("change", (e) => {
          createComparativeChart(e.target.value);
        });

      document
        .getElementById("yearFilterFornecedor")
        .addEventListener("change", (e) => {
          renderFornecedores(e.target.value);
        });

      document
        .getElementById("yearFilterProduto")
        .addEventListener("change", (e) => {
          renderProdutos(e.target.value);
        });

      document.getElementById("geoFilter").addEventListener("change", (e) => {
        const anoFiltro = document.getElementById("yearFilterGeo").value;
        renderGeolocalizacao(e.target.value, anoFiltro);
      });

      document
        .getElementById("yearFilterGeo")
        .addEventListener("change", (e) => {
          const tipoFiltro = document.getElementById("geoFilter").value;
          renderGeolocalizacao(tipoFiltro, e.target.value);
        });

      // Inicializar dashboard
      updateDashboard();
    </script>
  </body>
</html>
