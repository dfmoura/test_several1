# Objetivos
```markdown


```

### 1. Log's Execução



#### 1.1. 25/04/2024 08:00 as 12:00
```markdown

Satis - Analise de Verbas - Iniciamos o dia com a estruturação inicial do primeiro SELECT para movimentação em real. Agora, temos uma base sólida para começar a implementar a função F_ANO_SAFRA, crucial para derivar o ano da safra com base nas datas das movimentações. Além disso, estamos integrando o entendimento de valor comprometido e realizado com as provisões, garantindo uma análise abrangente e precisa das verbas. Também estamos avançando na adição de parâmetros que permitirão filtrar o regime de caixa ou regime por competência na estrutura da movimentação real. Essa flexibilidade será fundamental para atender às diversas necessidades de relatórios e análises dos usuários.


```

#### 1.1. 25/04/2024 13:30 as 18:00
```markdown

Satis - Analise de Verbas - Continuamos aprimorando a estrutura principal do SELECT para movimentação real. Uma das principais adições é a inclusão de novos campos, como AD_TIPVERBA, AD_REGIAO, AD_CODVENDRTV, AD_LINHAPROD1, AD_LINHAPROD2 e AD_LINHAPROD3. Esses campos são essenciais para o preenchimento e atualização das visões correspondentes, garantindo uma visão abrangente e detalhada das movimentações. Além disso, estamos delimitando a partir da raiz 8 de projetos para abranger o dashboard como um todo. Essa abordagem garantirá que todas as informações relevantes sejam consideradas e apresentadas de forma integrada no dashboard, proporcionando uma análise completa e coerente dos dados.

```



#### 1.1. 26/04/2024 08:00 as 12:00
```markdown

Satis - Analise de Verbas - Concluída a estruturação inicial do primeiro SELECT de movimentação em real.  Implementação da função F_ANO_SAFRA para obtenção do ano da safra com base na data da movimentação. Integramos o entendimento de valor comprometido e realizado com as provisões.
Adicionamos os parâmetros para filtrar regime de caixa ou regime por competência na estrutura da movimentação real.

```

#### 1.1. 26/04/2024 13:30 as 18:00
```markdown

Satis - Analise de Verbas - Continuação da estrutura principal do SELECT para movimentação real.
Adição dos novos campos (AD_TIPVERBA, AD_REGIAO, AD_CODVENDRTV, AD_LINHAPROD1, AD_LINHAPROD2, AD_LINHAPROD3) para preenchimento e atualização das visões correspondentes. Delimitação a partir da raiz 8 de projetos para abranger o dashboard como um todo.

```

#### 1.1. 29/04/2024 08:00 as 11:30
```markdown

Satis - Analise de Verbas - Concluído o SELECT da movimentação real. Início da estruturação do orçado a partir da tabela de meta, utilizando o código 10 como escopo. Criação dos filtros padrões da movimentação real.

```

#### 1.1. 29/04/2024 13:00 as 18:00
```markdown
Satis - Analise de Verbas - Iniciada a criação da primeira visão, um gráfico de colunas.
Desenvolvimento de um SELECT UNION ALL da estrutura padrão do real versus budget.
Implementação de um nível de detalhamento para decomposição do valor consolidado.

```

#### 1.1. 30/04/2024 08:00 as 12:00
```markdown
Satis - Analise de Verbas - Continuação da criação da primeira visão. Desenvolvimento de três botões para acessar os níveis inferiores de detalhamento.

```

#### 1.1. 30/04/2024 13:30 as 18:20
```markdown
Satis - Analise de Verbas - Conclusão da primeira visão. Desenvolvimento do primeiro botão para acesso à tela de valores, incluindo um componente de velocímetro e um gráfico de barras. Desenvolvimento do segundo botão para acesso à tela de participação, com três componentes, incluindo gráficos de donut.


```

#### 1.1. 01/05/2024 08:00 as 12:00
```markdown
Satis - Analise de Verbas - Desenvolvimento do terceiro botão para acesso ao último nível, com a característica de investimento. Criação de três componentes, incluindo gráficos de barras, para demonstrar investimentos por região, por RTV e por linhas cadastradas.


```

#### 1.1. 29/04/2024 13:00 as 18:30
```markdown
Satis - Analise de Verbas - Realização de ajustes na tabela detalhe do gráfico principal. Correção no agrupamento para o gráfico de velocímetro. Implementação da função de identificação de pilar. Correção no cálculo do saldo do budget no gráfico de saldo por budget. Ajuste no primeiro gráfico para exibir campos nulos de ad_tipverba quando nada for marcado. Correção do detalhamento no dashboard principal para visualização tanto do realizado quanto do comprometido. Atualização do filtro padrão de where no realizado para todos os gráficos.

```

























ESTRUTURAÇÃO INICIAL DO PRIMERO SELECT DE MOVIMENTAÇÃO EM REAL, CRIAMOS UMA FUNÇÃO F_ANO_SAFRA QUE DE ACORDO COM A DATA DA MOVIMENTAÇÃO ELE IRA FORNECER O ANO DA SAFRA POR EXEMPLO 2023-2024. 

Foi criado tambem na estrutura do select da movimentação real o entendimento de valor comprometido provisao = 'S' e realizado provisao = 'N'. 

Continuando na estrutura da movimentação real criamos os parametros para filtrar quando for regime de caixa ou regime por competencia. No caixa abrange lançamentos a partir da DTVENC e DHBAIXO, Na competencia abrange lançamentos a partir da DTNEG.

Continuando na estrutra principal do select para a movimentação real, tivemos que adicionar os novos campos que começarao a ser preenchido (AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 ), de modos que nossas visões abranjam estes campos com seus respectivos filtros.

Tivemos tambem que adicinar uma delimitacao a partir da raiz 8 de projetos que abrange o dashborad como um todo.


Feito o select da movimentação real, iniciamos com o orçado a partir da estrutura da tabela de meta cujo código definido para o escopo foi o 10 no qual geramos um select padrão.

Criamos tambem os filtros padrões da movimentação real, sendo a verificação se é regime de competencia ou caixa (check box), o tipo de verba (single list), região(multlist), vendedor rtv(multlist) e natureza(multlist).


Iniciamos a criação da primeira visão que se caracteriza por um grafico de colunas que contempla a posição mensal de comprometido e realizado versus o budget. foi basicamente um select union all de nossa estrutura padrão do real versus budget.

Criamos tambem um nivel de detalhamento acessado a partir do clique na coluna realizada ou comprometida do grafico, com informações pertinente para decomposição do valor consolidado.

Nesta tela principal tambem criamos tres botões que dão acesso aos niveis inferios para detalhar valores, paticipação e investimento.

O primeito botão que leva a tela de valores, criamos um componente de velocimetro replicando o comportamento da planilha apresentada pelo cliente, adicionamos as faixas de valor, e no select fizemos o calculo de quanto o realizado e compromentido participa da meta.

no segundo componente criamos um grafico de barras cujos select agrupa os pilares por realizado + comprometio e budget.

no terceiro componente criamos outro grafico de barras cujo select expande o detalhamento do pilar em projeto, demonstrando o saldo do budget em relação ao realizado + comprometido.

no segundo botao criamos outros tres componentes com a carcteristica de participação, no primeiro componente um utilizamos o select principal da movimentação em real e extraimos o tipo de verba aprentado em um grafico de donut. 

no segundo componente em nosso select utilizamos a estrutura do select principal em real e extraimos a participação de cada pilar e um grafico de donut.

no terceiro componente criamos um select utilizando a mesma estrutura do select de movimentação real e expadimos a analise para trazer a participacao por projeto, tambem em um grafico de donut.

no terceiro botão e ultimo nivel, com uma caracteristica de investimento, criamos tres componentes tambem. Fizemos nosso select para o primeiro componente abrangendo o valor investido por regiao, utilizando a estrutura para do select da movimentação real, apresentamos a informação em um grafico de barras.

No segundo componente criamos um select para demonstrar a posição de investimento por rtv, tambem recuperamos a informação para ser apresentada em um grafico de barras.

No terceiro e ultimo componente criamos um select que distribui o valor realizado + comprometido para as linhas cadastradas no ato da geração do pedido. A partir de proporcão criada em nosso select recuperamos a informação de valores gastos por linha e apresentamos em um grafico de barras.


realizamos AJUSTE NA TABELA DETALHE do grafico pricipal.

realizamos correção no agrupamento para grafico de VELOCIMENTRO.

criamos função de identificação de pilar.

fizemos correção no calculo do saldo budget do grafico saldo por budget.

corrigimos o primeiro grafico quando nao marcar nada trazer tambem os campos nulos de ad_tipverba

efetuamos correção de DETALHAMENTO do dash principal que AGORA TANTO O REALIZADO QUANTO O COMPROMETIDO SAO POSSIVEIS DE VISUALIZAR O DETALHAMENTO.

atualizamos o filtro padrão de where no realizado para todos os graficos.

FIZ O FITRO TIPO VERBA
AND (
    (:P_TIPVERBA = 'V' OR :P_TIPVERBA IS NULL) AND CAB.AD_TIPVERBA IS NULL
    OR (:P_TIPVERBA = 'M' AND CAB.AD_TIPVERBA = 'M')
    OR (:P_TIPVERBA = 'T' AND CAB.AD_TIPVERBA = 'T')
    OR (:P_TIPVERBA = 'M_T' AND CAB.AD_TIPVERBA IN ('M', 'T'))
)


FAZER O FILTRO REGIAO

AND (CAB.AD_REGIAO IN :P_REGIAO)


FAZER O FILTRO DE RTV
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)


FAZER O FILTRO DE linha produto
*DEPOIS COM CALMA PENSAR ALGO MAIS MULTILATERAL NESTE OR....

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)


fazer filtro de natureza ANALITICA
SELECT 
CAB.CODNAT AS VALUE,
CAB.CODNAT||' - '||NAT.DESCRNAT AS LABEL
FROM TGFCAB CAB
INNER JOIN TGFNAT NAT ON CAB.CODNAT = NAT.CODNAT
GROUP BY CAB.CODNAT,NAT.DESCRNAT
ORDER BY 1

MULTILIST
AND (VGF.CODNAT IN :P_CODNAT)

--------------------------------------------------------------------------------------------

AJUSTE NA TABELA DETALHE

WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL

FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA


WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'


AND (
    (:P_TIPVERBA = 'V' OR :P_TIPVERBA IS NULL) AND CAB.AD_TIPVERBA IS NULL
    OR (:P_TIPVERBA = 'M' AND CAB.AD_TIPVERBA = 'M')
    OR (:P_TIPVERBA = 'T' AND CAB.AD_TIPVERBA = 'T')
    OR (:P_TIPVERBA = 'M_T' AND CAB.AD_TIPVERBA IN ('M', 'T'))
)

AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)

AND (
	(:P_REG_COMP = 'N' AND TO_CHAR(COALESCE(VGF.DHBAIXA, VGF.DTVENC),'MM-YYYY') = :A_MES_ANO)
	OR (:P_REG_COMP = 'S' AND TO_CHAR(VGF.DTNEG,'MM-YYYY') = :A_MES_ANO)
)


--------------------------------------------------------------------------

GERAR NOVO VELOCIMENTRO

SELECT
ANO,
MES,
MES_ANO,
ANO_SAFRA,
SUM(VLRPREV) AS VLRPREV,
SUM(VLRREAL) AS VLRREAL,
SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO,
SUM(NULLIF((VLRREAL+VLRCOMPROMETIDO),0))/NULLIF(SUM(VLRPREV),0) * 100 AS PERC
FROM
(
SELECT
	ANO,
	MES,
	MES_ANO,
	ANO_SAFRA,
	0 AS VLRPREV,
	SUM(VLRREAL) AS VLRREAL,
	SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO
FROM
(	
SELECT
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'YYYY') ELSE TO_CHAR(DTNEG,'YYYY') END) AS ANO,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM')  ELSE TO_CHAR(DTNEG,'MM') END) AS MES,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM-YYYY') ELSE TO_CHAR(DTNEG,'MM-YYYY') END) AS MES_ANO,
ANO_SAFRA,
0 AS VLRPREV,
VLRREAL,
VLRCOMPROMETIDO
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL

FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA


WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'


AND (
    (:P_TIPVERBA = 'V' OR :P_TIPVERBA IS NULL) AND CAB.AD_TIPVERBA IS NULL
    OR (:P_TIPVERBA = 'M' AND CAB.AD_TIPVERBA = 'M')
    OR (:P_TIPVERBA = 'T' AND CAB.AD_TIPVERBA = 'T')
    OR (:P_TIPVERBA = 'M_T' AND CAB.AD_TIPVERBA IN ('M', 'T'))
)

AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)
)
)
GROUP BY
ANO,
MES,
MES_ANO,
ANO_SAFRA



UNION ALL 


SELECT
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
ANO_SAFRA,
SUM(PREVDESP) AS VLRPREV,
0 AS VLRREAL,
0 AS VLRCOMPROMETIDO
FROM
(
SELECT
MET.CODMETA,
MET.DTREF,
F_ANO_SAFRA(MET.DTREF) AS ANO_SAFRA,
MET.CODPROJ,
MET.PREVDESP
FROM TGFMET MET
WHERE 
MET.CODMETA = 10
AND SUBSTR(MET.CODPROJ, 1, 1) = '8'
AND F_ANO_SAFRA(MET.DTREF) = :P_ANO_SAFRA
)
GROUP BY
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY'),
ANO_SAFRA
)
GROUP BY ANO,MES,MES_ANO,ANO_SAFRA
ORDER BY 1,2

-------------------------------------------------------------------------------------------

GERAR GRAFICO realizado + comprometido x budget por pilar
SUBIR A FUNCAO DE IDENTIFICACAO


CREATE OR REPLACE FUNCTION F_IDENTIFICACAO (parametro IN NUMBER)
RETURN VARCHAR2
IS
  identificacao_resultado VARCHAR2(100); -- Defina o tamanho apropriado para o seu campo IDENTIFICACAO
BEGIN
  SELECT IDENTIFICACAO
  INTO identificacao_resultado
  FROM TCSPRJ
  WHERE CODPROJ = parametro;

  RETURN identificacao_resultado;
EXCEPTION
  WHEN NO_DATA_FOUND THEN
    RETURN NULL; -- ou outra lógica de tratamento de erro conforme necessário
END;
/





SELECT
F_NIVEL2_DESC(CODPROJ) AS IDENTIFICACAO,
SUM(VLRPREV) AS VLRPREV,
SUM(VLRREAL) AS VLRREAL,
SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO,
SUM(VLRREAL) + SUM(VLRCOMPROMETIDO) AS VLR_REAL_COMPRO
FROM
(
SELECT
	ANO,
	MES,
	MES_ANO,
	ANO_SAFRA,
	CODPROJ,
	0 AS VLRPREV,
	SUM(VLRREAL) AS VLRREAL,
	SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO
FROM
(	
SELECT
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'YYYY') ELSE TO_CHAR(DTNEG,'YYYY') END) AS ANO,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM')  ELSE TO_CHAR(DTNEG,'MM') END) AS MES,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM-YYYY') ELSE TO_CHAR(DTNEG,'MM-YYYY') END) AS MES_ANO,
ANO_SAFRA,
CODPROJ,
0 AS VLRPREV,
VLRREAL,
VLRCOMPROMETIDO
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL

FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA

WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'

AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)

AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)
)
)
GROUP BY
ANO,
MES,
MES_ANO,
ANO_SAFRA,
CODPROJ



UNION ALL 


SELECT
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
ANO_SAFRA,
CODPROJ,
SUM(PREVDESP) AS VLRPREV,
0 AS VLRREAL,
0 AS VLRCOMPROMETIDO
FROM
(
SELECT
MET.CODMETA,
MET.DTREF,
F_ANO_SAFRA(MET.DTREF) AS ANO_SAFRA,
MET.CODPROJ,
MET.PREVDESP
FROM TGFMET MET
WHERE 
MET.CODMETA = 10
AND SUBSTR(MET.CODPROJ, 1, 1) = '8'
AND F_ANO_SAFRA(MET.DTREF) = :P_ANO_SAFRA
)
GROUP BY
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY'),
ANO_SAFRA,
CODPROJ
) 


GROUP BY F_NIVEL2_DESC(CODPROJ)
ORDER BY 1,2



---------------------------------------------------------------------------------------
CRIAR GRAFICO SALDO BUDGET POR PROJETO



SELECT
A.CODPROJ,
PRJ.IDENTIFICACAO,
SUM(VLRPREV) - (SUM(VLRREAL) + SUM(VLRCOMPROMETIDO)) AS SALDO
FROM
(
SELECT
	ANO,
	MES,
	MES_ANO,
	ANO_SAFRA,
	CODPROJ,
	0 AS VLRPREV,
	SUM(VLRREAL) AS VLRREAL,
	SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO
FROM
(	
SELECT
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'YYYY') ELSE TO_CHAR(DTNEG,'YYYY') END) AS ANO,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM')  ELSE TO_CHAR(DTNEG,'MM') END) AS MES,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM-YYYY') ELSE TO_CHAR(DTNEG,'MM-YYYY') END) AS MES_ANO,
ANO_SAFRA,
CODPROJ,
0 AS VLRPREV,
VLRREAL,
VLRCOMPROMETIDO
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL

FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA

WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'

AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)

AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)
)
)
GROUP BY
ANO,
MES,
MES_ANO,
ANO_SAFRA,
CODPROJ



UNION ALL 


SELECT
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
ANO_SAFRA,
CODPROJ,
SUM(PREVDESP) AS VLRPREV,
0 AS VLRREAL,
0 AS VLRCOMPROMETIDO
FROM
(
SELECT
MET.CODMETA,
MET.DTREF,
F_ANO_SAFRA(MET.DTREF) AS ANO_SAFRA,
MET.CODPROJ,
MET.PREVDESP
FROM TGFMET MET
WHERE 
MET.CODMETA = 10
AND SUBSTR(MET.CODPROJ, 1, 1) = '8'
AND F_ANO_SAFRA(MET.DTREF) = :P_ANO_SAFRA
)
GROUP BY
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY'),
ANO_SAFRA,
CODPROJ
) A
INNER JOIN TCSPRJ PRJ ON A.CODPROJ = PRJ.CODPROJ
GROUP BY A.CODPROJ,PRJ.IDENTIFICACAO
ORDER BY 1,2

-------------------------------------------------------------------------


base para consulta de pedidos
SELECT
NUNOTA,TIPMOV,AD_TIPVERBA,CODPROJ,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3
FROM TGFCAB
WHERE AD_TIPVERBA IS NOT NULL AND TIPMOV='O'


------------------------------------------------------------------------
grafico participação por tipo verba


SELECT
TIPVERBA,
SUM(VLR_REAL_COMPR) AS VLR_REAL_COMPR
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA


WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'
AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)

)
GROUP BY TIPVERBA



------------------------------------------------------------------------
grafico participação por pilar

SELECT
F_NIVEL2_DESC(CODPROJ) PILAR,
SUM(VLR_REAL_COMPR) AS VLR_REAL_COMPR
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA


WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'
AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)

)
GROUP BY F_NIVEL2_DESC(CODPROJ)



------------------------------------------------------------------------------------------
grafico participação por projeto top 10


SELECT
IDENTIFICACAO AS PILAR,
SUM(VLR_REAL_COMPR) AS VLR_REAL_COMPR
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
PRJ.IDENTIFICACAO,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA
INNER JOIN TCSPRJ PRJ ON VGF.CODPROJ = PRJ.CODPROJ

WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'
AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)

)
GROUP BY IDENTIFICACAO


------------------------------------------------------------------------------------------
grafico VALORES INVESTIDOS POR REGIAO




SELECT
NOMEREG AS NOMEREG,
SUM(VLR_REAL_COMPR) AS VLR_REAL_COMPR
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,REG.NOMEREG,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 
FROM TGFCAB
INNER JOIN TSIREG REG ON TGFCAB.AD_REGIAO = REG.CODREG)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.NOMEREG,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
PRJ.IDENTIFICACAO,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA
INNER JOIN TCSPRJ PRJ ON VGF.CODPROJ = PRJ.CODPROJ


WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'
AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)

AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)

AND (VGF.CODNAT IN :P_CODNAT)

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)

)
GROUP BY NOMEREG

ORDER BY 1




-----------------------------------------------------------------------
valores investidos por rtv (top 10)

SELECT *
FROM (
SELECT
APELIDO AS VENDRTV,
SUM(VLR_REAL_COMPR) AS VLR_REAL_COMPR
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,VEN.APELIDO,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 
FROM TGFCAB
INNER JOIN TGFVEN VEN ON TGFCAB.AD_CODVENDRTV = VEN.CODVEND)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.APELIDO,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
PRJ.IDENTIFICACAO,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA
INNER JOIN TCSPRJ PRJ ON VGF.CODPROJ = PRJ.CODPROJ
WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'
AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)
AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)
AND (VGF.CODNAT IN :P_CODNAT)
AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)
)
GROUP BY APELIDO
) 
WHERE ROWNUM <= 10
ORDER BY 1



----------------------------------------------------
grafico valores investidos por linha de produto

SELECT
COALESCE(TRIM(MARCA), 'VAZIO') AS MARCA,
SUM(VLR) AS VLR
FROM
(

SELECT
MARCA AS MARCA,
SUM(VLR_REAL_COMPR/3) AS VLR

FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,MAR.MARCA,AD_LINHAPROD2,MAR1.MARCA AS MARCA1,AD_LINHAPROD3,MAR2.MARCA AS MARCA2 
FROM TGFCAB
LEFT JOIN AD_VGFMARCA MAR ON TGFCAB.AD_LINHAPROD1 = MAR.SEQ
LEFT JOIN AD_VGFMARCA MAR1 ON TGFCAB.AD_LINHAPROD2 = MAR1.SEQ
LEFT JOIN AD_VGFMARCA MAR2 ON TGFCAB.AD_LINHAPROD3 = MAR2.SEQ

)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.MARCA,
CAB.AD_LINHAPROD2,
CAB.MARCA1,
CAB.AD_LINHAPROD3,
CAB.MARCA2,
VGF.CODNAT,
VGF.CODPROJ,
PRJ.IDENTIFICACAO,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,

(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA
INNER JOIN TCSPRJ PRJ ON VGF.CODPROJ = PRJ.CODPROJ
WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'

AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)
AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)
AND (VGF.CODNAT IN :P_CODNAT)
AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)
)

GROUP BY MARCA

UNION ALL


SELECT
MARCA1 AS MARCA,
SUM(VLR_REAL_COMPR/3) AS VLR

FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,MAR.MARCA,AD_LINHAPROD2,MAR1.MARCA AS MARCA1,AD_LINHAPROD3,MAR2.MARCA AS MARCA2 
FROM TGFCAB
LEFT JOIN AD_VGFMARCA MAR ON TGFCAB.AD_LINHAPROD1 = MAR.SEQ
LEFT JOIN AD_VGFMARCA MAR1 ON TGFCAB.AD_LINHAPROD2 = MAR1.SEQ
LEFT JOIN AD_VGFMARCA MAR2 ON TGFCAB.AD_LINHAPROD3 = MAR2.SEQ

)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.MARCA,
CAB.AD_LINHAPROD2,
CAB.MARCA1,
CAB.AD_LINHAPROD3,
CAB.MARCA2,
VGF.CODNAT,
VGF.CODPROJ,
PRJ.IDENTIFICACAO,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA
INNER JOIN TCSPRJ PRJ ON VGF.CODPROJ = PRJ.CODPROJ
WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'

AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)
AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)
AND (VGF.CODNAT IN :P_CODNAT)
AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)
)

GROUP BY MARCA1


UNION ALL



SELECT
MARCA2 AS MARCA,
SUM(VLR_REAL_COMPR/3) AS VLR
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,MAR.MARCA,AD_LINHAPROD2,MAR1.MARCA AS MARCA1,AD_LINHAPROD3,MAR2.MARCA AS MARCA2 
FROM TGFCAB
LEFT JOIN AD_VGFMARCA MAR ON TGFCAB.AD_LINHAPROD1 = MAR.SEQ
LEFT JOIN AD_VGFMARCA MAR1 ON TGFCAB.AD_LINHAPROD2 = MAR1.SEQ
LEFT JOIN AD_VGFMARCA MAR2 ON TGFCAB.AD_LINHAPROD3 = MAR2.SEQ

)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
CAB.AD_TIPVERBA,
COALESCE(F_DESCROPC('TGFCAB','AD_TIPVERBA',CAB.AD_TIPVERBA),'Vazio') AS TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.MARCA,
CAB.AD_LINHAPROD2,
CAB.MARCA1,
CAB.AD_LINHAPROD3,
CAB.MARCA2,
VGF.CODNAT,
VGF.CODPROJ,
PRJ.IDENTIFICACAO,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,
(VGF.VLRDESDOB + VGF.VLRBAIXA)*-1 VLR_REAL_COMPR
FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA
INNER JOIN TCSPRJ PRJ ON VGF.CODPROJ = PRJ.CODPROJ
WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'




AND (CAB.AD_TIPVERBA IN :P_TIPVERBA)
AND (CAB.AD_REGIAO IN :P_REGIAO)
AND (CAB.AD_CODVENDRTV IN :P_CODVENDRTV)
AND (CAB.AD_LINHAPROD1 = :P_LINHAPROD1 OR :P_LINHAPROD1 IS NULL)
AND (CAB.AD_LINHAPROD2 = :P_LINHAPROD2 OR :P_LINHAPROD2 IS NULL)
AND (CAB.AD_LINHAPROD3 = :P_LINHAPROD3 OR :P_LINHAPROD3 IS NULL)
AND (VGF.CODNAT IN :P_CODNAT)
AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)
)

GROUP BY MARCA2

)
GROUP BY MARCA
ORDER BY 2 DESC



-----------------------------------------------------------------
arrumando o primeiro grafico quando nao marcar nada trazer tambem os campos nulos de ad_tipverba

1) COLOQUEI O TRIM NO AD_TIPVERBA

correção no ad_tipverba:
COALESCE(TRIM(AD_TIPVERBA),'V') AS AD_TIPVERBA,

correção no SINGLELIST do P_TIPVERBA:
V=Vazio
M=Marketing
T=Trade
M_T=Marketing e Trade
M_T_V= Marketing e Trade + Vazio


CORREÇÃO NO WHERE DO AD_TIPVERBA:
AND( 
((:P_TIPVERBA = 'V' OR :P_TIPVERBA IS NULL) AND CAB.AD_TIPVERBA IS NULL)
OR (:P_TIPVERBA = 'M' AND CAB.AD_TIPVERBA = 'M')
OR (:P_TIPVERBA = 'T' AND CAB.AD_TIPVERBA = 'T')
OR (:P_TIPVERBA = 'M_T' AND CAB.AD_TIPVERBA IN ('M', 'T'))
OR (:P_TIPVERBA = 'M_T_V' AND (AD_TIPVERBA IN ('M', 'T') OR TRIM(AD_TIPVERBA) IS NULL))
)

verificar se filtro de regiao, RTV E NAT esta ok E CORRIGIR:

AND ((CAB.AD_REGIAO IN :P_REGIAO) OR TRIM(CAB.AD_REGIAO) IS NULL)

AND ((CAB.AD_CODVENDRTV IN :P_CODVENDRTV) OR TRIM(CAB.AD_CODVENDRTV) IS NULL)

AND ((VGF.CODNAT IN :P_CODNAT) OR TRIM(VGF.CODNAT) IS NULL)


--------------------------------------------------------------------------
CORRIGIR DETALHAMENTO 
AGORA TANTO O REALIZADO QUANTO O COMPROMETIDO SAO POSSIVEIS DE VISUALIZAR O DETALHAMENTO


WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
TRIM(CAB.AD_TIPVERBA) AS AD_TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL,

(CASE 
WHEN VGF.PROVISAO = 'S' THEN 'COMPROMETIDO'
WHEN VGF.PROVISAO = 'N' THEN 'REALIZADO' END) AS TIPVALOR

FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA


WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)

AND( 
((:P_TIPVERBA = 'V' OR :P_TIPVERBA IS NULL) AND CAB.AD_TIPVERBA IS NULL)
OR (:P_TIPVERBA = 'M' AND CAB.AD_TIPVERBA = 'M')
OR (:P_TIPVERBA = 'T' AND CAB.AD_TIPVERBA = 'T')
OR (:P_TIPVERBA = 'M_T' AND CAB.AD_TIPVERBA IN ('M', 'T'))
OR (:P_TIPVERBA = 'M_T_V' AND (CAB.AD_TIPVERBA IN ('M', 'T') OR TRIM(CAB.AD_TIPVERBA) IS NULL))
)





AND ((CAB.AD_REGIAO IN :P_REGIAO) OR TRIM(CAB.AD_REGIAO) IS NULL)

AND ((CAB.AD_CODVENDRTV IN :P_CODVENDRTV) OR TRIM(CAB.AD_CODVENDRTV) IS NULL)

AND ((VGF.CODNAT IN :P_CODNAT) OR TRIM(VGF.CODNAT) IS NULL)



AND (
	(:P_REG_COMP = 'N' AND TO_CHAR(COALESCE(VGF.DHBAIXA, VGF.DTVENC),'MM-YYYY') = :A_MES_ANO)
	OR (:P_REG_COMP = 'S' AND TO_CHAR(VGF.DTNEG,'MM-YYYY') = :A_MES_ANO)
)

AND 
(CASE 
WHEN VGF.PROVISAO = 'S' THEN 'COMPROMETIDO'
WHEN VGF.PROVISAO = 'N' THEN 'REALIZADO' END) = :A_TIPVALOR




--------------------------------------------------------------------------------







-----------------------------------------------------------------
ARRUMAR O AGRUPAMENTO DO VELOCIMETRO

corrido tambem o valor percentual
((SUM(VLRREAL) + SUM(VLRCOMPROMETIDO)) / NULLIF(SUM(VLRPREV), 0)) * 100 AS PERC


corrigimos o SELECT e criamos um outros select para detalhar o valor percentual apresentado
SUM(VLRREAL) AS VLRREAL,
SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO,
SUM(VLRPREV) AS VLRPREV,
((SUM(VLRREAL) + SUM(VLRCOMPROMETIDO)) / NULLIF(SUM(VLRPREV), 0)) * 100 AS PERC



SELECT
((SUM(VLRREAL) + SUM(VLRCOMPROMETIDO)) / NULLIF(SUM(VLRPREV), 0)) * 100 AS PERC
FROM
(


SELECT
ANO,
MES,
MES_ANO,
ANO_SAFRA,
SUM(VLRPREV) AS VLRPREV,
SUM(VLRREAL) AS VLRREAL,
SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO
FROM
(
SELECT
	ANO,
	MES,
	MES_ANO,
	ANO_SAFRA,
	0 AS VLRPREV,
	SUM(VLRREAL) AS VLRREAL,
	SUM(VLRCOMPROMETIDO) AS VLRCOMPROMETIDO
FROM
(	
SELECT
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'YYYY') ELSE TO_CHAR(DTNEG,'YYYY') END) AS ANO,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM')  ELSE TO_CHAR(DTNEG,'MM') END) AS MES,
(CASE WHEN :P_REG_COMP = 'N' THEN TO_CHAR(COALESCE(DHBAIXA, DTVENC),'MM-YYYY') ELSE TO_CHAR(DTNEG,'MM-YYYY') END) AS MES_ANO,
ANO_SAFRA,
0 AS VLRPREV,
VLRREAL,
VLRCOMPROMETIDO
FROM
(
WITH 
FIN AS (SELECT NUFIN, NUNOTA, DESDOBRAMENTO, VLRDESDOB FROM TGFFIN),
CAB AS (SELECT NUNOTA, CODTIPOPER,AD_TIPVERBA,AD_REGIAO,AD_CODVENDRTV,AD_LINHAPROD1,AD_LINHAPROD2,AD_LINHAPROD3 FROM TGFCAB)
SELECT
VGF.NUFIN,
FIN.DESDOBRAMENTO,
FIN.NUNOTA,
VGF.NUMNOTA,
TRIM(CAB.AD_TIPVERBA) AS AD_TIPVERBA,
CAB.AD_REGIAO,
CAB.AD_CODVENDRTV,
CAB.AD_LINHAPROD1,
CAB.AD_LINHAPROD2,
CAB.AD_LINHAPROD3,
VGF.CODNAT,
VGF.CODPROJ,
VGF.CODCENCUS,
CAB.CODTIPOPER,
VGF.DTNEG,
VGF.DTVENC,
VGF.DHBAIXA,
(CASE 
WHEN :P_REG_COMP = 'N' THEN COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC))
WHEN :P_REG_COMP = 'S' THEN F_ANO_SAFRA(VGF.DTNEG)
END) AS ANO_SAFRA,
VGF.PROVISAO,
FIN.VLRDESDOB,
VGF.VLRBAIXA * -1 AS VLRBAIXA,
(CASE WHEN VGF.PROVISAO = 'S' THEN  VGF.VLRDESDOB * -1 END) AS VLRCOMPROMETIDO,
(CASE WHEN VGF.PROVISAO = 'N' THEN  VGF.VLRBAIXA * -1 END) AS VLRREAL

FROM VGF_RESULTADO_PROV_SATIS VGF
LEFT JOIN FIN ON VGF.NUFIN = FIN.NUFIN
LEFT JOIN CAB ON FIN.NUNOTA = CAB.NUNOTA


WHERE
VGF.RECDESP = -1
AND SUBSTR(VGF.CODPROJ, 1, 1) = '8'

AND (
	(:P_REG_COMP = 'N' AND COALESCE(F_ANO_SAFRA(VGF.DHBAIXA), F_ANO_SAFRA(VGF.DTVENC)) = :P_ANO_SAFRA)
	OR (:P_REG_COMP = 'S' AND F_ANO_SAFRA(VGF.DTNEG) = :P_ANO_SAFRA)
)

AND( 
((:P_TIPVERBA = 'V' OR :P_TIPVERBA IS NULL) AND CAB.AD_TIPVERBA IS NULL)
OR (:P_TIPVERBA = 'M' AND CAB.AD_TIPVERBA = 'M')
OR (:P_TIPVERBA = 'T' AND CAB.AD_TIPVERBA = 'T')
OR (:P_TIPVERBA = 'M_T' AND CAB.AD_TIPVERBA IN ('M', 'T'))
OR (:P_TIPVERBA = 'M_T_V' AND (CAB.AD_TIPVERBA IN ('M', 'T') OR TRIM(CAB.AD_TIPVERBA) IS NULL))
)

AND ((CAB.AD_REGIAO IN :P_REGIAO) OR TRIM(CAB.AD_REGIAO) IS NULL)
AND ((CAB.AD_CODVENDRTV IN :P_CODVENDRTV) OR TRIM(CAB.AD_CODVENDRTV) IS NULL)
AND ((VGF.CODNAT IN :P_CODNAT) OR TRIM(VGF.CODNAT) IS NULL)

)
)
GROUP BY
ANO,
MES,
MES_ANO,
ANO_SAFRA

UNION ALL 

SELECT
TO_CHAR(DTREF,'YYYY') AS ANO,
TO_CHAR(DTREF,'MM') AS MES,
TO_CHAR(DTREF,'MM-YYYY') AS MES_ANO,
ANO_SAFRA,
SUM(PREVDESP) AS VLRPREV,
0 AS VLRREAL,
0 AS VLRCOMPROMETIDO
FROM
(
SELECT
MET.CODMETA,
MET.DTREF,
F_ANO_SAFRA(MET.DTREF) AS ANO_SAFRA,
MET.CODPROJ,
MET.PREVDESP
FROM TGFMET MET
WHERE 
MET.CODMETA = 10
AND SUBSTR(MET.CODPROJ, 1, 1) = '8'
AND F_ANO_SAFRA(MET.DTREF) = :P_ANO_SAFRA
)
GROUP BY
TO_CHAR(DTREF,'YYYY'),
TO_CHAR(DTREF,'MM'),
TO_CHAR(DTREF,'MM-YYYY'),
ANO_SAFRA
)
GROUP BY ANO,MES,MES_ANO,ANO_SAFRA
)



------------------------------------------------------------------------------------------------------
arrumar grafico Real. + Compro. x Budget por PILAR

atualizar os filtros....ok
incluir nome da atividade COD PILAR E DESCRIÇÃO DO PILAR ...ok

F_NIVEL2_DESC(CODPROJ)
F_IDENTIFICACAO(F_NIVEL2_DESC(CODPROJ))


---------------------------------------------------------------------------------
ARRUMAR GRAFICO Saldo Budget por Projeto (Top 10)

atualizar os filtros....ok
CORRECAO DO CALCULO DO SALDO 
E ORDENACAO DO SALDO POR ORDEM DECRESCENTE

-----------------------------------------------------------------------------------
para os graficos abaixo foi efetuada o filtro

Participação por Tipo Verba
Participação por PilaR
Participação por Projeto (Top 10)
Real. + Compro. x Budget por PILAR
Valores Investidos Por RTV (Top 10)
Valores Investidos Por Linha de Produto

-----------------------------------------------------------------------------------
no grafico Valores Investidos Por RTV (Top 10)
foi atualizado a descricao para o codigo do pilar