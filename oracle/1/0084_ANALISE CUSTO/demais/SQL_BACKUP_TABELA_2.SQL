SELECT

CODVEND,

CODNAT,

DESCRNAT,

VLRDESP,

CASE WHEN VLRDESP = 0 OR VLRREAL = 0 THEN 0 ELSE ((VLRDESP/VLRREAL)*-1)*100 END AS PERC_NAT_NO_REAL



FROM

(

WITH CUS4 AS



(

SELECT

AD_VENDEDOR_RESP,CODNAT,DESCRNAT,SUM(VLRDESP) AS VLRDESP

FROM

(

SELECT 

NVL(CUS1.AD_VENDEDOR_RESP,0) AS AD_VENDEDOR_RESP

,CUS1.CODCENCUS

,CASE WHEN CUS1.GRAU=2 THEN CUS1.GRAU || '___' || CUS1.DESCRCENCUS

WHEN CUS1.GRAU=3 THEN CUS1.GRAU || '_____' || CUS1.DESCRCENCUS

WHEN CUS1.GRAU=4 THEN CUS1.GRAU || '_______' || CUS1.DESCRCENCUS

WHEN CUS1.GRAU=5 THEN CUS1.GRAU || '_________' || CUS1.DESCRCENCUS

ELSE CUS1.GRAU||'_'||CUS1.DESCRCENCUS END AS DESCRCENCUS

,CUS1.GRAU

,CUS1.ANALITICO

,X.CODNAT

,X.DESCRNAT

,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_REC

,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRDESDOB ELSE 0 END),0) AS VLRDESDOB_DESP

,NVL(SUM(X.VLRDESDOB),0) AS VLRDESDOB

,NVL(SUM(X.VLRJURO),0) AS VLRJURO

,NVL(SUM(X.VLRMULTA),0) AS VLRMULTA

,NVL(SUM(X.VLRDESC),0) AS VLRDESC

,NVL(SUM(CASE WHEN X.RECDESP = 1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_REC

,NVL(SUM(CASE WHEN X.RECDESP = -1 THEN X.VLRBAIXA ELSE 0 END),0) AS VLRBAIXA_DESP

,NVL(SUM(X.VLRBAIXA),0) AS VLRBAIXA

,NVL(SUM(CASE WHEN X.CODNAT = 1010000 AND X.RECDESP = 1 THEN X.VLRDESDOB 

		WHEN X.CODNAT <> 1010000 AND X.RECDESP = 1 THEN X.VLRBAIXA 

		ELSE 0 END),0) AS VLRREC

,NVL(SUM(CASE WHEN X.CODNAT = 2020202 AND X.RECDESP IN (-1,0) THEN X.VLRDESDOB 

		WHEN X.CODNAT <> 2020202 AND X.RECDESP IN (-1) THEN X.VLRBAIXA 

		ELSE 0 END),0) AS VLRDESP

FROM TSICUS CUS1

LEFT JOIN VGF_RESULTADO2_SATIS X ON X.CODCENCUS=CUS1.CODCENCUS

INNER JOIN TGFNAT NAT ON X.CODNAT = NAT.CODNAT



WHERE



((

        (X.CODCENCUS NOT LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'S' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

    OR

    (X.CODCENCUS LIKE '6%' AND X.RECDESP <> 1 AND X.CODNAT = 2020202 AND X.PROVISAO = 'N' AND (X.DTNEG BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

    OR

    (X.RECDESP NOT IN (1, 0) AND X.CODNAT NOT IN (2020202, 1010000) AND PROVISAO = 'N' AND (X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

)

OR

( (

    X.RECDESP IN (1,0,-1)

    AND X.PROVISAO = 'N' 

    AND X.CODNAT <> 2020202

    AND X.NUNOTA IN (

        SELECT NUNOTA 

        FROM TGFCAB CAB

        INNER JOIN TGFTOP TOP ON (CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER)

        WHERE

            TOP.ATUALEST <> 'N'

            AND CAB.TIPMOV IN ('V','D')

            AND CAB.STATUSNOTA='L'

            AND (CAB.STATUSNFE IN ('A', 'T', 'S') OR CAB.STATUSNFE IS NULL)

            AND ((TOP.ATUALFIN<>0 AND TOP.TIPATUALFIN='I' ) OR (TOP.CODTIPOPER IN (1112,1113)  ) )

		  AND (CAB.DTMOV BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN))

  )

OR

    X.RECDESP IN (1)

    AND X.PROVISAO = 'N' 

    AND X.CODNAT <> 1010000

    AND(X.DHBAIXA BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN)

))

AND X.CODNAT NOT IN (1010000,1020000,6010100,6010200)



/*

AND X.CODCENCUS IN :CR AND X.CODCENCUS <> 0 AND (X.RECDESP=:P_RECDESP OR :P_RECDESP = 0)

AND (X.CODCENCUS >= :P_CRINI OR :P_CRINI IS NULL)

AND (X.CODCENCUS < :P_CRFIN OR :P_CRFIN IS NULL)

AND (X.CODNAT <> :NATDIF OR :NATDIF IS NULL)

AND ( (X.CODNAT IN (SELECT CODNAT FROM TGFNAT WHERE AD_CUSTOFIXO = 'S') AND :P_CUSFIXO='S') OR :P_CUSFIXO='N' )

*/





GROUP BY

NVL(CUS1.AD_VENDEDOR_RESP,0)

,CUS1.CODCENCUS

,CUS1.DESCRCENCUS

,CUS1.GRAU

,CUS1.ANALITICO

,X.CODNAT

,X.DESCRNAT

)



GROUP BY AD_VENDEDOR_RESP,CODNAT,DESCRNAT

)



SELECT 

A.CODVEND

, APELIDO

, CUS4.CODNAT

, CUS4.DESCRNAT

, SUM(QTDPREV) AS QTDPREV

, SUM(QTDREAL) AS QTDREAL

, CASE WHEN SUM(QTDPREV) = 0 THEN 100 ELSE SUM(QTDREAL) * 100 / NULLIF(SUM(QTDPREV), 0) END AS PERC

, SUM(QTDPREV * PRECOLT)  AS VLR_PREV

, SUM(VLRREAL) AS VLRREAL

, CASE WHEN SUM(QTDPREV * PRECOLT) = 0 THEN 100 ELSE NVL(SUM(VLRREAL) * 100 / NULLIF(SUM(QTDPREV * PRECOLT), 0), 0) END AS PERC_VLR

, NVL(CUS4.VLRDESP,0) AS VLRDESP

FROM

(

SELECT MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA, NVL(VGF.CODCENCUS,0) AS CODCENCUS,NVL(MET.QTDPREV,0) AS QTDPREV, 

SUM(NVL(VGF.QTD,0)) AS QTDREAL,NVL(PRC.VLRVENDALT,0)AS PRECOLT, SUM(NVL(VGF.VLR,0)) AS VLRREAL

FROM TGFMET MET

LEFT JOIN VGF_VENDAS_SATIS VGF ON MET.DTREF = TRUNC(VGF.DTMOV,'MM') AND MET.CODVEND = VGF.CODVEND AND MET.CODPARC = VGF.CODPARC AND MET.MARCA = VGF.MARCA AND VGF.BONIFICACAO = 'N'

LEFT JOIN AD_PRECOMARCA PRC ON (MET.MARCA = PRC.MARCA AND PRC.CODMETA = MET.CODMETA AND PRC.DTREF = (SELECT MAX(DTREF) FROM AD_PRECOMARCA WHERE CODMETA = MET.CODMETA AND DTREF <= MET.DTREF AND MARCA = MET.MARCA))

WHERE MET.CODMETA = :P_CODMETA

AND MET.DTREF BETWEEN :P_PERIODO.INI AND :P_PERIODO.FIN



AND ((:P_NTEMMETA = 'S' AND (MET.QTDPREV <> 0 OR MET.QTDREAL <> 0)) OR :P_NTEMMETA = 'N')

AND (VGF.CODGRUPOPROD = :P_GRUPOPROD OR :P_GRUPOPROD IS NULL)



GROUP BY MET.DTREF, MET.CODVEND, MET.CODPARC, MET.MARCA,NVL(VGF.CODCENCUS,0), NVL(MET.QTDPREV,0), NVL(PRC.VLRVENDALT,0)







)A

INNER JOIN TGFVEN VEN ON A.CODVEND = VEN.CODVEND

INNER JOIN TGFPAR PAR ON A.CODPARC = PAR.CODPARC

LEFT JOIN CUS4 ON A.CODVEND = CUS4.AD_VENDEDOR_RESP

WHERE

(VEN.CODVEND IN :P_CODVEND)

AND (VEN.CODGER IN :P_COORD)

AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)

AND (A.MARCA IN :P_MARCA)





GROUP BY A.CODVEND, APELIDO,CUS4.CODNAT,CUS4.DESCRNAT,NVL(CUS4.VLRDESP,0)

)

WHERE 

CODVEND <> 0 

AND CODVEND = :A_CODVEND

AND CODNAT NOT IN (1020000,6010100)

AND
(
	/*CODVEND = (SELECT CODVEND FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) 
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.CODGER AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR CODVEND IN (SELECT VEN.CODVEND FROM TGFVEN VEN, TSIUSU USU WHERE USU.CODVEND = VEN.AD_COORDENADOR AND USU.CODUSU = STP_GET_CODUSULOGADO)
	OR */(SELECT AD_GESTOR_META FROM TSIUSU WHERE CODUSU = STP_GET_CODUSULOGADO) = 'S' 
)

GROUP BY CODVEND,CODNAT,DESCRNAT,VLRREAL,VLRDESP

ORDER BY 2
