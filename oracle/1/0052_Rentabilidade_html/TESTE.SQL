
SELECT
CAB.CODEMP,
EMP.NOMEFANTASIA,
CAB.NUNOTA,
CAB.NUMNOTA,
VEN.CODVEND||'-'||VEN.APELIDO AS VENDEDOR,
VENS.CODVEND||'-'||VENS.APELIDO AS SUPERVISOR,
VENG.CODVEND||'-'||VENG.APELIDO AS GERENTE,
(SUM(ITE.VLRTOT - ITE.VLRDESC - ITE.VLRICMS)
	- NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND CODIMP = 6),0)
	- NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND CODIMP = 7),0)
	- SUM(NVL(CUS.CUSSEMICM,0) * ITE.QTDNEG)
) * (CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END) AS MARGEMNON,
CAB.CODPARC,
PAR.NOMEPARC,
PARM.CODPARC AS CODPARCMATRIZ,
PARM.NOMEPARC AS NOMEPARCMATRIZ,
CAB.CODTIPOPER,
TOP.DESCROPER,
CAB.DTFATUR,
CAB.DTMOV,
CAB.DTENTSAI,
CAB.DTNEG,
F_DESCROPC('TGFCAB','STATUSNOTA',CAB.STATUSNOTA) AS STATUSNOTA,
CAB.CODTIPVENDA,
TPV.DESCRTIPVENDA,
CAB.CODVEND,
VEN.APELIDO,
CAB.CODNAT,
NAT.DESCRNAT,
CAB.CODCENCUS,
CUS.DESCRCENCUS,
CAB.ORDEMCARGA,
CAB.TIPMOV
FROM TGFCAB CAB
INNER JOIN TGFPAR PAR ON CAB.CODPARC = PAR.CODPARC
INNER JOIN TSIEMP EMP ON CAB.CODEMP = EMP.CODEMP
INNER JOIN TGFNAT NAT ON CAB.CODNAT = NAT.CODNAT
INNER JOIN TSICUS CUS ON CAB.CODCENCUS = CUS.CODCENCUS
INNER JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER AND TOP.DHALTER = (SELECT MAX(DHALTER) FROM TGFTOP WHERE CODTIPOPER = CAB.CODTIPOPER)
INNER JOIN TGFTPV TPV ON CAB.CODTIPVENDA = TPV.CODTIPVENDA AND TPV.DHALTER = CAB.DHTIPVENDA
INNER JOIN TGFVEN VEN ON CAB.CODVEND = VEN.CODVEND
LEFT JOIN TGFVEN VENS ON VENS.CODVEND = VEN.AD_SUPERVISOR
LEFT JOIN TGFVEN VENG ON VENG.CODVEND = VEN.CODGER
INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
LEFT JOIN TGFCUS CUS ON CUS.CODPROD = ITE.CODPROD AND CUS.CODEMP = CAB.CODEMP AND CUS.DTATUAL = (SELECT MAX(C.DTATUAL) FROM TGFCUS C WHERE C.CODEMP = CAB.CODEMP AND C.CODPROD = ITE.CODPROD AND C.DTATUAL <= CAB.DTNEG)
LEFT JOIN TGFPAR PARM ON PARM.CODPARC = PAR.CODPARCMATRIZ
WHERE TOP.GOLSINAL = -1
AND (CAB.DTNEG BETWEEN '01-07-2024' AND '02-07-2024' --:P_PERIODO.INI AND  :P_PERIODO.FIN)
--AND (CAB.CODEMP IN :P_EMPRESA)
AND TOP.TIPMOV IN ('V', 'D')
AND TOP.ATIVO = 'S'
--AND (CAB.CODNAT = :P_CODNAT OR :P_CODNAT IS NULL)
GROUP BY
CAB.CODEMP,
EMP.NOMEFANTASIA,
CAB.NUNOTA,
CAB.NUMNOTA,
VEN.CODVEND, 
VEN.APELIDO,
VENS.CODVEND, 
VENS.APELIDO,
VENG.CODVEND, 
VENG.APELIDO,
--CAB.VLRNOTA,

PARM.CODPARC,
PARM.NOMEPARC,
CAB.CODPARC,
PAR.NOMEPARC,

CAB.CODTIPOPER,
TOP.DESCROPER,
CAB.DTFATUR,
CAB.DTMOV,
CAB.DTENTSAI,
CAB.DTNEG,
CAB.STATUSNOTA,
CAB.CODTIPVENDA,
TPV.DESCRTIPVENDA,
CAB.CODVEND,
VEN.APELIDO,
CAB.CODNAT,
NAT.DESCRNAT,
CAB.CODCENCUS,
CUS.DESCRCENCUS,
CAB.ORDEMCARGA,
CAB.TIPMOV