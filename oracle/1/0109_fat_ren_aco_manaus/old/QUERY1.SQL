
WITH
DOS AS ( /*DESPESA OPERACIONA*/
select 
1 AS COD,
sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRDO,
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRDO_MA,
case 
when sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) = 0 then null
else round(((sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) - 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)) * 100.0 / 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO <> 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)), 2)
end as VAR_VLRDO
FROM TGFFIN FIN
INNER JOIN TGFNAT NAT ON FIN.CODNAT = NAT.CODNAT
WHERE 
FIN.RECDESP = -1 
AND NAT.ATIVA = 'S'
AND FIN.DHBAIXA IS NOT NULL AND FIN.CODEMP IN (1,11,2,3)
),
INV AS ( /*INVESTIMENTO*/
select 
1 AS COD,
sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRINV,
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) as VLRINV_MA,
case 
when sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) = 0 then null
else round(((sum(case when dhbaixa between '01/08/2025' and '31/08/2025' then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end) - 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)) * 100.0 / 
sum(case when dhbaixa between DATEADD(month, -1, '01/08/2025') 
and DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) then 
case when NAT.AD_TIPOCUSTO = 'N' then 
ISNULL(ROUND(VLRBAIXA, 2), 0) 
else 0 end 
else 0 end)), 2)
end as VAR_VLRINV
FROM TGFFIN FIN
INNER JOIN TGFNAT NAT ON FIN.CODNAT = NAT.CODNAT
WHERE 
FIN.RECDESP = -1 
AND NAT.ATIVA = 'S'
AND FIN.DHBAIXA IS NOT NULL AND FIN.CODEMP IN (1,11,2,3)
),
BAS_MA AS (
SELECT 
1 AS COD,
SUM(TOTALLIQ) VLRFAT_MA,
SUM(VLRDEV) VLRDEVOL_MA,
SUM(VLRIPI+VLRSUBST+VLRICMS+VLRPIS+VLRCOFINS) VLRIMP_MA,
SUM(CUSREP_TOT) VLRCMV_MA,
SUM(TON) TON_MA,
SUM(VLRDESC) VLRDESC_MA,
SUM(MARGEMNON) VLRMCN_MA,
AVG(PERCMARGEM) VLRMCD_MA
FROM vw_rentabilidade_aco
WHERE 
DTNEG BETWEEN DATEADD(month, -1, '01/08/2025') AND DATEADD(day, 30, DATEADD(month, -1, '01/08/2025')) 
and tipmov in ('V', 'D') and ATIVO_TOP = 'S' and AD_COMPOE_FAT = 'S'
AND CODEMP IN (1,11,2,3)
),
BAS AS (
SELECT 
1 AS COD,
SUM(TOTALLIQ) VLRFAT,
SUM(VLRDEV) VLRDEVOL,
SUM(VLRIPI+VLRSUBST+VLRICMS+VLRPIS+VLRCOFINS) VLRIMP,
SUM(CUSREP_TOT) VLRCMV,
SUM(TON) TON,
SUM(VLRDESC) VLRDESC,
SUM(MARGEMNON) VLRMCN,
AVG(PERCMARGEM) VLRMCD
FROM vw_rentabilidade_aco
WHERE
DTNEG BETWEEN '01/08/2025' AND  '31/08/2025'
and tipmov in ('V', 'D') and ATIVO_TOP = 'S' and AD_COMPOE_FAT = 'S'
AND CODEMP IN (1,11,2,3)
)
SELECT 
FORMAT(ROUND(BAS.VLRFAT, 2), 'N2') AS VLRFAT,
FORMAT(ROUND(BAS_MA.VLRFAT_MA, 2), 'N2') AS VLRFAT_MA,

FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRFAT - BAS_MA.VLRFAT_MA) / NULLIF(BAS_MA.VLRFAT_MA,0)) * 100,2),0), 2), 'N2') AS VAR_VLRFAT,
FORMAT(ROUND(BAS.VLRDEVOL, 2), 'N2') AS VLRDEVOL,
FORMAT(ROUND(BAS_MA.VLRDEVOL_MA, 2), 'N2') AS VLRDEVOL_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRDEVOL - BAS_MA.VLRDEVOL_MA) / NULLIF(BAS_MA.VLRDEVOL_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRDEVOL,
FORMAT(ROUND(BAS.VLRIMP, 2), 'N2') AS VLRIMP,
FORMAT(ROUND(BAS_MA.VLRIMP_MA, 2), 'N2') AS VLRIMP_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRIMP - BAS_MA.VLRIMP_MA) / NULLIF(BAS_MA.VLRIMP_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRIMP,
FORMAT(ROUND(BAS.VLRCMV, 2), 'N2') AS VLRCMV,
FORMAT(ROUND(BAS_MA.VLRCMV_MA, 2), 'N2') AS VLRCMV_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRCMV - BAS_MA.VLRCMV_MA) / NULLIF(BAS_MA.VLRCMV_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRCMV,
FORMAT(ROUND(BAS.VLRDESC, 2), 'N2') AS VLRDESC,
FORMAT(ROUND(BAS_MA.VLRDESC_MA, 2), 'N2') AS VLRDESC_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRDESC - BAS_MA.VLRDESC_MA) / NULLIF(BAS_MA.VLRDESC_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRDESC,
FORMAT(ROUND(BAS.VLRMCN, 2), 'N2') AS VLRMCN,
FORMAT(ROUND(BAS_MA.VLRMCN_MA, 2), 'N2') AS VLRMCN_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRMCN - BAS_MA.VLRMCN_MA) / NULLIF(BAS_MA.VLRMCN_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRMCN,
FORMAT(ROUND(BAS.VLRMCD, 2), 'N2') AS VLRMCD,
FORMAT(ROUND(BAS_MA.VLRMCD_MA, 2), 'N2') AS VLRMCD_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRMCD - BAS_MA.VLRMCD_MA) / NULLIF(BAS_MA.VLRMCD_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRMCD,
FORMAT(ROUND(BAS.TON, 2), 'N2') AS TON,
FORMAT(ROUND(BAS_MA.TON_MA, 2), 'N2') AS TON_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.TON - BAS_MA.TON_MA) / NULLIF(BAS_MA.TON_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_TON,
FORMAT(ROUND(DOS.VLRDO, 2), 'N2') AS VLRDO,
FORMAT(ROUND(DOS.VLRDO_MA, 2), 'N2') AS VLRDO_MA,
FORMAT(ROUND(ISNULL(ROUND(((DOS.VLRDO - DOS.VLRDO_MA) / NULLIF(DOS.VLRDO_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRDO,
FORMAT(ROUND(INV.VLRINV, 2), 'N2') AS VLRINV,
FORMAT(ROUND(INV.VLRINV_MA, 2), 'N2') AS VLRINV_MA,
FORMAT(ROUND(ISNULL(ROUND(((INV.VLRINV - INV.VLRINV_MA) / NULLIF(INV.VLRINV_MA, 0)) * 100, 2), 0), 2), 'N2') AS VAR_VLRINV,
FORMAT(ROUND(BAS.VLRFAT-DOS.VLRDO-INV.VLRINV, 2), 'N2') AS VLRRES,
FORMAT(ROUND(BAS_MA.VLRFAT_MA-DOS.VLRDO_MA-INV.VLRINV_MA, 2), 'N2') AS VLRRES_MA,
FORMAT(ROUND(ISNULL(ROUND(((BAS.VLRFAT-DOS.VLRDO-INV.VLRINV) - (BAS_MA.VLRFAT_MA-DOS.VLRDO_MA-INV.VLRINV_MA)) / NULLIF((BAS_MA.VLRFAT_MA-DOS.VLRDO_MA-INV.VLRINV_MA), 0) * 100, 2), 0), 2), 'N2') AS VAR_VLRRES

FROM BAS
INNER JOIN BAS_MA ON BAS.COD = BAS_MA.COD
INNER JOIN DOS ON BAS.COD = DOS.COD
INNER JOIN INV ON BAS.COD = INV.COD