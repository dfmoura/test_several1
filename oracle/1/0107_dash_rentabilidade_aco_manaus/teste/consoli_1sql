SELECT
  CAB.NUNOTA, ITE.SEQUENCIA, CAB.CODEMP, EMP.NOMEFANTASIA EMPRESA,
  CAB.TIPMOV, TOP.AD_COMPOE_FAT, CAB.DTNEG, TOP.ATIVO,
  CAB.CODNAT, CAB.CODCENCUS, CAB.CODVEND,
  DECODE(NVL(CAB.CODVEND, 0), 0, 'SEM INFORMACAO', VEN.APELIDO) AS VENDEDOR,
  NVL(VEN.AD_SUPERVISOR, 0) AS AD_SUPERVISOR,
  DECODE(NVL(VEN.AD_SUPERVISOR, 0), 0, 'SEM INFORMACAO', VENS.APELIDO) AS SUPERVISOR,
  NVL(VEN.CODGER, 0) AS CODGER,
  DECODE(NVL(VEN.CODGER, 0), 0, 'SEM INFORMACAO', VENG.APELIDO) AS GERENTE,
  VEN.AD_ROTA, CAB.CODPARC, PAR.NOMEPARC, PAR.CODTIPPARC,
  UPPER(DECODE(TPP.DESCRTIPPARC, '<SEM TIPO PARCEIRO>', 'SEM INFORMACAO', DESCRTIPPARC)) AS DESCRTIPPARC,
  PAR.CODCID, UPPER(CID.NOMECID) AS NOMECID, PAR.CODBAI, BAI.NOMEBAI,
  CAB.CODTIPOPER, TOP.DESCROPER, PRO.AD_TPPROD,
  F_DESCROPC('TGFPRO', 'AD_TPPROD', PRO.AD_TPPROD) AS TIPOPROD,
  ITE.CODPROD, PRO.DESCRPROD, ITE.VLRUNIT,
  SUM(ITE.QTDNEG) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS QTDNEG,
  SUM(ITE.VLRDESC) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS VLRDESC,
  SUM(CASE WHEN CAB.TIPMOV = 'D' THEN (ITE.VLRTOT + ITE.VLRIPI + ITE.VLRSUBST - ITE.VLRDESC) * -1 ELSE 0 END) AS VLRDEV,
  SUM(CASE WHEN CAB.TIPMOV = 'D' THEN (ITE.VLRTOT + ITE.VLRIPI + ITE.VLRSUBST - ITE.VLRDESC) * -1 ELSE (ITE.VLRTOT + ITE.VLRIPI + ITE.VLRSUBST - ITE.VLRDESC) END) AS TOTALLIQ,
  SUM(ITE.VLRIPI) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS VLRIPI,
  SUM(ITE.VLRSUBST) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS VLRSUBST,
  SUM(ITE.VLRICMS) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS VLRICMS,
  NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND SEQUENCIA = ITE.SEQUENCIA AND CODIMP = 6), 0) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS VLRPIS,
  NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND SEQUENCIA = ITE.SEQUENCIA AND CODIMP = 7), 0) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS VLRCOFINS,
  SUM(FC_QTDALT_HL(ITE.CODPROD, ITE.QTDNEG, 'HL') * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END) AS HL,
  SUM(NVL(CUS.CUSSEMICM, 0) * ITE.QTDNEG) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS CUSMEDSICM_TOT,
  (SUM(ITE.VLRTOT - ITE.VLRDESC - ITE.VLRICMS)
   - NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND SEQUENCIA = ITE.SEQUENCIA AND CODIMP = 6), 0)
   - NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND SEQUENCIA = ITE.SEQUENCIA AND CODIMP = 7), 0)
   - SUM(NVL(CUS.CUSSEMICM, 0) * ITE.QTDNEG)) * CASE WHEN CAB.TIPMOV = 'D' THEN -1 ELSE 1 END AS MARGEMNON,
  ((SUM(ITE.VLRTOT - ITE.VLRDESC - ITE.VLRICMS)
   - NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND SEQUENCIA = ITE.SEQUENCIA AND CODIMP = 6), 0)
   - NVL((SELECT SUM(VALOR) FROM TGFDIN WHERE NUNOTA = CAB.NUNOTA AND SEQUENCIA = ITE.SEQUENCIA AND CODIMP = 7), 0)
   - SUM(NVL(CUS.CUSSEMICM, 0) * ITE.QTDNEG))
   * 100 / NULLIF(SUM(ITE.VLRTOT + ITE.VLRIPI + ITE.VLRSUBST - ITE.VLRDESC), 0)) AS PERCMARGEM

FROM TGFCAB CAB
JOIN TGFPAR PAR ON CAB.CODPARC = PAR.CODPARC
JOIN TSICID CID ON PAR.CODCID = CID.CODCID
JOIN TSIBAI BAI ON PAR.CODBAI = BAI.CODBAI
JOIN TSIEMP EMP ON CAB.CODEMP = EMP.CODEMP
JOIN TGFNAT NAT ON CAB.CODNAT = NAT.CODNAT
JOIN TSICUS CUS ON CAB.CODCENCUS = CUS.CODCENCUS
JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER
JOIN TGFTPV TPV ON CAB.CODTIPVENDA = TPV.CODTIPVENDA AND TPV.DHALTER = CAB.DHTIPVENDA
JOIN TGFVEN VEN ON CAB.CODVEND = VEN.CODVEND
LEFT JOIN TGFVEN VENS ON VENS.CODVEND = VEN.AD_SUPERVISOR
LEFT JOIN TGFVEN VENG ON VENG.CODVEND = VEN.CODGER
JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
LEFT JOIN TGFPRO PRO ON ITE.CODPROD = PRO.CODPROD
LEFT JOIN TGFCUS CUS ON CUS.CODPROD = ITE.CODPROD AND CUS.CODEMP = CAB.CODEMP
LEFT JOIN TGFPAR PARM ON PARM.CODPARC = PAR.CODPARCMATRIZ
LEFT JOIN TGFTPP TPP ON PAR.CODTIPPARC = TPP.CODTIPPARC

WHERE TOP.DHALTER = (
  SELECT MAX(DHALTER)
  FROM TGFTOP
  WHERE CODTIPOPER = CAB.CODTIPOPER
)
AND (
  CUS.DTATUAL = (
    SELECT MAX(C.DTATUAL)
    FROM TGFCUS C
    WHERE C.CODEMP = CAB.CODEMP AND C.CODPROD = ITE.CODPROD AND C.DTATUAL <= CAB.DTNEG
  )
  OR (
    SELECT MAX(C.DTATUAL)
    FROM TGFCUS C
    WHERE C.CODEMP = CAB.CODEMP AND C.CODPROD = ITE.CODPROD AND C.DTATUAL <= CAB.DTNEG
  ) IS NULL
)

GROUP BY
  CAB.CODEMP, EMP.NOMEFANTASIA, CAB.TIPMOV, TOP.GOLSINAL, CAB.DTNEG, TOP.ATIVO,
  CAB.CODNAT, CAB.CODCENCUS, CAB.CODVEND,
  DECODE(NVL(CAB.CODVEND, 0), 0, 'SEM INFORMACAO', VEN.APELIDO),
  NVL(VEN.AD_SUPERVISOR, 0),
  DECODE(NVL(VEN.AD_SUPERVISOR, 0), 0, 'SEM INFORMACAO', VENS.APELIDO),
  NVL(VEN.CODGER, 0),
  DECODE(NVL(VEN.CODGER, 0), 0, 'SEM INFORMACAO', VENG.APELIDO),
  VEN.AD_ROTA, CAB.CODPARC, PAR.NOMEPARC, PAR.CODTIPPARC, TPP.DESCRTIPPARC,
  PAR.CODCID, UPPER(CID.NOMECID), PAR.CODBAI, BAI.NOMEBAI,
  CAB.CODTIPOPER, TOP.DESCROPER, CAB.NUNOTA, ITE.SEQUENCIA,
  PRO.AD_TPPROD, ITE.CODPROD, PRO.DESCRPROD, ITE.VLRUNIT;
